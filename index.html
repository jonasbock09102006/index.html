<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kassensystem (Bewirtungsbeleg) - Firebase Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* (aus deinem Original: nur relevante Styles gekürzt/übernommen) */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        #receipt-content-interactive { overflow-y: auto; max-height: 40vh; }
        .product-btn:active { transform: scale(0.98); }
        .numpad-btn { height: 50px; line-height: 1; display:flex; justify-content:center; align-items:center; }
        #async-loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background-color: rgba(255,255,255,0.8); z-index:100; display:none; justify-content:center; align-items:center; }
        .spinner { border:4px solid rgba(0,0,0,0.1); border-top:4px solid #b91c1c; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
        #toast-container{position:fixed;top:1rem;right:1rem;z-index:1000;pointer-events:none;}
        .toast{padding:8px;border-radius:8px;color:#fff;opacity:0;transition:opacity .3s, transform .3s;}
        .toast-success{background:#16a34a;}
        .toast-error{background:#dc2626;}
        .toast-info{background:#2563eb;}
        @media print { body * { visibility:hidden } .receipt-print, .receipt-print * { visibility:visible } .receipt-print { position:absolute; left:0; top:0; width:80mm; font-family:monospace; font-size:9pt; color:#000; } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-4 bg-red-500/10 overflow-x-hidden">

    <!-- Toasts & Loading -->
    <div id="toast-container"></div>
    <div id="async-loading-overlay"><div class="spinner"></div></div>

    <!-- Login Modal -->
    <div id="login-modal" style="display:flex" class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h1 class="text-3xl font-bold text-center text-red-700 mb-2">Kassensystem</h1>
            <p class="text-sm text-center text-gray-500 mb-6">Bitte mit Ihren Zugangsdaten anmelden.</p>
            <form id="login-form" onsubmit="event.preventDefault(); handleLoginSubmit();">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700">E-Mail Adresse</label>
                    <input type="email" id="login-email" required class="mt-1 w-full px-3 py-2 border rounded-lg" />
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Passwort</label>
                    <input type="password" id="login-password" required class="mt-1 w-full px-3 py-2 border rounded-lg" />
                </div>
                <button type="submit" class="w-full p-2 rounded-lg font-bold text-white bg-red-600 hover:bg-red-700">Anmelden</button>
            </form>
            <div class="mt-4 text-center">
                <button onclick="openRegistrationModal()" class="text-sm text-indigo-600 hover:text-indigo-800">Noch kein Konto? Hier registrieren.</button>
                <button onclick="openForgotPasswordModal()" class="block w-full mt-2 text-sm text-red-600 hover:text-red-800">Passwort vergessen?</button>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registration-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-indigo-700 mb-4">Konto erstellen</h2>
            <form id="register-form" onsubmit="event.preventDefault(); handleRegisterSubmit();">
                <div class="mb-4">
                    <label for="register-email" class="block text-sm font-medium text-gray-700">E-Mail</label>
                    <input type="email" id="register-email" required class="mt-1 w-full px-3 py-2 border rounded-lg" />
                </div>
                <div class="mb-6">
                    <label for="register-password" class="block text-sm font-medium text-gray-700">Passwort (min.6)</label>
                    <input type="password" id="register-password" required minlength="6" class="mt-1 w-full px-3 py-2 border rounded-lg" />
                </div>
                <button type="submit" class="w-full p-2 rounded-lg font-bold text-white bg-green-600 hover:bg-green-700">Registrieren</button>
            </form>
            <button onclick="closeModal('registration-modal'); openLoginModal();" class="mt-4 w-full p-1 text-sm text-gray-500">Zurück zum Login</button>
        </div>
    </div>

    <!-- Forgot Password -->
    <div id="forgot-password-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-red-700 mb-4">Passwort zurücksetzen</h2>
            <form id="reset-form" onsubmit="event.preventDefault(); handlePasswordReset();">
                <div class="mb-6">
                    <label for="reset-email" class="block text-sm font-medium text-gray-700">E-Mail Adresse</label>
                    <input type="email" id="reset-email" required class="mt-1 w-full px-3 py-2 border rounded-lg" />
                </div>
                <button type="submit" class="w-full p-2 rounded-lg font-bold text-white bg-red-600 hover:bg-red-700">Link senden</button>
            </form>
            <button onclick="closeModal('forgot-password-modal'); openLoginModal();" class="mt-4 w-full p-1 text-sm text-gray-500">Zurück zum Login</button>
        </div>
    </div>

    <!-- Main Kassen-Content -->
    <div id="kasse-content" style="display:none" class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-3">
            <div id="db-status" class="text-xs font-bold p-1.5 rounded-lg bg-yellow-300 text-gray-800">Datenbankmodul lädt...</div>
            <h1 class="text-2xl font-bold text-red-700">Kassensystem</h1>
            <div class="flex flex-col items-end">
                <div id="auth-info" class="text-xs text-gray-500">Kasse v5.7 (Firebase)</div>
                <button onclick="handleLogout()" class="mt-1 px-3 py-1 text-xs font-bold text-white bg-red-500 rounded-lg">Logout</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Left column: Menge, Aktionen -->
            <div class="lg:col-span-1 space-y-3">
                <div class="bg-white p-3 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-indigo-800 mb-2">Menge</h2>
                    <div id="quantity-display" class="w-full h-10 flex items-center justify-center text-xl font-extrabold text-red-600 bg-red-100 rounded-xl shadow-inner">1</div>
                    <div id="main-numpad-container" class="grid grid-cols-3 gap-2 mt-3">
                        <button onclick="handleQuantityInput('7')" class="numpad-btn bg-gray-200">7</button>
                        <button onclick="handleQuantityInput('8')" class="numpad-btn bg-gray-200">8</button>
                        <button onclick="handleQuantityInput('9')" class="numpad-btn bg-gray-200">9</button>
                        <button onclick="handleQuantityInput('4')" class="numpad-btn bg-gray-200">4</button>
                        <button onclick="handleQuantityInput('5')" class="numpad-btn bg-gray-200">5</button>
                        <button onclick="handleQuantityInput('6')" class="numpad-btn bg-gray-200">6</button>
                        <button onclick="handleQuantityInput('1')" class="numpad-btn bg-gray-200">1</button>
                        <button onclick="handleQuantityInput('2')" class="numpad-btn bg-gray-200">2</button>
                        <button onclick="handleQuantityInput('3')" class="numpad-btn bg-gray-200">3</button>
                        <button onclick="handleQuantityInput('clear')" class="numpad-btn bg-red-500 text-white">C</button>
                        <button onclick="handleQuantityInput('0')" class="numpad-btn bg-gray-200">0</button>
                        <button onclick="handleQuantityInput('set1')" class="numpad-btn bg-green-500 text-white">1x</button>
                    </div>
                </div>

                <div class="bg-white p-3 rounded-xl shadow-lg flex flex-col gap-2">
                    <button onclick="undoLastAction()" class="product-btn w-full p-2 rounded-lg font-bold text-sm bg-yellow-400">Storno (Letzte)</button>
                    <button onclick="openTransactionReversalModal()" class="product-btn w-full p-2 rounded-lg font-bold text-sm bg-red-700 text-white">Letzte Buchungen stornieren</button>
                    <button onclick="resetBestellung()" class="product-btn w-full p-2 rounded-lg bg-gray-300">Neue Bestellung</button>
                </div>

                <div class="flex flex-col gap-2">
                    <button onclick="openFinalizeModal()" class="product-btn w-full p-3 rounded-xl font-extrabold text-lg text-white bg-green-600">Zur Zahlung</button>
                    <button onclick="openProductModal()" class="product-btn w-full p-3 rounded-xl text-white bg-indigo-600">Produkte verwalten</button>
                    <div class="flex items-center space-x-2 bg-white p-3 rounded-xl border-2 border-blue-200">
                        <label for="report-date" class="text-sm font-bold text-blue-700">Bericht für Tag:</label>
                        <input type="date" id="report-date" class="p-1 border rounded-lg text-sm flex-grow" />
                        <button onclick="setReportDateToday()" class="p-1 rounded-lg text-xs font-bold text-white bg-red-500">Heute</button>
                    </div>
                    <button onclick="runDailyReport('report')" class="product-btn w-full p-3 rounded-xl text-white bg-blue-600">Tagesabschluss (Bericht)</button>
                    <button onclick="runDailyReport('csv')" class="product-btn w-full p-3 rounded-xl bg-gray-300">Tagesabschluss (CSV Export)</button>
                    <button onclick="openSettingsModal()" class="product-btn w-full p-3 rounded-xl bg-yellow-600 text-white">Einstellungen (Belegkopf)</button>
                </div>
            </div>

            <!-- Middle column: Categories & Products -->
            <div class="lg:col-span-1 space-y-3">
                <div class="bg-white p-3 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold mb-2 text-red-800">Produkte buchen</h2>
                    <div id="category-tabs" class="flex space-x-2 overflow-x-auto pb-2 mb-3 border-b"></div>
                    <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-3">
                        <p class="text-gray-500 col-span-full text-center">Produkte werden geladen...</p>
                    </div>
                </div>
            </div>

            <!-- Right column: Receipt -->
            <div id="receipt-column" class="lg:col-span-1 bg-white p-3 rounded-xl shadow-lg sticky top-3">
                <h2 class="text-lg font-semibold mb-2 text-gray-700">Aktueller Bon (Brutto)</h2>
                <div id="receipt-content-interactive" class="bg-gray-50 p-2 rounded-lg text-xs text-gray-700 border min-h-[150px]">
                    <p class="text-center text-sm text-gray-400 p-4">Es wurden noch keine Artikel gebucht.</p>
                </div>
                <div class="mt-3 pt-3 border-t-2 border-red-700">
                    <div id="total-display" class="text-2xl font-extrabold text-right text-red-700">GESAMT: 0.00 €</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 text-indigo-700">Produkt- und Kategorie-Verwaltung</h2>
            <div id="product-modal-content">
                <div class="mb-4 border-b pb-3">
                    <h3 class="text-lg font-semibold mb-2">Neue Kategorie/Produkt anlegen</h3>
                    <div class="flex space-x-2 mb-2">
                        <input type="text" id="new-category-name" placeholder="Name der Kategorie" class="flex-grow p-2 border rounded-lg">
                        <button onclick="addCategory()" class="p-2 bg-indigo-500 text-white rounded-lg">Kategorie hinzufügen</button>
                    </div>
                    <div class="grid grid-cols-5 gap-2 items-end">
                        <input type="text" id="new-product-name" placeholder="Name des Produkts" class="col-span-2 p-2 border rounded-lg">
                        <input type="number" id="new-product-price" placeholder="Preis (€)" step="0.01" class="p-2 border rounded-lg">
                        <select id="new-product-category" class="p-2 border rounded-lg"><option value="">Kategorie wählen</option></select>
                        <button onclick="addProduct()" class="p-2 bg-green-500 text-white rounded-lg">Produkt hinzufügen</button>
                    </div>
                </div>

                <h3 class="text-lg font-semibold mb-2">Bestehende Kategorien</h3>
                <div id="category-list" class="space-y-2 mb-4"></div>

                <h3 class="text-lg font-semibold mb-2">Bestehende Produkte (Preise anpassen)</h3>
                <div id="product-list" class="space-y-2"></div>
            </div>
            <div class="mt-6 text-right">
                <button onclick="closeModal('product-modal')" class="p-2 bg-gray-300 rounded-lg">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Finalize modal (vereinfachte Ansicht) -->
    <div id="finalize-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-3 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-green-700 text-center">Zahlung abschließen</h2>
            <div class="mb-3 p-2 border-2 border-green-500 rounded-lg bg-green-50">
                <p class="text-xs font-bold text-gray-700">Gesamtbetrag:</p>
                <div id="finalize-total" class="text-3xl font-extrabold text-right text-green-700">0.00 €</div>
            </div>
            <div id="payment-buttons" class="grid grid-cols-1 gap-3 mb-4">
                <button onclick="setPaymentMethod('KARTE')" id="btn-karte" class="p-3 rounded-xl font-semibold text-white bg-indigo-600">KARTE ZAHLUNG</button>
            </div>
            <div id="cash-payment-area" class="mt-4 p-3 border rounded-lg bg-gray-50">
                <h3 class="text-lg font-semibold mb-2 flex justify-between items-center text-blue-700">BAR Zahlung (Rückgeld) <span id="btn-bar-indicator" class="text-xs bg-blue-500 text-white px-2 py-1 rounded-full">AKTIV</span></h3>
                <label class="block text-sm font-medium text-gray-700 mb-1">Erhaltener Betrag</label>
                <div id="cash-received-display" class="w-full h-10 flex items-center justify-end px-3 py-2 border rounded-xl text-xl font-extrabold bg-white">0,00</div>
                <div class="mt-3 pt-2 border-t flex justify-between items-center">
                    <span class="text-lg font-bold text-gray-700">Rückgeld:</span>
                    <span id="change-display" class="text-2xl font-extrabold text-green-700">0,00 €</span>
                </div>
                <div id="cash-numpad-container" class="mt-4 grid grid-cols-3 gap-2">
                    <button onclick="handleCashInput('7')" class="numpad-btn bg-gray-200">7</button>
                    <button onclick="handleCashInput('8')" class="numpad-btn bg-gray-200">8</button>
                    <button onclick="handleCashInput('9')" class="numpad-btn bg-gray-200">9</button>
                    <button onclick="handleCashInput('4')" class="numpad-btn bg-gray-200">4</button>
                    <button onclick="handleCashInput('5')" class="numpad-btn bg-gray-200">5</button>
                    <button onclick="handleCashInput('6')" class="numpad-btn bg-gray-200">6</button>
                    <button onclick="handleCashInput('1')" class="numpad-btn bg-gray-200">1</button>
                    <button onclick="handleCashInput('2')" class="numpad-btn bg-gray-200">2</button>
                    <button onclick="handleCashInput('3')" class="numpad-btn bg-gray-200">3</button>
                    <button onclick="handleCashInput('clear')" class="numpad-btn bg-red-500 text-white">C</button>
                    <button onclick="handleCashInput('0')" class="numpad-btn bg-gray-200">0</button>
                    <button onclick="handleCashInput('dot')" class="numpad-btn bg-gray-200">,</button>
                </div>
                <div class="mt-3 grid grid-cols-3 gap-2">
                    <button onclick="setCashExact()" class="product-btn h-10 bg-blue-500 text-white">Exakt</button>
                    <button onclick="addCashShortcut(5)" class="product-btn h-10 bg-blue-500 text-white">+5 €</button>
                    <button onclick="addCashShortcut(10)" class="product-btn h-10 bg-blue-500 text-white">+10 €</button>
                </div>
            </div>

            <div id="finalize-button-container" class="mt-4">
                <div id="cash-finalize-buttons" style="display:block">
                    <p class="text-sm text-center text-gray-500 mb-2 font-semibold">Transaktion abschließen:</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="handleFinalizeAction('BAR','none')" disabled id="btn-cash-none" class="p-3 rounded-xl text-white bg-red-400">Ohne Beleg</button>
                        <button onclick="handleFinalizeAction('BAR','standard')" disabled id="btn-cash-standard" class="p-3 rounded-xl text-white bg-green-400">Standard Bon</button>
                        <button onclick="handleFinalizeAction('BAR','bewirtung')" disabled id="btn-cash-bewirtung" class="p-3 rounded-xl text-white bg-red-600/70">Bewirtungsbeleg</button>
                    </div>
                </div>

                <div id="card-finalize-buttons" style="display:none">
                    <p class="text-lg font-bold text-center text-indigo-700 mb-3">Belegoptionen:</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="handleFinalizeAction('KARTE','none')" class="p-3 rounded-xl text-white bg-gray-500">NEIN (Abschließen)</button>
                        <button onclick="handleFinalizeAction('KARTE','standard')" class="p-3 rounded-xl text-white bg-green-600">Standard Bon</button>
                        <button onclick="handleFinalizeAction('KARTE','bewirtung')" class="p-3 rounded-xl text-white bg-red-700">Bewirtungsbeleg</button>
                    </div>
                </div>
            </div>

            <div class="text-center mt-6">
                <button onclick="closeModal('finalize-modal')" class="p-2 bg-gray-300 rounded-lg w-full">Abbrechen / Zurück</button>
            </div>
        </div>
    </div>

    <!-- Transaction reversal modal -->
    <div id="transaction-reversal-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 text-red-700">Letzte Transaktionen stornieren</h2>
            <div id="transaction-list" class="space-y-3 mb-4"></div>
            <div class="text-right">
                <button onclick="closeModal('transaction-reversal-modal')" class="p-2 bg-gray-300 rounded-lg">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Settings modal -->
    <div id="settings-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-xl font-bold mb-4 text-yellow-700">Einstellungen (Belegkopf)</h2>
            <form id="settings-form">
                <div class="mb-4">
                    <label for="company-name" class="block text-sm font-medium text-gray-700">Firmenname</label>
                    <input type="text" id="company-name" class="mt-1 w-full p-2 border rounded-lg">
                </div>
                <div class="mb-4">
                    <label for="address" class="block text-sm font-medium text-gray-700">Adresse</label>
                    <input type="text" id="address" class="mt-1 w-full p-2 border rounded-lg">
                </div>
                <div class="mb-4">
                    <label for="tax-id" class="block text-sm font-medium text-gray-700">Steuernummer/USt-IdNr.</label>
                    <input type="text" id="tax-id" class="mt-1 w-full p-2 border rounded-lg">
                </div>
                <div class="mb-6">
                    <label for="tax-rate" class="block text-sm font-medium text-gray-700">Standard Steuersatz (%)</label>
                    <input type="number" id="tax-rate" step="0.1" class="mt-1 w-full p-2 border rounded-lg">
                </div>
                <button type="button" onclick="saveSettings()" class="w-full p-3 rounded-lg font-bold text-white bg-red-600">Einstellungen speichern</button>
            </form>
            <div class="mt-4 text-right"><button onclick="closeModal('settings-modal')" class="p-2 bg-gray-300 rounded-lg">Schließen</button></div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h2 id="info-title" class="text-xl font-bold mb-4 text-blue-700">Information</h2>
            <pre id="info-text" class="whitespace-pre-wrap font-mono text-sm bg-gray-100 p-3 rounded-lg overflow-x-auto"></pre>
            <div class="mt-6 text-right"><button onclick="closeModal('info-modal')" class="p-2 bg-gray-300 rounded-lg">Schließen</button></div>
        </div>
    </div>

    <!-- Main application script (Firebase + App logic) -->
    <script type="module">
    /********************************************************************************
     * Vollständig integriertes Script:
     * - Import Firebase SDK modules
     * - Initialisierung
     * - Auth (login/register/reset/logout) + Realtime DB für products/categories/transactions
     * - Bindet sich in die UI-Funktionen (wie in deinem ursprünglichen Code)
     ********************************************************************************/

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import {
        getAuth,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        sendPasswordResetEmail,
        signOut,
        onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import {
        getDatabase,
        ref,
        set,
        get,
        child,
        update,
        push,
        onValue,
        remove
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ---------- Firebase config (aus deiner Datei) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
      authDomain: "kassensystem-85412.firebaseapp.com",
      databaseURL: "https://kassensystem-85412-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kassensystem-85412",
      storageBucket: "kassensystem-85412.firebasestorage.app",
      messagingSenderId: "916536785810",
      appId: "1:916536785810:web:0d0319ef565af65d279f4b",
      measurementId: "G-W5HWYEXWJ5"
    };

    const app = initializeApp(firebaseConfig);
    let analytics;
    try { analytics = getAnalytics(app); } catch(e){ /* analytics may fail in some envs */ }

    const auth = getAuth(app);
    const db = getDatabase(app);

    // Expose for debugging (optional)
    window._firebase = { app, auth, db };

    // ---------- App state ----------
    let DB_STATUS = 'disconnected';
    let currentBestellung = [];
    let currentQuantity = '1';
    let cashReceivedInput = '0';
    let products = {};
    let categories = {};
    let userSettings = {};
    let transactionHistory = []; // local cache of recent transactions
    let lastAction = null;
    let selectedPaymentMethod = null;
    let totalBrutto = 0;

    // ---------- Utility UI helpers ----------
    function showLoading(show) { document.getElementById('async-loading-overlay').style.display = show ? 'flex' : 'none'; }
    function showToast(message, type='info') {
        const container = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = 'toast toast-'+type;
        t.innerText = message;
        if (type==='success') t.classList.add('toast-success');
        if (type==='error') t.classList.add('toast-error');
        if (type==='info') t.classList.add('toast-info');
        container.appendChild(t);
        setTimeout(()=>{ t.style.opacity='1'; t.style.transform='translateY(0)'; }, 50);
        setTimeout(()=>{ t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 3000);
    }
    function closeModal(id){ document.getElementById(id).style.display='none'; toggleReceiptColumn(true); }
    function openLoginModal(){ document.getElementById('login-modal').style.display='flex'; toggleReceiptColumn(false); }
    function openRegistrationModal(){ closeModal('login-modal'); toggleReceiptColumn(false); document.getElementById('registration-modal').style.display='flex'; }
    function openForgotPasswordModal(){ closeModal('login-modal'); toggleReceiptColumn(false); document.getElementById('forgot-password-modal').style.display='flex'; }
    function toggleReceiptColumn(show){ const c = document.getElementById('receipt-column'); if(!c) return; if(show) c.classList.remove('hidden'); else c.classList.add('hidden'); }
    function updateDBStatus(connected){ const s=document.getElementById('db-status'); if(connected) { s.className="text-xs font-bold p-1.5 rounded-lg bg-green-500 text-white"; s.innerText="Datenbank verbunden"; } else { s.className="text-xs font-bold p-1.5 rounded-lg bg-red-500 text-white"; s.innerText="Datenbank getrennt"; } }

    // ---------- Auth functions ----------
    async function handleLoginSubmit() {
        showLoading(true);
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
            // onAuthStateChanged wird view wechseln
            showToast('Erfolgreich angemeldet!', 'success');
        } catch (e) {
            showToast('Login fehlgeschlagen: ' + e.message, 'error');
        }
        showLoading(false);
    }

    async function handleRegisterSubmit() {
        showLoading(true);
        const email = document.getElementById('register-email').value;
        const pass = document.getElementById('register-password').value;
        try {
            await createUserWithEmailAndPassword(auth, email, pass);
            showToast('Registrierung erfolgreich! Bitte melden Sie sich an.', 'success');
            closeModal('registration-modal');
            openLoginModal();
        } catch(e) {
            showToast('Registrierung fehlgeschlagen: ' + e.message, 'error');
        }
        showLoading(false);
    }

    async function handlePasswordReset() {
        const email = document.getElementById('reset-email').value;
        if(!email) return;
        showLoading(true);
        try {
            await sendPasswordResetEmail(auth, email);
            showToast('Reset-Link gesendet!', 'success');
            document.getElementById('reset-email').value='';
            closeModal('forgot-password-modal'); openLoginModal();
        } catch(e) {
            showToast('Fehler: ' + e.message, 'error');
        }
        showLoading(false);
    }

    function handleLogout(){
        signOut(auth).then(()=> {
            resetBestellung();
            updateAppView('login');
            showToast('Erfolgreich abgemeldet.', 'info');
        });
    }

    // ---------- DB helpers ----------
    // Path helpers in Realtime DB:
    const rootRef = ref(db);
    const productsRefPath = 'products';
    const categoriesRefPath = 'categories';
    const transactionsRefPath = 'transactions';
    const settingsRefPath = 'settings';

    async function loadSettings() {
        // read settings from DB -> fallback to localStorage defaults
        try {
            const snap = await get(child(rootRef, settingsRefPath));
            if (snap.exists()) {
                userSettings = snap.val();
            } else {
                userSettings = {
                    companyName: localStorage.getItem('companyName') || "Kassensystem",
                    address: localStorage.getItem('address') || "Hauptstraße 1, 12345 Glühheim",
                    taxId: localStorage.getItem('taxId') || "DE123456789",
                    taxRate: parseFloat(localStorage.getItem('taxRate')) || 19.0
                };
                // write defaults to DB for persistence
                await set(child(rootRef, settingsRefPath), userSettings);
            }
        } catch(e) {
            console.error('loadSettings error', e);
            // fallback to local
            userSettings = {
                companyName: localStorage.getItem('companyName') || "Kassensystem",
                address: localStorage.getItem('address') || "Hauptstraße 1, 12345 Glühheim",
                taxId: localStorage.getItem('taxId') || "DE123456789",
                taxRate: parseFloat(localStorage.getItem('taxRate')) || 19.0
            };
        }
    }

    async function loadProductsAndCategories() {
        try {
            const prodSnap = await get(child(rootRef, productsRefPath));
            const catSnap = await get(child(rootRef, categoriesRefPath));
            products = prodSnap.exists() ? prodSnap.val() : {};
            categories = catSnap.exists() ? catSnap.val() : {};

            // if categories empty, seed defaults
            if (!categories || Object.keys(categories).length===0) {
                categories = {
                    'cat1': { id:'cat1', name:'Getränke' },
                    'cat2': { id:'cat2', name:'Essen' },
                    'cat3': { id:'cat3', name:'Pfand' }
                };
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kassensystem Pro</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-analytics.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import { getDatabase, ref, child, get, set } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
  authDomain: "kassensystem-85412.firebaseapp.com",
  databaseURL: "https://kassensystem-85412-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "kassensystem-85412",
  storageBucket: "kassensystem-85412.appspot.com",
  messagingSenderId: "916536785810",
  appId: "1:916536785810:web:0d0319ef565af65d279f4b",
  measurementId: "G-W5HWYEXWJ5"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getDatabase(app);

let products = {};
let categories = {};
let currentOrder = [];
let transactionHistory = [];
let selectedPaymentMethod = 'BAR';
let discount = 0;

// Toast helper
function showToast(msg,type='info'){
    const toast = document.createElement('div');
    toast.innerText = msg;
    toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded shadow text-white ${type==='error'?'bg-red-600':type==='success'?'bg-green-600':'bg-gray-600'} animate-fade`;
    document.body.appendChild(toast);
    setTimeout(()=>document.body.removeChild(toast),3000);
}

// Auth functions
async function handleLogin(email,password){
    try{
        await signInWithEmailAndPassword(auth,email,password);
        showToast('Login erfolgreich','success');
    } catch(e){ showToast(e.message,'error'); }
}

async function handleLogout(){
    await signOut(auth);
    showToast('Abgemeldet','info');
}

// Load data
async function loadData(){
    const catSnap = await get(child(ref(db), 'categories'));
    const prodSnap = await get(child(ref(db), 'products'));
    categories = catSnap.exists()?catSnap.val():{};
    products = prodSnap.exists()?prodSnap.val():{};
    renderCategories();
    renderProducts();
}

// Render categories
function renderCategories(){
    const container = document.getElementById('category-tabs');
    container.innerHTML = '';
    for(const catId in categories){
        const btn = document.createElement('button');
        btn.innerText = categories[catId].name;
        btn.className = 'px-4 py-2 bg-blue-500 text-white rounded';
        btn.onclick = () => renderProducts(catId);
        container.appendChild(btn);
    }
}

// Render products
function renderProducts(filterCatId=null){
    const grid = document.getElementById('product-grid');
    grid.innerHTML = '';
    for(const prodId in products){
        const prod = products[prodId];
        if(filterCatId && prod.categoryId!==filterCatId) continue;
        const btn = document.createElement('button');
        btn.innerText = `${prod.name}\n${prod.price}€`;
        btn.className = 'p-2 bg-green-500 text-white rounded';
        btn.onclick = () => addToOrder(prodId);
        grid.appendChild(btn);
    }
}

// Order management
function addToOrder(prodId){
    const item = {...products[prodId], quantity: 1};
    currentOrder.push(item);
    renderOrder();
}

function renderOrder(){
    const container = document.getElementById('receipt-content-interactive');
    container.innerHTML = '';

    let total = 0;
    currentOrder.forEach((item,i)=>{
        total += item.price*item.quantity;
        const row = document.createElement('div');
        row.className = 'flex justify-between mb-1 items-center';
        row.innerHTML = `<span>${item.name} x<input type="number" value="${item.quantity}" min="1" class="w-12 text-center border rounded mx-1" onchange="updateQuantity(${i},this.value)"> </span><span>${(item.price*item.quantity).toFixed(2)}€</span>
            <button class="ml-2 px-1 bg-red-500 text-white rounded" onclick="removeItem(${i})">X</button>`;
        container.appendChild(row);
    });

    if(discount>0){
        const discDiv = document.createElement('div');
        discDiv.className = 'flex justify-between font-bold mt-1';
        discDiv.innerHTML = `<span>Rabatt:</span><span>- ${discount.toFixed(2)}€</span>`;
        container.appendChild(discDiv);
        total -= discount;
    }

    const totalDiv = document.createElement('div');
    totalDiv.className = 'flex justify-between font-bold mt-2';
    totalDiv.innerHTML = `<span>Gesamt:</span><span>${total.toFixed(2)}€</span>`;
    container.appendChild(totalDiv);

    // Payment selection
    const payDiv = document.createElement('div');
    payDiv.className = 'mt-2';
    payDiv.innerHTML = `
        <span class="mr-2">Zahlung:</span>
        <button class="px-2 py-1 rounded bg-gray-300" onclick="setPayment('BAR')">BAR</button>
        <button class="px-2 py-1 rounded bg-gray-300" onclick="setPayment('KARTE')">KARTE</button>
        <span class="ml-4 font-bold">${selectedPaymentMethod}</span>
    `;
    container.appendChild(payDiv);
}

function updateQuantity(index,value){
    currentOrder[index].quantity = parseInt(value) || 1;
    renderOrder();
}

function setPayment(method){
    selectedPaymentMethod = method;
    renderOrder();
}

function removeItem(index){
    currentOrder.splice(index,1);
    renderOrder();
}

// Complete order
async function completeOrder(){
    if(currentOrder.length===0){ showToast('Keine Produkte im Warenkorb','error'); return; }
    const total = currentOrder.reduce((sum,item)=>sum+(item.price*item.quantity),0) - discount;
    const transaction = { 
        id: Date.now().toString(), 
        items: currentOrder, 
        total: total.toFixed(2),
        payment: selectedPaymentMethod,
        timestamp: new Date().toISOString() 
    };
    await set(child(ref(db), 'transactions/'+transaction.id), transaction);
    transactionHistory.unshift(transaction);
    currentOrder=[];
    discount = 0;
    renderOrder();
    showToast('Transaktion gespeichert','success');
}

// Auth observer
onAuthStateChanged(auth,user=>{
    if(user){
        document.getElementById('login-modal').style.display='none';
        document.getElementById('kasse-content').style.display='block';
        loadData();
    } else{
        document.getElementById('kasse-content').style.display='none';
        document.getElementById('login-modal').style.display='flex';
    }
});
</script>

<style>
@keyframes fade {0%{opacity:0}100%{opacity:1}}
.animate-fade{animation:fade 0.3s;}
</style>
</head>
<body class="bg-gray-50">

<!-- Login Modal -->
<div id="login-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white p-6 rounded-lg w-96">
        <h2 class="text-xl font-bold mb-4">Login</h2>
        <input id="login-email" type="email" placeholder="Email" class="border p-2 w-full mb-2 rounded">
        <input id="login-password" type="password" placeholder="Passwort" class="border p-2 w-full mb-4 rounded">
        <button onclick="handleLogin(document.getElementById('login-email').value,document.getElementById('login-password').value)" class="w-full bg-red-500 text-white p-2 rounded">Login</button>
    </div>
</div>

<!-- Kasse Content -->
<div id="kasse-content" class="hidden p-4">
    <h1 class="text-2xl font-bold mb-4">Kassensystem Pro</h1>
    <div id="category-tabs" class="flex space-x-2 overflow-x-auto mb-4"></div>
    <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-4"></div>
    <div id="receipt-content-interactive" class="mb-4 p-2 bg-white rounded shadow"></div>
    <button onclick="completeOrder()" class="bg-green-600 text-white px-4 py-2 rounded mb-2">Bestellung abschließen</button>
    <button onclick="handleLogout()" class="bg-gray-500 text-white px-4 py-2 rounded">Logout</button>
</div>

</body>
</html>
