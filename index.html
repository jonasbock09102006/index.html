<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gl√ºhweinstand Kasse Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        /* Verhindert Scrollbalken durch √ºberstehende Elemente */
        body.modal-open { overflow: hidden; }
        
        #receipt-content-interactive { overflow-y: auto; max-height: 50vh; } 
        
        .product-btn:active, .numpad-btn:active, .action-btn:active { transform: scale(0.95); }
        
        .numpad-btn {
            @apply w-full rounded-xl font-bold text-xl shadow-sm transition-all border-b-4 border-gray-300 active:border-b-0 active:translate-y-1;
            display: flex; justify-content: center; align-items: center; aspect-ratio: 1.2 / 1;
        }

        /* Druck-Styles */
        @media print {
            body * { visibility: hidden; }
            .receipt-print, .receipt-print * { visibility: visible; }
            .receipt-print {
                position: absolute; left: 0; top: 0; width: 80mm;
                font-family: 'Courier New', monospace; font-size: 10pt; color: #000;
            }
            .receipt-print .line { display: flex; justify-content: space-between; margin-bottom: 2px; }
            .receipt-print hr { border-top: 1px dashed #000; margin: 5px 0; }
            @page { margin: 0; }
        }
    </style>
</head>
<body class="min-h-screen p-2 bg-gray-100 overflow-x-hidden text-gray-800">

    <div id="toast-container" class="fixed top-4 right-4 z-[1000] space-y-2 pointer-events-none"></div>

    <div id="async-loading-overlay" class="fixed inset-0 bg-white/80 z-[2000] hidden flex-col justify-center items-center">
        <div class="w-12 h-12 border-4 border-gray-200 border-t-red-600 rounded-full animate-spin"></div>
        <p class="mt-4 font-bold text-gray-600">Bitte warten...</p>
    </div>

    <div id="kasse-content" style="display: none;" class="h-screen flex flex-col">
        <header class="flex justify-between items-center mb-2 px-2 py-1 bg-white rounded-lg shadow-sm">
            <div id="db-status" class="text-xs font-bold px-2 py-1 rounded bg-yellow-400 text-yellow-900">Verbinde...</div>
            <h1 class="text-xl font-black text-red-700 tracking-tighter uppercase">Gl√ºhwein<span class="text-gray-800">Kasse</span></h1>
            <div id="auth-info" class="text-xs text-gray-500">v2.1</div>
        </header>

        <div class="flex-grow grid grid-cols-1 lg:grid-cols-12 gap-3 h-full pb-2">
            
            <div class="lg:col-span-3 flex flex-col gap-3 order-2 lg:order-1">
                
                <div class="bg-white p-3 rounded-xl shadow-sm flex flex-col flex-grow">
                    <div class="flex justify-between items-center mb-2 bg-gray-50 p-2 rounded-lg">
                        <span class="text-sm font-bold text-gray-500 uppercase">Menge</span>
                        <span id="quantity-display" class="text-4xl font-black text-red-600">1</span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 flex-grow">
                        <button onclick="handleQuantity('7')" class="numpad-btn bg-white text-gray-700">7</button>
                        <button onclick="handleQuantity('8')" class="numpad-btn bg-white text-gray-700">8</button>
                        <button onclick="handleQuantity('9')" class="numpad-btn bg-white text-gray-700">9</button>
                        <button onclick="handleQuantity('4')" class="numpad-btn bg-white text-gray-700">4</button>
                        <button onclick="handleQuantity('5')" class="numpad-btn bg-white text-gray-700">5</button>
                        <button onclick="handleQuantity('6')" class="numpad-btn bg-white text-gray-700">6</button>
                        <button onclick="handleQuantity('1')" class="numpad-btn bg-white text-gray-700">1</button>
                        <button onclick="handleQuantity('2')" class="numpad-btn bg-white text-gray-700">2</button>
                        <button onclick="handleQuantity('3')" class="numpad-btn bg-white text-gray-700">3</button>
                        <button onclick="handleQuantity('C')" class="numpad-btn bg-red-100 text-red-600">C</button>
                        <button onclick="handleQuantity('0')" class="numpad-btn bg-white text-gray-700">0</button>
                        <button onclick="handleQuantity('1x')" class="numpad-btn bg-green-100 text-green-700 font-black">1x</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-2">
                    <button onclick="openTransactionReversalModal()" class="py-3 rounded-xl font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">Letzte Stornieren</button>
                    <button onclick="resetBestellung()" class="py-3 rounded-xl font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">Neue Bestellung</button>
                </div>
            </div>

            <div class="lg:col-span-6 flex flex-col gap-3 order-1 lg:order-2">
                <div id="category-tabs" class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                    </div>

                <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 content-start overflow-y-auto max-h-[70vh]">
                    <p class="col-span-full text-center text-gray-400 mt-10">Produkte laden...</p>
                </div>
                
                <div class="mt-auto grid grid-cols-3 gap-2">
                     <button onclick="openProductModal()" class="py-3 rounded-xl font-bold text-sm bg-indigo-100 text-indigo-700">Produkte</button>
                     <button onclick="runDailyReport()" class="py-3 rounded-xl font-bold text-sm bg-blue-100 text-blue-700">Bericht</button>
                     <button onclick="openSettingsModal()" class="py-3 rounded-xl font-bold text-sm bg-yellow-100 text-yellow-700">Setup</button>
                </div>
            </div>

            <div id="receipt-column" class="lg:col-span-3 flex flex-col h-full bg-white rounded-xl shadow-lg border border-gray-200 order-3 sticky top-2">
                <div class="p-3 border-b bg-gray-50 rounded-t-xl">
                    <h2 class="font-bold text-gray-700 uppercase text-sm tracking-wide text-center">Aktueller Bon</h2>
                </div>
                
                <div id="receipt-content-interactive" class="flex-grow p-2 space-y-1 overflow-y-auto text-sm">
                    <p class="text-center text-gray-400 mt-10 italic">Noch keine Artikel</p>
                </div>

                <div class="p-3 bg-gray-50 border-t rounded-b-xl">
                    <div class="flex justify-between items-end mb-3">
                        <span class="text-gray-500 font-bold text-sm">GESAMT</span>
                        <span id="total-display" class="text-3xl font-black text-gray-800">0,00 ‚Ç¨</span>
                    </div>
                    <button onclick="openPaymentModal()" class="w-full py-4 rounded-xl font-black text-xl text-white bg-green-600 shadow-md hover:bg-green-700 active:transform active:scale-95 transition-all flex justify-between px-6 items-center">
                        <span>Zahlen</span>
                        <span class="text-green-200">‚ûî</span>
                    </button>
                </div>
            </div>

        </div>
    </div>


    <div id="payment-modal" class="hidden fixed inset-0 bg-black/80 z-[1000] flex items-center justify-center p-2">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl flex flex-col max-h-[95vh]">
            
            <div class="p-4 bg-red-600 rounded-t-2xl text-white">
                <div class="flex justify-between items-center">
                    <span class="text-red-100 font-bold uppercase text-sm">Zu Zahlen</span>
                    <button onclick="closeModal('payment-modal')" class="text-white hover:text-red-200 font-bold">Abbrechen</button>
                </div>
                <div id="pay-total-display" class="text-5xl font-black text-center mt-1">0,00 ‚Ç¨</div>
            </div>

            <div class="p-4 flex flex-col gap-4 overflow-y-auto">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-100 p-3 rounded-xl border-2 border-transparent focus-within:border-blue-500 transition-colors">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Gegeben (‚Ç¨)</label>
                        <input type="text" id="input-given" readonly class="w-full bg-transparent text-3xl font-bold text-gray-800 outline-none text-right" placeholder="0,00" value="0,00">
                    </div>
                    <div class="bg-green-50 p-3 rounded-xl border-2 border-green-100">
                        <label class="block text-xs font-bold text-green-700 uppercase">R√ºckgeld</label>
                        <div id="change-display" class="text-3xl font-bold text-green-700 text-right">0,00 ‚Ç¨</div>
                    </div>
                </div>

                <div class="grid grid-cols-5 gap-2">
                    <button onclick="setGiven('exact')" class="py-2 bg-blue-100 text-blue-800 font-bold rounded-lg text-xs">Exakt</button>
                    <button onclick="setGiven(5)" class="py-2 bg-gray-200 text-gray-800 font-bold rounded-lg">5‚Ç¨</button>
                    <button onclick="setGiven(10)" class="py-2 bg-gray-200 text-gray-800 font-bold rounded-lg">10‚Ç¨</button>
                    <button onclick="setGiven(20)" class="py-2 bg-gray-200 text-gray-800 font-bold rounded-lg">20‚Ç¨</button>
                    <button onclick="setGiven(50)" class="py-2 bg-gray-200 text-gray-800 font-bold rounded-lg">50‚Ç¨</button>
                </div>

                <div class="flex gap-2">
                    <div class="grid grid-cols-3 gap-2 flex-grow">
                        <button onclick="addToGiven('7')" class="py-3 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl active:bg-gray-100">7</button>
                        <button onclick="addToGiven('8')" class="py-3 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl active:bg-gray-100">8</button>
                        <button onclick="addToGiven('9')" class="py-3 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl active:bg-gray-100">9</button>
                        <button onclick="addToGiven('4')" class="py-3 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl active:bg-gray-100">4</button>
                        <button onclick="addToGiven('5')" class="py-3 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl active:bg-gray-100">5</button>
                        <button onclick="addToGiven('6')" class="py-3 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl active:bg-gray-100">6</button>
                        <button onclick="addToGiven('1')" class="py-3 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl active:bg-gray-100">1</button>
                        <button onclick="addToGiven('2')" class="py-3 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl active:bg-gray-100">2</button>
                        <button onclick="addToGiven('3')" class="py-3 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl active:bg-gray-100">3</button>
                        <button onclick="addToGiven('C')" class="py-3 bg-red-100 text-red-600 rounded-lg font-bold text-xl">C</button>
                        <button onclick="addToGiven('0')" class="py-3 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl active:bg-gray-100">0</button>
                        <button onclick="addToGiven(',')" class="py-3 bg-white border border-gray-200 shadow-sm rounded-lg font-bold text-xl active:bg-gray-100">,</button>
                    </div>

                    <div class="flex flex-col gap-2 w-1/3">
                        <button id="btn-pay-cash" onclick="processPayment('BAR')" disabled class="flex-grow bg-green-600 text-white rounded-xl font-bold shadow-md disabled:bg-gray-300 disabled:text-gray-500 transition-colors flex flex-col items-center justify-center p-2">
                            <span class="text-2xl mb-1">üí∂</span>
                            <span>Bar</span>
                        </button>
                        <button onclick="processPayment('KARTE')" class="h-20 bg-indigo-600 text-white rounded-xl font-bold shadow-md flex flex-col items-center justify-center p-2 hover:bg-indigo-700">
                            <span class="text-2xl mb-1">üí≥</span>
                            <span>Karte</span>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="receipt-dialog-modal" class="hidden fixed inset-0 bg-black/90 z-[1100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl text-center">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">‚úì</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-1">Zahlung erfolgreich!</h2>
            <p id="receipt-change-info" class="text-gray-500 mb-6 font-medium">R√ºckgeld: 0,00 ‚Ç¨</p>
            
            <div class="space-y-3">
                <button onclick="completeTransaction('none')" class="w-full py-4 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-xl font-bold text-lg">
                    Kein Beleg
                </button>
                <button onclick="completeTransaction('print')" class="w-full py-4 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-xl font-bold text-lg border border-blue-200">
                    üñ®Ô∏è Kassenbon
                </button>
                <button onclick="completeTransaction('bewirtung')" class="w-full py-4 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded-xl font-bold text-lg border border-yellow-200">
                    üìù Bewirtungsbeleg
                </button>
            </div>
        </div>
    </div>

    <div id="login-modal" class="hidden fixed inset-0 bg-black/90 z-[2000] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl w-full max-w-sm shadow-2xl">
            <h1 class="text-2xl font-black text-center text-red-700 mb-6">ANMELDEN</h1>
            <form onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
                <input type="email" id="login-email" placeholder="Email" class="w-full p-3 border rounded-xl" required>
                <input type="password" id="login-password" placeholder="Passwort" class="w-full p-3 border rounded-xl" required>
                <button type="submit" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700">Login</button>
            </form>
        </div>
    </div>

    <div id="product-modal" class="hidden fixed inset-0 bg-black/80 z-[1200] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h2 class="text-lg font-bold text-gray-700">Produkte verwalten</h2>
                <button onclick="closeModal('product-modal')" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            
            <div class="p-4 overflow-y-auto">
                <div class="bg-indigo-50 p-4 rounded-xl mb-6 border border-indigo-100">
                    <h3 class="font-bold text-indigo-800 mb-3" id="product-form-title">Neues Produkt / Bearbeiten</h3>
                    <input type="hidden" id="edit-product-id">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <input id="prod-name" type="text" placeholder="Name" class="md:col-span-2 p-2 rounded border focus:border-indigo-500 outline-none">
                        <input id="prod-price" type="number" step="0.01" placeholder="Preis ‚Ç¨" class="p-2 rounded border focus:border-indigo-500 outline-none">
                        <select id="prod-cat" class="p-2 rounded border focus:border-indigo-500 outline-none">
                            </select>
                    </div>
                    <div class="flex justify-end gap-2 mt-3">
                         <button onclick="clearProductForm()" class="px-4 py-2 text-gray-500 text-sm font-bold hover:bg-gray-200 rounded-lg">Abbrechen</button>
                         <button id="btn-save-prod" onclick="saveProduct()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">Speichern</button>
                    </div>
                </div>

                <div id="admin-product-list" class="space-y-2">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        let currentOrder = []; // [{id, name, price, count, tax}]
        let products = {}; // { id: {id, name, price, category} }
        let categories = { 
            'cat1': 'Getr√§nke Hei√ü', 
            'cat2': 'Getr√§nke Kalt', 
            'cat3': 'Speisen',
            'cat4': 'Sonstiges'
        };
        let inputQuantity = "1";
        
        // Payment State
        let payTotal = 0;
        let payGiven = 0;
        let payChange = 0;
        let pendingPaymentMethod = null;

        // --- INIT ---
        window.onload = function() {
            // Dummy Data Init if empty
            if(Object.keys(products).length === 0) {
                products = {
                    'p1': { id: 'p1', name: 'Gl√ºhwein', price: 4.00, category: 'cat1' },
                    'p2': { id: 'p2', name: 'Kinderpunsch', price: 3.00, category: 'cat1' },
                    'p3': { id: 'p3', name: 'Bratwurst', price: 3.50, category: 'cat3' },
                    'p4': { id: 'p4', name: 'Pommes', price: 3.00, category: 'cat3' },
                    'p5': { id: 'p5', name: 'Cola', price: 2.50, category: 'cat2' },
                    'p6': { id: 'p6', name: 'Pfand', price: 2.00, category: 'cat4' }
                };
            }
            renderUI();
            
            // Simuliere erfolgreichen Login, um Kasse zu starten
            document.getElementById('kasse-content').style.display = 'flex';
            document.getElementById('db-status').innerText = "Lokal Modus";
            document.getElementById('db-status').classList.replace('bg-yellow-400', 'bg-green-500');
            document.getElementById('db-status').classList.replace('text-yellow-900', 'text-white');
        };

        // --- UI RENDERING ---
        function renderUI() {
            renderCategories();
            renderGrid('cat1'); // Default category
            renderReceipt();
        }

        function renderCategories() {
            const container = document.getElementById('category-tabs');
            container.innerHTML = '';
            Object.entries(categories).forEach(([key, name]) => {
                const btn = document.createElement('button');
                btn.className = "whitespace-nowrap px-4 py-2 rounded-lg font-bold text-sm bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 focus:ring-2 focus:ring-red-500 category-tab-btn";
                btn.innerText = name;
                btn.onclick = () => {
                    document.querySelectorAll('.category-tab-btn').forEach(b => {
                        b.classList.remove('bg-red-600', 'text-white');
                        b.classList.add('bg-white', 'text-gray-600');
                    });
                    btn.classList.remove('bg-white', 'text-gray-600');
                    btn.classList.add('bg-red-600', 'text-white');
                    renderGrid(key);
                };
                container.appendChild(btn);
            });
            // Select first
            if(container.firstChild) container.firstChild.click();
        }

        function renderGrid(catId) {
            const container = document.getElementById('product-grid');
            container.innerHTML = '';
            
            const filtered = Object.values(products).filter(p => p.category === catId);
            
            filtered.forEach(p => {
                const btn = document.createElement('button');
                btn.className = "product-btn p-4 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center h-28 hover:border-red-300 hover:bg-red-50 transition-all relative overflow-hidden group";
                btn.onclick = () => addToCart(p.id);
                btn.innerHTML = `
                    <span class="font-bold text-gray-800 leading-tight mb-1 group-hover:scale-105 transition-transform">${p.name}</span>
                    <span class="text-sm font-black text-red-600 bg-red-50 px-2 py-0.5 rounded-md">${p.price.toFixed(2).replace('.', ',')} ‚Ç¨</span>
                `;
                container.appendChild(btn);
            });
        }

        function renderReceipt() {
            const container = document.getElementById('receipt-content-interactive');
            container.innerHTML = '';
            let total = 0;

            if (currentOrder.length === 0) {
                container.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-50"><span class="text-4xl mb-2">üõí</span><span class="text-sm">Bon ist leer</span></div>';
            } else {
                
                currentOrder.forEach((item, index) => {
                    total += item.price;
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-gray-50 p-2 rounded hover:bg-red-50 group border border-transparent hover:border-red-100 transition-colors";
                    div.innerHTML = `
                        <div class="flex-grow">
                            <div class="font-bold text-gray-700">${item.name}</div>
                            <div class="text-xs text-gray-400">1 x ${item.price.toFixed(2).replace('.', ',')} ‚Ç¨</div>
                        </div>
                        <div class="font-bold text-gray-800 mr-3">${item.price.toFixed(2).replace('.', ',')} ‚Ç¨</div>
                        <button onclick="deleteItemFromCart(${index})" class="w-8 h-8 rounded-full bg-white text-red-500 hover:bg-red-500 hover:text-white flex items-center justify-center shadow-sm border border-gray-200 font-bold transition-all">‚úï</button>
                    `;
                    container.appendChild(div); // Append to bottom
                });
                
                // Auto scroll to bottom
                container.scrollTop = container.scrollHeight;
            }

            document.getElementById('total-display').innerText = total.toFixed(2).replace('.', ',') + " ‚Ç¨";
        }

        // --- CORE LOGIC ---

        function handleQuantity(val) {
            if (val === 'C') {
                inputQuantity = "1";
            } else if (val === '1x') {
                inputQuantity = "1";
            } else {
                if (inputQuantity === "1") inputQuantity = val;
                else inputQuantity += val;
            }
            document.getElementById('quantity-display').innerText = inputQuantity;
        }

        function addToCart(prodId) {
            const p = products[prodId];
            if(!p) return;
            const qty = parseInt(inputQuantity);
            
            for(let i=0; i<qty; i++) {
                currentOrder.push({ id: Date.now() + i, name: p.name, price: p.price, category: p.category }); // clone
            }
            
            inputQuantity = "1";
            document.getElementById('quantity-display').innerText = "1";
            renderReceipt();
        }

        // NEU: Einzelnes Item l√∂schen
        function deleteItemFromCart(index) {
            currentOrder.splice(index, 1);
            renderReceipt();
        }

        function resetBestellung() {
            currentOrder = [];
            renderReceipt();
        }

        // --- PAYMENT & CALCULATOR LOGIC ---

        function openPaymentModal() {
            if (currentOrder.length === 0) return showToast("Bitte erst Produkte buchen!", "error");
            
            // Calculate Total
            payTotal = currentOrder.reduce((sum, i) => sum + i.price, 0);
            payGiven = 0;
            payChange = 0;
            
            // UI Reset
            document.getElementById('pay-total-display').innerText = payTotal.toFixed(2).replace('.', ',') + " ‚Ç¨";
            document.getElementById('input-given').value = "0,00";
            document.getElementById('change-display').innerText = "0,00 ‚Ç¨";
            document.getElementById('btn-pay-cash').disabled = true;
            document.getElementById('btn-pay-cash').classList.add('opacity-50');
            
            // Hide sticky receipt column to prevent overlap
            document.getElementById('receipt-column').classList.add('hidden');
            
            document.getElementById('payment-modal').classList.remove('hidden');
        }

        function addToGiven(char) {
            let currentStr = document.getElementById('input-given').value.replace(',', '.');
            // Remove Euro sign and commas
            currentStr = currentStr.replace(/[^\d.]/g, ''); 
            
            // Handle C
            if(char === 'C') currentStr = "0";
            // Handle comma/dot
            else if (char === ',') {
                if(!currentStr.includes('.')) currentStr += ".";
            }
            // Handle digits
            else {
                if(currentStr === "0" || currentStr === "") currentStr = char;
                else currentStr += char;
            }
            
            // Tidy up: prevent double decimal points, ensure maximum two decimal places
            const parts = currentStr.split('.');
            if(parts.length > 2) currentStr = parts[0] + '.' + parts.slice(1).join('');
            if(parts[1] && parts[1].length > 2) currentStr = parts[0] + '.' + parts[1].substring(0, 2);
            
            // Set value and trigger calculation
            updatePaymentCalc(parseFloat(currentStr) || 0);
        }

        function setGiven(amount) {
            if(amount === 'exact') updatePaymentCalc(payTotal);
            else updatePaymentCalc(amount);
        }

        function updatePaymentCalc(givenVal) {
            payGiven = givenVal;
            payChange = payGiven - payTotal;
            
            // UI Update
            document.getElementById('input-given').value = payGiven.toFixed(2).replace('.', ',');
            
            const changeEl = document.getElementById('change-display');
            const cashBtn = document.getElementById('btn-pay-cash');

            if(payChange >= -0.005) { // Erlaube minimale Rundungsfehler f√ºr >= 0
                changeEl.innerText = payChange.toFixed(2).replace('.', ',') + " ‚Ç¨";
                changeEl.classList.remove('text-red-500');
                changeEl.classList.add('text-green-700');
                
                cashBtn.disabled = false;
                cashBtn.classList.remove('opacity-50', 'bg-gray-400');
                cashBtn.classList.add('bg-green-600');
            } else {
                changeEl.innerText = "Fehlt: " + Math.abs(payChange).toFixed(2).replace('.', ',') + " ‚Ç¨";
                changeEl.classList.add('text-red-500');
                changeEl.classList.remove('text-green-700');
                
                cashBtn.disabled = true;
                cashBtn.classList.add('opacity-50', 'bg-gray-400');
                cashBtn.classList.remove('bg-green-600');
            }
        }

        // Step 1: Payment Confirmed, ask for Receipt
        function processPayment(method) {
            pendingPaymentMethod = method;
            
            // Wenn Karte, setzen wir Change auf 0
            if(method === 'KARTE') {
                payGiven = payTotal;
                payChange = 0;
            }

            // Close Payment Modal
            document.getElementById('payment-modal').classList.add('hidden');
            
            // Open Receipt Decision Modal
            const receiptModal = document.getElementById('receipt-dialog-modal');
            document.getElementById('receipt-change-info').innerText = method === 'BAR' 
                ? `R√ºckgeld: ${payChange.toFixed(2).replace('.', ',')} ‚Ç¨`
                : "Zahlung mit Karte";
                
            receiptModal.classList.remove('hidden');
        }

        // Step 2: Finalize
        function completeTransaction(receiptType) {
            // NOTE: Hier m√ºsste der Code zum Speichern der Transaktion eingef√ºgt werden.
            console.log(`Transaktion gespeichert: ${payTotal}‚Ç¨ via ${pendingPaymentMethod}, Beleg: ${receiptType}`);
            
            if(receiptType === 'print' || receiptType === 'bewirtung') {
                // Hier m√ºsste die Drucklogik f√ºr Beleg/Bewirtungsbeleg
                showToast(`Drucke ${receiptType === 'print' ? 'Kassenbon' : 'Bewirtungsbeleg'}...`, "info");
                // window.print(); // w√ºrde Druckdialog √∂ffnen
            }

            showToast("Zahlung erfolgreich abgeschlossen!", "success");
            
            // Cleanup
            document.getElementById('receipt-dialog-modal').classList.add('hidden');
            document.getElementById('receipt-column').classList.remove('hidden'); // Show receipt col again
            resetBestellung();
        }

        // --- PRODUCT MANAGEMENT ---

        function openProductModal() {
            renderAdminProductList();
            // Load Categories into select
            const catSelect = document.getElementById('prod-cat');
            catSelect.innerHTML = '';
            Object.entries(categories).forEach(([k, v]) => {
                const opt = document.createElement('option');
                opt.value = k;
                opt.innerText = v;
                catSelect.appendChild(opt);
            });
            
            document.getElementById('receipt-column').classList.add('hidden');
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function renderAdminProductList() {
            const list = document.getElementById('admin-product-list');
            list.innerHTML = '';
            
            Object.values(products).forEach(p => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100";
                row.innerHTML = `
                    <div>
                        <div class="font-bold text-gray-800">${p.name}</div>
                        <div class="text-sm text-gray-500">${p.price.toFixed(2).replace('.', ',')} ‚Ç¨ | ${categories[p.category]}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editProduct('${p.id}')" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200">‚úèÔ∏è</button>
                        <button onclick="deleteProduct('${p.id}')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">üóëÔ∏è</button>
                    </div>
                `;
                list.appendChild(row);
            });
        }

        // NEU: Produkt bearbeiten Laden
        function editProduct(id) {
            const p = products[id];
            if(!p) return;
            
            document.getElementById('edit-product-id').value = p.id;
            document.getElementById('prod-name').value = p.name;
            document.getElementById('prod-price').value = p.price;
            document.getElementById('prod-cat').value = p.category;
            
            document.getElementById('product-form-title').innerText = "Produkt bearbeiten";
            document.getElementById('btn-save-prod').innerText = "√Ñnderung speichern";
            document.getElementById('btn-save-prod').classList.replace('bg-indigo-600', 'bg-orange-600');
        }

        function clearProductForm() {
            document.getElementById('edit-product-id').value = "";
            document.getElementById('prod-name').value = "";
            document.getElementById('prod-price').value = "";
            
            document.getElementById('product-form-title').innerText = "Neues Produkt";
            document.getElementById('btn-save-prod').innerText = "Speichern";
            document.getElementById('btn-save-prod').classList.remove('bg-orange-600');
            document.getElementById('btn-save-prod').classList.add('bg-indigo-600');
        }

        function saveProduct() {
            const id = document.getElementById('edit-product-id').value;
            const name = document.getElementById('prod-name').value;
            const price = parseFloat(document.getElementById('prod-price').value);
            const cat = document.getElementById('prod-cat').value;

            if(!name || isNaN(price)) return showToast("Bitte Daten pr√ºfen", "error");

            if(id && products[id]) {
                // Update
                products[id].name = name;
                products[id].price = price;
                products[id].category = cat;
                showToast("Produkt aktualisiert", "success");
            } else {
                // Create
                const newId = 'p' + Date.now();
                products[newId] = { id: newId, name, price, category: cat };
                showToast("Produkt erstellt", "success");
            }
            
            clearProductForm();
            renderAdminProductList();
            renderUI(); // Refresh main grid
        }
        
        function deleteProduct(id) {
            if(confirm("Soll das Produkt wirklich gel√∂scht werden?")) {
                delete products[id];
                renderAdminProductList();
                renderUI();
                showToast("Produkt gel√∂scht", "info");
            }
        }

        // --- UTILS ---
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            if(id === 'payment-modal' || id === 'product-modal') {
                document.getElementById('receipt-column').classList.remove('hidden');
            }
        }

        function showToast(msg, type) {
            const el = document.createElement('div');
            const color = type === 'error' ? 'bg-red-500' : (type === 'info' ? 'bg-blue-600' : 'bg-green-600');
            el.className = `${color} text-white px-6 py-3 rounded-xl shadow-xl font-bold transform transition-all translate-y-2 opacity-0`;
            el.innerText = msg;
            document.getElementById('toast-container').appendChild(el);
            
            requestAnimationFrame(() => {
                el.classList.remove('translate-y-2', 'opacity-0');
            });
            setTimeout(() => el.remove(), 3000);
        }
        
        // Dummy Function calls from HTML
        function openTransactionReversalModal() { showToast("Funktion: Storno Historie (noch nicht implementiert)", "info"); }
        function runDailyReport() { showToast("Funktion: Tagesbericht (noch nicht implementiert)", "info"); }
        function openSettingsModal() { showToast("Funktion: Einstellungen (noch nicht implementiert)", "info"); }
        function handleLogin() { document.getElementById('login-modal').classList.add('hidden'); document.getElementById('kasse-content').style.display = 'flex'; }

    </script>
</body>
</html>
