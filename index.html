<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kassensystem Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }

    .force-hidden { display: none !important; }

    #receipt-content-interactive { overflow-y: auto; max-height: 45vh; }
    .product-btn:active { transform: scale(0.98); }
    .numpad-btn { height: 60px; font-size: 1.5rem; font-weight: bold; border-radius: 0.75rem; transition: background-color 0.1s; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    
    #async-loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.8); z-index:5000; display:none; justify-content:center; align-items:center; }
    .spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #dc2626; border-radius: 50%; width:40px; height:40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    
    #toast-container { position: fixed; top:1rem; right:1rem; z-index:6000; pointer-events:none; }
    .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: #fff; margin-bottom:0.5rem; opacity:0; transition: opacity 0.3s ease; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); font-weight: bold; }
    .toast-success { background: #16a34a; } 
    .toast-error { background:#dc2626; } 
    .toast-info { background:#2563eb; }

    .modal-backdrop { display:none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; padding: 1rem; z-index: 1000; backdrop-filter: blur(2px); }

    /* Print Styles */
    #print-receipt-container { display: none; }
    @media print {
      body * { visibility: hidden !important; }
      #print-receipt-container, #print-receipt-container * { visibility: visible !important; }
      #print-receipt-container { 
        position: absolute; left: 0; top: 0; width: 80mm; 
        font-family: 'Courier New', monospace; font-size: 12px; color: black; padding: 5mm;
      }
      .receipt-line { display: flex; justify-content: space-between; margin-bottom: 2px; }
      .receipt-divider { border-top: 1px dashed #000; margin: 5px 0; }
      .receipt-center { text-align: center; }
    }
  </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col text-gray-800 select-none">

  <div id="toast-container"></div>
  <div id="async-loading-overlay"><div class="spinner"></div></div>

  <div id="setup-modal" class="modal-backdrop z-[2000]">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-3xl text-center">
      <h1 class="text-4xl font-extrabold text-gray-800 mb-2">Einrichtung</h1>
      <p class="text-gray-500 mb-8 font-medium">Wie m√∂chten Sie Ihr System konfigurieren?</p>
      
      <div class="grid md:grid-cols-3 gap-6 mb-8">
        <button onclick="window.selectSystemType('simple')" class="p-6 border-2 border-green-100 hover:border-green-500 bg-green-50 rounded-2xl transition group text-left">
          <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">üü¢</div>
          <div class="font-bold text-lg mb-1">Einfach</div>
          <p class="text-sm text-gray-600">Nur Kassieren. Keine Best√§nde, keine Steuern, kein Code.</p>
        </button>
        <button onclick="window.selectSystemType('complex')" class="p-6 border-2 border-blue-100 hover:border-blue-500 bg-blue-50 rounded-2xl transition group text-left">
          <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">üîµ</div>
          <div class="font-bold text-lg mb-1">Komplett</div>
          <p class="text-sm text-gray-600">Alles an: Bestand, MwSt, EAN, Geb√ºhren, Storno-Schutz.</p>
        </button>
        <button onclick="window.toggleCustomSetup()" class="p-6 border-2 border-gray-100 hover:border-gray-500 bg-white rounded-2xl transition group text-left">
          <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">‚öôÔ∏è</div>
          <div class="font-bold text-lg mb-1">Individuell</div>
          <p class="text-sm text-gray-600">W√§hlen Sie Ihre Module selbst aus.</p>
        </button>
      </div>

      <div id="custom-setup-options" class="hidden text-left bg-gray-50 p-6 rounded-xl mb-6 border border-gray-200">
        <h4 class="font-bold text-gray-700 mb-4">Module aktivieren:</h4>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <label class="flex items-center space-x-3 bg-white p-3 rounded-lg border cursor-pointer hover:bg-gray-50">
                <input type="checkbox" id="mod-check-stock" class="w-5 h-5 accent-red-600">
                <span class="font-medium">Warenbestand f√ºhren</span>
            </label>
            <label class="flex items-center space-x-3 bg-white p-3 rounded-lg border cursor-pointer hover:bg-gray-50">
                <input type="checkbox" id="mod-check-tax" class="w-5 h-5 accent-red-600">
                <span class="font-medium">MwSt. (7%/19%) ausweisen</span>
            </label>
            <label class="flex items-center space-x-3 bg-white p-3 rounded-lg border cursor-pointer hover:bg-gray-50">
                <input type="checkbox" id="mod-check-security" class="w-5 h-5 accent-red-600">
                <span class="font-medium">Sicherheitscode (Storno/Settings)</span>
            </label>
            <label class="flex items-center space-x-3 bg-white p-3 rounded-lg border cursor-pointer hover:bg-gray-50">
                <input type="checkbox" id="mod-check-cardfee" class="w-5 h-5 accent-red-600">
                <span class="font-medium">Kartengeb√ºhr berechnen</span>
            </label>
        </div>
        <button onclick="window.selectSystemType('custom')" class="mt-6 w-full bg-gray-900 text-white p-4 rounded-xl font-bold hover:bg-black transition">Speichern & System starten</button>
      </div>
    </div>
  </div>

  <div id="login-modal" class="modal-backdrop z-[1500]" style="display:flex;">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm">
      <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-6">Willkommen</h1>
      <form id="login-form">
        <div class="mb-4">
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">E-Mail</label>
          <input type="email" id="login-email" required class="w-full p-3 border rounded-xl bg-gray-50 focus:ring-2 focus:ring-red-500 outline-none">
        </div>
        <div class="mb-6">
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Passwort</label>
          <input type="password" id="login-password" required class="w-full p-3 border rounded-xl bg-gray-50 focus:ring-2 focus:ring-red-500 outline-none">
        </div>
        <button type="submit" class="w-full p-3 rounded-xl font-bold text-white bg-red-600 hover:bg-red-700 transition shadow-lg">Anmelden</button>
      </form>
      <div class="mt-8 text-center space-y-3">
        <button onclick="window.switchAuthModal('register')" class="text-sm text-indigo-600 font-bold block w-full hover:underline">Neues Konto erstellen</button>
        <button onclick="window.switchAuthModal('forgot')" class="text-sm text-gray-400 font-medium block w-full hover:text-gray-600">Passwort vergessen?</button>
      </div>
    </div>
  </div>

  <div id="register-modal" class="modal-backdrop z-[1500]">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm">
      <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-6">Konto erstellen</h1>
      <form id="register-form">
        <input type="email" id="register-email" required placeholder="E-Mail" class="w-full p-3 border rounded-xl mb-4 bg-gray-50">
        <input type="password" id="register-password" required placeholder="Passwort (min. 6 Zeichen)" class="w-full p-3 border rounded-xl mb-6 bg-gray-50">
        <button type="submit" class="w-full p-3 rounded-xl font-bold text-white bg-green-600 hover:bg-green-700 transition">Registrieren</button>
      </form>
      <button onclick="window.switchAuthModal('login')" class="mt-4 text-sm text-gray-500 block w-full text-center">Zur√ºck zum Login</button>
    </div>
  </div>

  <div id="forgot-modal" class="modal-backdrop z-[1500]">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center mb-4">Passwort zur√ºcksetzen</h2>
      <form id="reset-form">
        <input type="email" id="reset-email" required placeholder="Ihre E-Mail" class="w-full p-3 border rounded-xl mb-6 bg-gray-50">
        <button type="submit" class="w-full p-3 rounded-xl font-bold text-white bg-blue-600">Link senden</button>
      </form>
      <button onclick="window.switchAuthModal('login')" class="mt-4 text-sm text-gray-500 block w-full text-center">Abbrechen</button>
    </div>
  </div>

  <div id="kasse-content" class="hidden flex-grow flex-col md:flex-row h-full">
    <div class="md:w-2/3 flex flex-col p-4 gap-4 h-full bg-gray-100">
       <div class="flex flex-col sm:flex-row gap-3 bg-white p-3 rounded-2xl shadow-sm border border-gray-200">
           <div id="category-tabs" class="flex-grow flex gap-2 overflow-x-auto pb-1 scrollbar-hide">
               </div>
           <div class="flex gap-2">
               <input type="text" id="search-input" placeholder="Name / EAN..." class="w-full sm:w-48 p-2 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
               <button onclick="window.handleLogout()" class="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-100 transition">
                   <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
               </button>
           </div>
       </div>
       
       <div id="product-grid" class="flex-grow grid grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 content-start overflow-y-auto pr-1">
           </div>

       <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200 grid grid-cols-1 sm:grid-cols-[1.2fr_3fr] gap-4">
            <div class="flex flex-col gap-2">
                <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Eingabe / Menge</div>
                <div id="qty-display" class="flex-grow flex items-center justify-center text-6xl font-black text-blue-600 bg-blue-50 rounded-2xl border-2 border-blue-100 shadow-inner">1</div>
            </div>
            <div class="grid grid-cols-4 gap-2">
                <button onclick="handleQtyInput('7')" class="numpad-btn bg-gray-100 hover:bg-gray-200 text-gray-700">7</button>
                <button onclick="handleQtyInput('8')" class="numpad-btn bg-gray-100 hover:bg-gray-200 text-gray-700">8</button>
                <button onclick="handleQtyInput('9')" class="numpad-btn bg-gray-100 hover:bg-gray-200 text-gray-700">9</button>
                <button onclick="handleQtyInput('ac')" class="numpad-btn bg-red-100 hover:bg-red-200 text-red-600 font-black">AC</button>
                
                <button onclick="handleQtyInput('4')" class="numpad-btn bg-gray-100 hover:bg-gray-200 text-gray-700">4</button>
                <button onclick="handleQtyInput('5')" class="numpad-btn bg-gray-100 hover:bg-gray-200 text-gray-700">5</button>
                <button onclick="handleQtyInput('6')" class="numpad-btn bg-gray-100 hover:bg-gray-200 text-gray-700">6</button>
                <button onclick="handleQtyInput('c')" class="numpad-btn bg-orange-100 hover:bg-orange-200 text-orange-600 font-black">C</button>
                
                <button onclick="handleQtyInput('1')" class="numpad-btn bg-gray-100 hover:bg-gray-200 text-gray-700">1</button>
                <button onclick="handleQtyInput('2')" class="numpad-btn bg-gray-100 hover:bg-gray-200 text-gray-700">2</button>
                <button onclick="handleQtyInput('3')" class="numpad-btn bg-gray-100 hover:bg-gray-200 text-gray-700">3</button>
                <button onclick="handleQtyInput('0')" class="numpad-btn bg-gray-100 hover:bg-gray-200 text-gray-700">0</button>
            </div>
       </div>
    </div>

    <div class="md:w-1/3 bg-white shadow-2xl flex flex-col z-10 border-l border-gray-200">
        <div class="p-4 bg-gray-900 text-white shadow-md flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                <span class="font-black text-lg tracking-tight">AKTUELLER BON</span>
            </div>
            <button onclick="window.clearCart()" class="text-[10px] font-bold bg-white/10 hover:bg-red-600 px-3 py-1.5 rounded-lg transition-colors border border-white/10 uppercase">Leeren</button>
        </div>
        
        <div id="receipt-content-interactive" class="flex-grow p-4 space-y-3">
             <div class="h-full flex flex-col items-center justify-center opacity-20 grayscale">
                 <svg class="w-20 h-20 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                 <p class="font-bold uppercase tracking-widest text-sm text-center">Bon ist leer</p>
             </div>
        </div>

        <div class="p-5 bg-gray-50 border-t border-gray-200 space-y-4 shadow-[0_-4px_10px_rgba(0,0,0,0.03)]">
            <div class="space-y-1">
                <div class="flex justify-between text-xs font-bold text-gray-400 uppercase px-1">
                    <span>Zwischensumme</span>
                    <span id="subtotal-display">0,00 ‚Ç¨</span>
                </div>
                <div class="flex justify-between items-end px-1">
                    <span class="text-gray-900 font-black text-lg">GESAMT</span>
                    <span id="total-display" class="text-4xl font-black text-gray-900 tracking-tighter">0,00 ‚Ç¨</span>
                </div>
            </div>
            
            <button onclick="window.openFinalizeModal()" id="btn-main-pay" disabled class="w-full p-4 bg-green-600 hover:bg-green-700 text-white rounded-2xl font-black text-xl shadow-xl shadow-green-200 transition-all active:scale-95 disabled:opacity-30 disabled:grayscale disabled:pointer-events-none uppercase tracking-wider">
                Abrechnen
            </button>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="window.openSettingsModalAuth()" class="p-3 bg-white border border-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-50 transition flex items-center justify-center gap-2 shadow-sm text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>System</span>
                </button>
                <button onclick="window.openReportModalAuth()" class="p-3 bg-blue-50 text-blue-700 font-bold rounded-xl hover:bg-blue-100 transition flex items-center justify-center gap-2 shadow-sm text-sm border border-blue-100">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    <span>Berichte</span>
                </button>
            </div>
        </div>
    </div>
  </div>

  <div id="finalize-modal" class="modal-backdrop z-[3000]">
    <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border border-gray-100">
      <h2 class="text-3xl font-black text-center mb-2 tracking-tight">ZAHLUNG</h2>
      <p class="text-center text-gray-400 font-bold mb-8 uppercase text-xs tracking-widest">Bitte Zahlungsart w√§hlen</p>
      
      <div id="finalize-total-display" class="text-6xl font-black text-center text-gray-900 mb-10 tracking-tighter">0,00 ‚Ç¨</div>
      
      <div class="grid grid-cols-1 gap-4 mb-8">
          <button onclick="window.processPayment('BAR')" class="p-6 bg-green-50 hover:bg-green-100 border-2 border-green-200 text-green-700 rounded-2xl font-black text-2xl flex items-center justify-between transition-all group">
              <span>üíµ BAR</span>
              <svg class="w-8 h-8 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
          </button>
          <button onclick="window.processPayment('KARTE')" class="p-6 bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 text-blue-700 rounded-2xl font-black text-2xl flex items-center justify-between transition-all group">
              <span>üí≥ KARTE</span>
              <svg class="w-8 h-8 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
          </button>
      </div>

      <div id="card-fee-info" class="hidden bg-orange-50 text-orange-700 p-4 rounded-xl mb-6 text-sm font-bold border border-orange-100 flex items-center gap-3">
          <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
          <span>Hinweis: Es wird eine Kartengeb√ºhr von <span id="card-fee-amount">0.00</span>‚Ç¨ erhoben.</span>
      </div>

      <button onclick="closeModal('finalize-modal')" class="w-full text-gray-400 font-bold uppercase text-xs tracking-widest hover:text-gray-600 transition">Vorgang abbrechen</button>
    </div>
  </div>

  <div id="settings-modal" class="modal-backdrop z-[4000]">
    <div class="bg-white w-full max-w-5xl h-[90vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col border border-gray-100">
      <div class="p-6 bg-gray-900 text-white flex justify-between items-center">
        <h2 class="text-2xl font-black tracking-tight flex items-center gap-3">
            <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path></svg>
            SYSTEMSTEUERUNG
        </h2>
        <button onclick="closeModal('settings-modal')" class="p-2 hover:bg-white/10 rounded-full transition"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
      </div>
      
      <div class="flex-grow flex overflow-hidden">
        <div class="w-64 bg-gray-50 border-r border-gray-200 flex flex-col p-4 gap-2">
            <button onclick="switchSettingsTab('inventory')" id="tab-inventory" class="settings-tab-btn active w-full p-4 rounded-xl font-bold text-left transition flex items-center gap-3">üì¶ Inventar</button>
            <button onclick="switchSettingsTab('cats')" id="tab-cats" class="settings-tab-btn w-full p-4 rounded-xl font-bold text-left transition flex items-center gap-3">üìÅ Kategorien</button>
            <button onclick="switchSettingsTab('config')" id="tab-config" class="settings-tab-btn w-full p-4 rounded-xl font-bold text-left transition flex items-center gap-3">üõ†Ô∏è Konfiguration</button>
            <div class="mt-auto p-4 bg-blue-50 border border-blue-100 rounded-2xl">
                <div class="text-[10px] font-black text-blue-400 uppercase mb-1">Backup</div>
                <button onclick="window.exportSystemData()" class="text-xs font-bold text-blue-700 hover:underline">Daten exportieren</button>
            </div>
        </div>
        
        <div class="flex-grow overflow-y-auto p-8" id="settings-content-area">
            </div>
      </div>
    </div>
  </div>

  <div id="product-modal" class="modal-backdrop z-[5000]">
    <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-lg">
      <h3 id="product-modal-title" class="text-2xl font-black mb-6">Neues Produkt</h3>
      <form id="product-form" class="space-y-4">
        <input type="hidden" id="edit-product-id">
        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Produktname</label><input type="text" id="p-name" required class="w-full p-3 border rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500"></div>
        <div class="grid grid-cols-2 gap-4">
            <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Preis (‚Ç¨)</label><input type="number" step="0.01" id="p-price" required class="w-full p-3 border rounded-xl bg-gray-50 outline-none"></div>
            <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Kategorie</label><select id="p-category" class="w-full p-3 border rounded-xl bg-gray-50 outline-none"></select></div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Bestand</label><input type="number" id="p-stock" value="0" class="w-full p-3 border rounded-xl bg-gray-50"></div>
            <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">EAN Code</label><input type="text" id="p-ean" class="w-full p-3 border rounded-xl bg-gray-50"></div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">MwSt. (%)</label><select id="p-tax" class="w-full p-3 border rounded-xl bg-gray-50"><option value="19">19%</option><option value="7">7%</option><option value="0">0%</option></select></div>
            <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Farbe</label><input type="color" id="p-color" value="#3b82f6" class="w-full h-[50px] border rounded-xl bg-white p-1"></div>
        </div>
        <div class="flex gap-3 pt-4">
            <button type="button" onclick="closeModal('product-modal')" class="flex-grow p-4 bg-gray-100 text-gray-600 font-bold rounded-2xl">Abbrechen</button>
            <button type="submit" class="flex-grow p-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg shadow-blue-200">Speichern</button>
        </div>
      </form>
    </div>
  </div>

  <div id="pin-modal" class="modal-backdrop z-[6000]">
    <div class="bg-gray-900 p-8 rounded-3xl shadow-2xl w-full max-w-xs text-center border border-white/10">
      <div class="text-blue-400 mb-4"><svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg></div>
      <h3 class="text-white font-black text-xl mb-6 uppercase tracking-widest">Pin eingeben</h3>
      <div id="pin-display" class="flex justify-center gap-3 mb-8">
          <div class="w-4 h-4 rounded-full bg-white/10 border border-white/20"></div>
          <div class="w-4 h-4 rounded-full bg-white/10 border border-white/20"></div>
          <div class="w-4 h-4 rounded-full bg-white/10 border border-white/20"></div>
          <div class="w-4 h-4 rounded-full bg-white/10 border border-white/20"></div>
      </div>
      <div class="grid grid-cols-3 gap-3">
          <button onclick="handlePinInput('1')" class="h-16 bg-white/5 hover:bg-white/10 text-white font-bold text-2xl rounded-2xl transition-all">1</button>
          <button onclick="handlePinInput('2')" class="h-16 bg-white/5 hover:bg-white/10 text-white font-bold text-2xl rounded-2xl transition-all">2</button>
          <button onclick="handlePinInput('3')" class="h-16 bg-white/5 hover:bg-white/10 text-white font-bold text-2xl rounded-2xl transition-all">3</button>
          <button onclick="handlePinInput('4')" class="h-16 bg-white/5 hover:bg-white/10 text-white font-bold text-2xl rounded-2xl transition-all">4</button>
          <button onclick="handlePinInput('5')" class="h-16 bg-white/5 hover:bg-white/10 text-white font-bold text-2xl rounded-2xl transition-all">5</button>
          <button onclick="handlePinInput('6')" class="h-16 bg-white/5 hover:bg-white/10 text-white font-bold text-2xl rounded-2xl transition-all">6</button>
          <button onclick="handlePinInput('7')" class="h-16 bg-white/5 hover:bg-white/10 text-white font-bold text-2xl rounded-2xl transition-all">7</button>
          <button onclick="handlePinInput('8')" class="h-16 bg-white/5 hover:bg-white/10 text-white font-bold text-2xl rounded-2xl transition-all">8</button>
          <button onclick="handlePinInput('9')" class="h-16 bg-white/5 hover:bg-white/10 text-white font-bold text-2xl rounded-2xl transition-all">9</button>
          <button onclick="closeModal('pin-modal')" class="h-16 text-white/40 flex items-center justify-center"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
          <button onclick="handlePinInput('0')" class="h-16 bg-white/5 hover:bg-white/10 text-white font-bold text-2xl rounded-2xl transition-all">0</button>
          <button onclick="handlePinInput('delete')" class="h-16 text-red-500 flex items-center justify-center"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M3 12l6.414 6.414a2 2 0 001.414.586H19a2 2 0 002-2V7a2 2 0 00-2-2h-8.172a2 2 0 00-1.414.586L3 12z"></path></svg></button>
      </div>
    </div>
  </div>

  <div id="print-receipt-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, addDoc, getDocs, query, orderBy, Timestamp, limit, where } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
      authDomain: "kassensystem-85412.firebaseapp.com",
      projectId: "kassensystem-85412",
      storageBucket: "kassensystem-85412.firebasestorage.app",
      messagingSenderId: "916536785810",
      appId: "1:916536785810:web:0d0319ef565af65d279f4b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // STATE
    let currentUser = null;
    let products = {};
    let categories = {};
    let cart = [];
    let settings = { mode: 'complex', stock: true, tax: true, security: true, cardfee: 0, pin: '0000', companyName: 'Mein Kiosk' };
    let qtyInput = "1";
    let activePinAction = null;
    let tempPin = "";

    // -- AUTH LOGIK --
    onAuthStateChanged(auth, async (user) => {
        if(user) {
            currentUser = user;
            await initializeSystem();
        } else {
            currentUser = null;
            uiState('login');
        }
    });

    async function initializeSystem() {
        window.showLoading(true);
        const setSnap = await getDoc(doc(db, `users/${currentUser.uid}/config/settings`));
        if(!setSnap.exists()) {
            uiState('setup');
        } else {
            settings = { ...settings, ...setSnap.data() };
            await loadProducts();
            await loadCategories();
            uiState('kasse');
        }
        window.showLoading(false);
    }

    async function loadProducts() {
        const snap = await getDocs(collection(db, `users/${currentUser.uid}/products`));
        products = {};
        snap.forEach(d => products[d.id] = {id: d.id, ...d.data()});
        renderMainGrid();
    }

    async function loadCategories() {
        const snap = await getDocs(collection(db, `users/${currentUser.uid}/categories`));
        categories = {};
        snap.forEach(d => categories[d.id] = {id: d.id, ...d.data()});
        renderTabs();
    }

    // -- UI LOGIK --
    function uiState(state) {
        document.getElementById('login-modal').style.display = state === 'login' ? 'flex' : 'none';
        document.getElementById('register-modal').style.display = state === 'register' ? 'flex' : 'none';
        document.getElementById('forgot-modal').style.display = state === 'forgot' ? 'flex' : 'none';
        document.getElementById('setup-modal').style.display = state === 'setup' ? 'flex' : 'none';
        document.getElementById('kasse-content').style.display = state === 'kasse' ? 'flex' : 'none';
    }

    window.switchAuthModal = (m) => uiState(m);

    window.showLoading = (s) => document.getElementById('async-loading-overlay').style.display = s ? 'flex' : 'none';

    window.showToast = (msg, type = 'success') => {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast toast-${type}`;
        t.innerText = msg;
        c.appendChild(t);
        setTimeout(()=> t.style.opacity = "1", 10);
        setTimeout(()=> {
            t.style.opacity = "0";
            setTimeout(()=> t.remove(), 300);
        }, 3000);
    };

    window.closeModal = (id) => document.getElementById(id).style.display = 'none';

    // -- SETUP WIZARD --
    window.toggleCustomSetup = () => {
        document.getElementById('custom-setup-options').classList.toggle('hidden');
    };

    window.selectSystemType = async (type) => {
        window.showLoading(true);
        let config = {};
        if(type === 'simple') {
            config = { mode: 'simple', stock: false, tax: false, security: false, cardfee: 0, pin: '', companyName: 'Mein Kiosk' };
        } else if(type === 'complex') {
            config = { mode: 'complex', stock: true, tax: true, security: true, cardfee: 1.5, pin: '0000', companyName: 'Mein Kiosk' };
        } else {
            config = {
                mode: 'custom',
                stock: document.getElementById('mod-check-stock').checked,
                tax: document.getElementById('mod-check-tax').checked,
                security: document.getElementById('mod-check-security').checked,
                cardfee: document.getElementById('mod-check-cardfee').checked ? 1.5 : 0,
                pin: document.getElementById('mod-check-security').checked ? '0000' : '',
                companyName: 'Mein Kiosk'
            };
        }
        await setDoc(doc(db, `users/${currentUser.uid}/config/settings`), config);
        settings = config;
        
        // Demo-Daten anlegen
        const demoCat = await addDoc(collection(db, `users/${currentUser.uid}/categories`), { name: 'Getr√§nke', color: '#3b82f6' });
        await addDoc(collection(db, `users/${currentUser.uid}/products`), {
            name: 'Cola 0.5l', price: 2.50, categoryId: demoCat.id, stock: 50, tax: 19, ean: '', color: '#3b82f6'
        });

        await initializeSystem();
    };

    // -- NUMPAD LOGIK --
    window.handleQtyInput = (key) => {
        if(key === 'ac') {
            qtyInput = "1";
        } else if(key === 'c') {
            qtyInput = qtyInput.length > 1 ? qtyInput.slice(0, -1) : "1";
        } else {
            if(qtyInput === "1") qtyInput = key;
            else if(qtyInput.length < 3) qtyInput += key;
        }
        document.getElementById('qty-display').innerText = qtyInput;
    };

    // -- KASSE / WARENKORB --
    window.renderMainGrid = (catId = null) => {
        const grid = document.getElementById('product-grid');
        grid.innerHTML = '';
        const search = document.getElementById('search-input').value.toLowerCase();
        
        Object.values(products).filter(p => {
            const matchesSearch = p.name.toLowerCase().includes(search) || (p.ean && p.ean.includes(search));
            const matchesCat = !catId || p.categoryId === catId;
            return matchesSearch && matchesCat;
        }).forEach(p => {
            const btn = document.createElement('button');
            btn.className = "product-btn bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center min-h-[110px] text-center relative overflow-hidden group hover:border-blue-500 transition-all";
            btn.onclick = () => window.addToCart(p.id);
            
            const stockColor = p.stock <= 5 ? 'text-red-500 font-black' : 'text-gray-400';
            const stockInfo = settings.stock ? `<div class="absolute top-1 right-2 text-[9px] ${stockColor}">${p.stock} Stk</div>` : '';
            
            btn.innerHTML = `
                ${stockInfo}
                <div class="text-sm font-bold text-gray-700 leading-tight mb-2 group-hover:text-blue-600 transition-colors">${p.name}</div>
                <div class="text-lg font-black text-gray-900">${p.price.toFixed(2)} ‚Ç¨</div>
                <div class="absolute bottom-0 left-0 right-0 h-1" style="background:${p.color || '#3b82f6'}"></div>
            `;
            grid.appendChild(btn);
        });
    };

    window.addToCart = (pid) => {
        const p = products[pid];
        const qty = parseInt(qtyInput);
        
        if(settings.stock && p.stock < qty) {
            return window.showToast(`Nur noch ${p.stock} Stk verf√ºgbar!`, 'error');
        }

        const existing = cart.find(i => i.id === pid);
        if(existing) {
            existing.quantity += qty;
            existing.total = existing.quantity * existing.price;
        } else {
            cart.push({
                id: pid,
                name: p.name,
                price: p.price,
                quantity: qty,
                total: qty * p.price,
                taxRate: p.tax || 19
            });
        }
        
        qtyInput = "1";
        updateCartUI();
        window.showToast(`${p.name} hinzugef√ºgt`);
    };

    // -- STORNO FUNKTION --
    window.removeFromCart = (pid) => {
        const qtyToRemove = parseInt(qtyInput);
        const idx = cart.findIndex(i => i.id === pid);
        
        if(idx === -1) return;

        // Falls Sicherheitscode an ist, Storno-Schutz
        if(settings.security && activePinAction !== 'storno_confirm') {
            activePinAction = 'storno_confirm';
            tempPin = "";
            window.tempStornoId = pid;
            document.getElementById('pin-modal').style.display = 'flex';
            updatePinDisplay();
            return;
        }

        if(cart[idx].quantity <= qtyToRemove) {
            cart.splice(idx, 1);
        } else {
            cart[idx].quantity -= qtyToRemove;
            cart[idx].total = cart[idx].quantity * cart[idx].price;
        }
        
        qtyInput = "1";
        activePinAction = null;
        updateCartUI();
        window.showToast("Storno ausgef√ºhrt", "info");
    };

    function updateCartUI() {
        const container = document.getElementById('receipt-content-interactive');
        const totalDisp = document.getElementById('total-display');
        const subtotalDisp = document.getElementById('subtotal-display');
        const payBtn = document.getElementById('btn-main-pay');
        
        if(cart.length === 0) {
            container.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center opacity-20 grayscale">
                    <svg class="w-20 h-20 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                    <p class="font-bold uppercase tracking-widest text-sm text-center">Bon ist leer</p>
                </div>`;
            totalDisp.innerText = "0,00 ‚Ç¨";
            subtotalDisp.innerText = "0,00 ‚Ç¨";
            payBtn.disabled = true;
            document.getElementById('qty-display').innerText = qtyInput;
            return;
        }

        let total = 0;
        container.innerHTML = cart.map(item => {
            total += item.total;
            return `
                <div class="flex justify-between items-center bg-white p-3 rounded-2xl border border-gray-100 shadow-sm animate-in slide-in-from-right-2 duration-200">
                    <div class="flex-grow">
                        <div class="font-bold text-gray-800 text-sm leading-tight">${item.name}</div>
                        <div class="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">${item.quantity}x ${item.price.toFixed(2)}‚Ç¨</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-black text-gray-900">${item.total.toFixed(2)}‚Ç¨</span>
                        <button onclick="window.removeFromCart('${item.id}')" class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-500 rounded-full hover:bg-red-500 hover:text-white transition-all shadow-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>`;
        }).join('');

        totalDisp.innerText = total.toFixed(2).replace('.', ',') + " ‚Ç¨";
        subtotalDisp.innerText = total.toFixed(2).replace('.', ',') + " ‚Ç¨";
        document.getElementById('qty-display').innerText = qtyInput;
        payBtn.disabled = false;
    }

    // -- BEZAHLUNG & BONDURCK --
    window.openFinalizeModal = () => {
        const total = cart.reduce((s, i) => s + i.total, 0);
        document.getElementById('finalize-total-display').innerText = total.toFixed(2).replace('.', ',') + " ‚Ç¨";
        
        if(settings.cardfee > 0) {
            document.getElementById('card-fee-info').classList.remove('hidden');
            document.getElementById('card-fee-amount').innerText = settings.cardfee.toFixed(2);
        } else {
            document.getElementById('card-fee-info').classList.add('hidden');
        }
        
        document.getElementById('finalize-modal').style.display = 'flex';
    };

    window.processPayment = async (method) => {
        window.showLoading(true);
        let total = cart.reduce((s, i) => s + i.total, 0);
        let fee = 0;

        if(method === 'KARTE' && settings.cardfee > 0) {
            fee = settings.cardfee;
            total += fee;
        }

        const transaction = {
            items: cart,
            total: total,
            fee: fee,
            paymentMethod: method,
            timestamp: Timestamp.now()
        };

        try {
            // 1. In Firebase speichern
            await addDoc(collection(db, `users/${currentUser.uid}/transactions`), transaction);

            // 2. Bestand updaten
            if(settings.stock) {
                for(const item of cart) {
                    const pRef = doc(db, `users/${currentUser.uid}/products`, item.id);
                    const currentStock = products[item.id].stock;
                    await updateDoc(pRef, { stock: currentStock - item.quantity });
                }
                await loadProducts();
            }

            // 3. Kassenbon drucken
            window.printReceipt(transaction);

            // 4. Reset
            cart = [];
            updateCartUI();
            closeModal('finalize-modal');
            window.showToast("Verkauf abgeschlossen & Bon gedruckt");
        } catch (e) {
            window.showToast("Fehler: " + e.message, "error");
        }
        window.showLoading(false);
    };

    window.printReceipt = (t) => {
        const container = document.getElementById('print-receipt-container');
        const now = new Date();
        
        let itemsHtml = t.items.map(i => `
            <div class="receipt-line">
                <span>${i.quantity}x ${i.name}</span>
                <span>${i.total.toFixed(2)}‚Ç¨</span>
            </div>
        `).join('');

        let taxHtml = '';
        if(settings.tax) {
            const tax7 = t.items.filter(i => i.taxRate === 7).reduce((s,i) => s + (i.total - (i.total / 1.07)), 0);
            const tax19 = t.items.filter(i => i.taxRate === 19).reduce((s,i) => s + (i.total - (i.total / 1.19)), 0);
            taxHtml = `
                <div class="receipt-divider"></div>
                <div class="receipt-line"><span>MwSt 19%</span><span>${tax19.toFixed(2)}‚Ç¨</span></div>
                <div class="receipt-line"><span>MwSt 7%</span><span>${tax7.toFixed(2)}‚Ç¨</span></div>
            `;
        }

        container.innerHTML = `
            <div class="receipt-center">
                <div style="font-size:16px; font-weight:black;">${settings.companyName}</div>
                <div>${now.toLocaleDateString()} ${now.toLocaleTimeString()}</div>
            </div>
            <div class="receipt-divider"></div>
            ${itemsHtml}
            ${t.fee > 0 ? `<div class="receipt-line"><span>Kartengeb√ºhr</span><span>${t.fee.toFixed(2)}‚Ç¨</span></div>` : ''}
            <div class="receipt-divider"></div>
            <div class="receipt-line" style="font-weight:black; font-size:14px;">
                <span>GESAMT</span>
                <span>${t.total.toFixed(2)}‚Ç¨</span>
            </div>
            <div class="receipt-line" style="font-weight:bold; margin-top:2px;">
                <span>Zahlart</span>
                <span>${t.paymentMethod}</span>
            </div>
            ${taxHtml}
            <div class="receipt-divider"></div>
            <div class="receipt-center" style="margin-top:10px;">Vielen Dank f√ºr Ihren Einkauf!</div>
        `;

        window.print();
    };

    // -- PIN MODAL LOGIK --
    function handlePinInput(val) {
        if(val === 'delete') {
            tempPin = tempPin.slice(0, -1);
        } else if(tempPin.length < 4) {
            tempPin += val;
        }
        updatePinDisplay();

        if(tempPin.length === 4) {
            if(tempPin === settings.pin) {
                const action = activePinAction;
                closeModal('pin-modal');
                tempPin = "";
                if(action === 'storno_confirm') {
                    activePinAction = 'storno_confirm'; // Damit removeFromCart wei√ü, dass Pin ok
                    window.removeFromCart(window.tempStornoId);
                } else if(action === 'settings') {
                    window.openSettingsModal();
                } else if(action === 'reports') {
                    window.openReportModal();
                }
            } else {
                window.showToast("Falscher Pin!", "error");
                tempPin = "";
                updatePinDisplay();
            }
        }
    }

    function updatePinDisplay() {
        const dots = document.getElementById('pin-display').children;
        for(let i=0; i<4; i++) {
            dots[i].className = i < tempPin.length ? 'w-4 h-4 rounded-full bg-blue-500 shadow-lg shadow-blue-500/50' : 'w-4 h-4 rounded-full bg-white/10 border border-white/20';
        }
    }

    // -- SETTINGS REITER & TABS --
    window.openSettingsModalAuth = () => {
        if(settings.security) {
            activePinAction = 'settings';
            tempPin = "";
            document.getElementById('pin-modal').style.display = 'flex';
            updatePinDisplay();
        } else {
            window.openSettingsModal();
        }
    };

    window.openSettingsModal = () => {
        document.getElementById('settings-modal').style.display = 'flex';
        switchSettingsTab('inventory');
    };

    window.switchSettingsTab = (tab) => {
        document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active', 'bg-blue-600', 'text-white'));
        const activeBtn = document.getElementById('tab-' + tab);
        activeBtn.classList.add('active', 'bg-blue-600', 'text-white');
        
        const area = document.getElementById('settings-content-area');
        if(tab === 'inventory') renderInventoryTab(area);
        if(tab === 'cats') renderCatsTab(area);
        if(tab === 'config') renderConfigTab(area);
    };

    function renderInventoryTab(area) {
        area.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Produkte verwalten</h3>
                <button onclick="window.openProductModal()" class="bg-blue-600 text-white px-6 py-2 rounded-xl font-bold">+ Neu</button>
            </div>
            <table class="w-full text-left">
                <thead class="text-gray-400 text-xs uppercase border-b border-gray-100"><tr class="h-10"><th>Produkt</th><th>Preis</th><th>Bestand</th><th>MwSt</th><th>Aktionen</th></tr></thead>
                <tbody class="divide-y divide-gray-50">
                    ${Object.values(products).map(p => `
                        <tr class="h-12 text-sm font-medium">
                            <td>${p.name}</td>
                            <td>${p.price.toFixed(2)}‚Ç¨</td>
                            <td>${p.stock}</td>
                            <td>${p.tax}%</td>
                            <td class="flex gap-2 h-12 items-center">
                                <button onclick="window.openProductModal('${p.id}')" class="text-blue-500">Edit</button>
                                <button onclick="window.deleteProduct('${p.id}')" class="text-red-500">L√∂schen</button>
                            </td>
                        </tr>`).join('')}
                </tbody>
            </table>`;
    }

    window.openProductModal = (id = null) => {
        const modal = document.getElementById('product-modal');
        const form = document.getElementById('product-form');
        const catSelect = document.getElementById('p-category');
        catSelect.innerHTML = Object.values(categories).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        
        if(id) {
            const p = products[id];
            document.getElementById('product-modal-title').innerText = "Produkt bearbeiten";
            document.getElementById('edit-product-id').value = id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-category').value = p.categoryId;
            document.getElementById('p-stock').value = p.stock;
            document.getElementById('p-ean').value = p.ean || '';
            document.getElementById('p-tax').value = p.tax || 19;
            document.getElementById('p-color').value = p.color || '#3b82f6';
        } else {
            form.reset();
            document.getElementById('product-modal-title').innerText = "Neues Produkt";
            document.getElementById('edit-product-id').value = "";
        }
        modal.style.display = 'flex';
    };

    document.getElementById('product-form').onsubmit = async (e) => {
        e.preventDefault();
        window.showLoading(true);
        const id = document.getElementById('edit-product-id').value;
        const data = {
            name: document.getElementById('p-name').value,
            price: parseFloat(document.getElementById('p-price').value),
            categoryId: document.getElementById('p-category').value,
            stock: parseInt(document.getElementById('p-stock').value),
            ean: document.getElementById('p-ean').value,
            tax: parseInt(document.getElementById('p-tax').value),
            color: document.getElementById('p-color').value
        };
        
        if(id) await updateDoc(doc(db, `users/${currentUser.uid}/products`, id), data);
        else await addDoc(collection(db, `users/${currentUser.uid}/products`), data);
        
        await loadProducts();
        closeModal('product-modal');
        window.showLoading(false);
    };

    window.deleteProduct = async (id) => {
        if(confirm("L√∂schen?")) {
            await deleteDoc(doc(db, `users/${currentUser.uid}/products`, id));
            await loadProducts();
            switchSettingsTab('inventory');
        }
    };

    // -- BERICHTE --
    window.openReportModalAuth = () => {
        if(settings.security) {
            activePinAction = 'reports';
            tempPin = "";
            document.getElementById('pin-modal').style.display = 'flex';
            updatePinDisplay();
        } else {
            window.openReportModal();
        }
    };

    window.openReportModal = async () => {
        window.showLoading(true);
        const reportArea = `
            <div id="report-modal" class="modal-backdrop z-[4500]" style="display:flex;">
                <div class="bg-white w-full max-w-4xl p-8 rounded-3xl h-[80vh] flex flex-col shadow-2xl">
                    <div class="flex justify-between mb-6">
                        <h2 class="text-3xl font-black">Tagesbericht</h2>
                        <button onclick="this.closest('.modal-backdrop').remove()" class="text-gray-400 font-bold">Schlie√üen</button>
                    </div>
                    <div id="report-content" class="flex-grow overflow-y-auto whitespace-pre-wrap font-mono text-sm bg-gray-50 p-6 rounded-2xl border border-gray-100">Lade...</div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', reportArea);
        
        const start = new Date(); start.setHours(0,0,0,0);
        const snap = await getDocs(query(collection(db, `users/${currentUser.uid}/transactions`), where("timestamp", ">=", Timestamp.fromDate(start)), orderBy("timestamp", "desc")));
        
        let txt = "";
        let total = 0, cash = 0, card = 0;
        snap.forEach(d => {
            const t = d.data();
            total += t.total;
            if(t.paymentMethod === 'BAR') cash += t.total;
            else card += t.total;
            txt += `${t.timestamp.toDate().toLocaleTimeString()} | ${t.total.toFixed(2)}‚Ç¨ (${t.paymentMethod})\n`;
        });
        
        document.getElementById('report-content').innerText = `UMSATZ HEUTE: ${total.toFixed(2)}‚Ç¨\nBar: ${cash.toFixed(2)}‚Ç¨ | Karte: ${card.toFixed(2)}‚Ç¨\n\nDETAILS:\n${txt}`;
        window.showLoading(false);
    };

    // -- INITIAL HELPERS --
    window.handleLogout = () => signOut(auth);
    window.clearCart = () => { cart = []; updateCartUI(); window.showToast("Bon geleert", "info"); };
    
    document.getElementById('login-form').onsubmit = (e) => {
        e.preventDefault();
        signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value).catch(e=>window.showToast(e.message, 'error'));
    };
    document.getElementById('register-form').onsubmit = (e) => {
        e.preventDefault();
        createUserWithEmailAndPassword(auth, document.getElementById('register-email').value, document.getElementById('register-password').value).catch(e=>window.showToast(e.message, 'error'));
    };
    document.getElementById('reset-form').onsubmit = (e) => {
        e.preventDefault();
        sendPasswordResetEmail(auth, document.getElementById('reset-email').value).then(()=>window.showToast("Email gesendet")).catch(e=>window.showToast(e.message, 'error'));
    };
    
    document.getElementById('search-input').oninput = () => renderMainGrid();

    function renderTabs() {
        const container = document.getElementById('category-tabs');
        container.innerHTML = `<button onclick="window.renderMainGrid()" class="px-5 py-2.5 bg-gray-900 text-white rounded-xl font-bold text-sm shadow-lg shadow-gray-200 transition-all active:scale-95 whitespace-nowrap">Alle Artikel</button>`;
        Object.values(categories).forEach(c => {
            const b = document.createElement('button');
            b.className = "px-5 py-2.5 bg-white border border-gray-200 text-gray-600 rounded-xl font-bold text-sm shadow-sm hover:bg-gray-50 transition-all active:scale-95 whitespace-nowrap";
            b.innerText = c.name;
            b.onclick = () => window.renderMainGrid(c.id);
            container.appendChild(b);
        });
    }

    // -- WINDOW GLOBALS F√úR HTML ONCLICK --
    window.handlePinInput = handlePinInput;
    window.renderMainGrid = renderMainGrid;
    window.closeModal = closeModal;
  </script>
</body>
</html>
