<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Kassensystem FH-Erfurt | Professional</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; user-select: none; }
    #receipt-content-interactive { overflow-y: auto; max-height: 40vh; }
    .product-btn:active { transform: scale(0.98); }
    /* Numpad Styling */
    .numpad-btn { 
        height: 55px; 
        display:flex; 
        justify-content:center; 
        align-items:center; 
        border-radius: 12px; 
        font-weight: 800; 
        transition: all 0.1s; 
        border: 1px solid #e5e7eb;
        background: white;
    }
    .numpad-btn:active { transform: scale(0.92); background-color: #f3f4f6; }
    .numpad-special { background-color: #eff6ff; color: #1d4ed8; border-color: #dbeafe; }
    
    #async-loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; }
    .spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #b91c1c; border-radius: 50%; width:40px; height:40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    /* Toast Container für stapelbare Nachrichten */
    #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 10000; display: flex; flex-direction: column; gap: 0.75rem; pointer-events: none; }
    .toast { background: #1f2937; color: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out; pointer-events: auto; font-weight: 600; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    @media print {
      body * { visibility: hidden !important; }
      #print-receipt-container { visibility: visible !important; display: block !important; position: absolute !important; left: 0 !important; top: 0 !important; width: 80mm !important; }
    }
  </style>
</head>
<body class="min-h-screen">

  <div id="toast-container"></div>
  <div id="async-loading-overlay"><div class="spinner"></div></div>

  <div id="login-modal" class="fixed inset-0 bg-white z-[5000] flex items-center justify-center p-4">
    <div class="max-w-md w-full p-8 border rounded-3xl shadow-2xl bg-white">
      <h1 class="text-4xl font-black text-center text-red-600 mb-8 uppercase tracking-tighter">Kassensystem</h1>
      <form id="login-form">
        <input type="email" id="login-email" placeholder="E-Mail" class="w-full p-4 mb-3 bg-gray-50 rounded-2xl border focus:ring-2 focus:ring-red-500 outline-none" required>
        <input type="password" id="login-password" placeholder="Passwort" class="w-full p-4 mb-6 bg-gray-50 rounded-2xl border focus:ring-2 focus:ring-red-500 outline-none" required>
        <button type="submit" class="w-full bg-red-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-red-700 transition-colors">ANMELDEN</button>
        <div class="flex justify-between mt-6">
            <button type="button" onclick="window.updateAppView('register')" class="text-gray-400 font-bold text-xs uppercase tracking-widest hover:text-red-500">Registrieren</button>
            <button type="button" onclick="window.updateAppView('reset')" class="text-gray-400 font-bold text-xs uppercase tracking-widest hover:text-red-500">Passwort vergessen?</button>
        </div>
      </form>
    </div>
  </div>

  <div id="register-modal" class="fixed inset-0 bg-white z-[5000] hidden flex items-center justify-center p-4">
    <div class="max-w-md w-full p-8 border rounded-3xl shadow-2xl bg-white">
      <h2 class="text-2xl font-black mb-6 uppercase">Neues Konto</h2>
      <form id="register-form">
        <input type="email" id="reg-email" placeholder="E-Mail" class="w-full p-4 mb-3 bg-gray-50 rounded-2xl border" required>
        <input type="password" id="reg-password" placeholder="Passwort (min. 6 Zeichen)" class="w-full p-4 mb-4 bg-gray-50 rounded-2xl border" required>
        
        <label class="block text-[10px] font-black text-gray-400 mb-1 ml-1 uppercase tracking-widest">Wähle dein Kassen-Modul</label>
        <select id="reg-system-type" class="w-full p-4 mb-8 bg-gray-50 rounded-2xl border font-bold text-gray-700 focus:ring-2 focus:ring-indigo-500 outline-none cursor-pointer">
          <option value="complete">Professional (Vollversion inkl. MwSt & Berichte)</option>
          <option value="simple">Light (Schnellkasse, reduzierte Ansicht)</option>
        </select>
        
        <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg">KONTO ERSTELLEN</button>
        <button type="button" onclick="window.updateAppView('login')" class="w-full mt-4 text-gray-400 font-bold text-xs uppercase tracking-widest text-center">Zurück zum Login</button>
      </form>
    </div>
  </div>

  <div id="kasse-content" class="hidden min-h-screen flex flex-col md:flex-row gap-4 p-4">
    <div class="flex-1 flex flex-col min-h-0">
      <div id="category-container" class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
          </div>
      <div id="product-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 overflow-y-auto pr-2">
          </div>
    </div>

    <div class="w-full md:w-[480px] bg-white rounded-3xl shadow-xl flex flex-col p-6 border">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-black uppercase tracking-tighter text-gray-800">Aktueller Bon</h2>
        <button onclick="window.clearCart()" class="text-[10px] bg-red-50 text-red-600 px-4 py-2 rounded-full font-black hover:bg-red-100 transition-colors uppercase tracking-widest">AC / LEEREN</button>
      </div>

      <div id="receipt-content-interactive" class="flex-1 space-y-2 mb-4 border-b border-dashed pb-4">
          </div>

      <div class="grid grid-cols-5 gap-1.5 mb-4">
        <button onclick="window.handleQuantityInput('7')" class="numpad-btn">7</button>
        <button onclick="window.handleQuantityInput('8')" class="numpad-btn">8</button>
        <button onclick="window.handleQuantityInput('9')" class="numpad-btn">9</button>
        <button onclick="window.handleQuantityInput('11')" class="numpad-btn numpad-special">11</button>
        <button onclick="window.handleQuantityInput('12')" class="numpad-btn numpad-special">12</button>
        
        <button onclick="window.handleQuantityInput('4')" class="numpad-btn">4</button>
        <button onclick="window.handleQuantityInput('5')" class="numpad-btn">5</button>
        <button onclick="window.handleQuantityInput('6')" class="numpad-btn">6</button>
        <button onclick="window.handleQuantityInput('13')" class="numpad-btn numpad-special">13</button>
        <button onclick="window.handleQuantityInput('14')" class="numpad-btn numpad-special">14</button>
        
        <button onclick="window.handleQuantityInput('1')" class="numpad-btn">1</button>
        <button onclick="window.handleQuantityInput('2')" class="numpad-btn">2</button>
        <button onclick="window.handleQuantityInput('3')" class="numpad-btn">3</button>
        <button onclick="window.handleQuantityInput('15')" class="numpad-btn numpad-special">15</button>
        <button onclick="window.handleQuantityInput('16')" class="numpad-btn numpad-special">16</button>
        
        <button onclick="window.handleQuantityInput('clear')" class="numpad-btn bg-red-600 text-white border-none">C</button>
        <button onclick="window.handleQuantityInput('0')" class="numpad-btn">0</button>
        <button onclick="window.toggleQuantityMode()" id="qty-mode-btn" class="numpad-btn bg-green-600 text-white border-none text-[10px]">ADD</button>
        <button onclick="window.handleQuantityInput('17')" class="numpad-btn numpad-special">17</button>
        <button onclick="window.handleQuantityInput('18')" class="numpad-btn numpad-special">18</button>
        
        <button onclick="window.handleQuantityInput('19')" class="numpad-btn numpad-special col-span-5 mt-1">19</button>
      </div>

      <div class="bg-gray-50 p-5 rounded-3xl mb-4 border border-gray-100">
        <div class="flex justify-between items-center mb-1">
          <span class="text-[10px] font-black uppercase text-gray-400 tracking-widest">Eingabe-Menge</span>
          <span id="qty-display" class="text-2xl font-black text-red-600">1</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="text-[10px] font-black uppercase text-gray-400 tracking-widest">Gesamtbetrag</span>
          <span id="grand-total" class="text-4xl font-black text-gray-800">0,00 €</span>
        </div>
      </div>

      <button onclick="window.openPaymentModal()" class="w-full bg-red-600 text-white py-6 rounded-3xl font-black text-xl shadow-xl hover:bg-red-700 transition-all active:scale-95 uppercase tracking-tighter">Zahlung abschließen</button>
      
      <div class="grid grid-cols-2 gap-3 mt-4">
        <button onclick="window.openSettings()" class="py-3 text-[10px] font-black uppercase text-gray-400 text-center border rounded-2xl hover:bg-gray-50">Einstellungen</button>
        <button onclick="window.openReports()" class="py-3 text-[10px] font-black uppercase text-gray-400 text-center border rounded-2xl hover:bg-gray-50">Berichte / Storno</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, where, orderBy, onSnapshot, addDoc, Timestamp, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // DEINE FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
      authDomain: "kassensystem-85412.firebaseapp.com",
      projectId: "kassensystem-85412",
      storageBucket: "kassensystem-85412.appspot.com",
      messagingSenderId: "367332219717",
      appId: "1:367332219717:web:867a5c76046e7f91c9fdb8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let cart = [];
    let currentInput = "";
    let systemType = "complete"; 
    let isAddMode = true;

    // --- UTILS ---
    window.showToast = (msg) => {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerText = msg;
      container.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 3000);
    };

    window.updateAppView = (view) => {
      ['login-modal', 'register-modal', 'kasse-content'].forEach(id => {
          const el = document.getElementById(id);
          if(el) el.classList.add('hidden');
      });
      const target = document.getElementById(view + (view === 'kasse' ? '-content' : '-modal'));
      if(target) target.classList.remove('hidden');
    };

    // --- NUMPAD & MENGE ---
    window.handleQuantityInput = (val) => {
      if(val === 'clear') {
          currentInput = "";
      } else {
          currentInput = val; // Direktes Setzen für Tasten 0-19
      }
      document.getElementById('qty-display').innerText = currentInput || "1";
    };

    window.toggleQuantityMode = () => {
        isAddMode = !isAddMode;
        const btn = document.getElementById('qty-mode-btn');
        btn.innerText = isAddMode ? "ADD" : "REM";
        btn.className = isAddMode ? "numpad-btn bg-green-600 text-white border-none text-[10px]" : "numpad-btn bg-orange-500 text-white border-none text-[10px]";
    };

    // --- WARENKORB LOGIK ---
    window.addToCart = (product) => {
        const qty = parseInt(currentInput) || 1;
        const existing = cart.find(i => i.id === product.id);
        
        if(isAddMode) {
            if(existing) existing.amount += qty;
            else cart.push({...product, amount: qty});
        } else {
            if(existing) {
                existing.amount -= qty;
                if(existing.amount <= 0) cart = cart.filter(i => i.id !== product.id);
            }
        }
        
        currentInput = "";
        renderCart();
    };

    // Klick auf Item im Bon zum Bearbeiten mit Numpad-Zahl
    window.editCartItem = (index) => {
        const qty = parseInt(currentInput);
        if(!isNaN(qty)) {
            if(qty === 0) cart.splice(index, 1);
            else cart[index].amount = qty;
            currentInput = "";
            renderCart();
        } else {
            // Standard: -1 falls keine Zahl getippt wurde
            if(cart[index].amount > 1) cart[index].amount--;
            else cart.splice(index, 1);
            renderCart();
        }
    };

    function renderCart() {
        const container = document.getElementById('receipt-content-interactive');
        const totalDisp = document.getElementById('grand-total');
        document.getElementById('qty-display').innerText = currentInput || "1";
        
        if(cart.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-300 mt-10 italic font-medium">Bon ist leer</p>';
            totalDisp.innerText = "0,00 €";
            return;
        }

        let sum = 0;
        container.innerHTML = cart.map((item, i) => {
            const lineTotal = item.price * item.amount;
            sum += lineTotal;
            return `
                <div onclick="window.editCartItem(${i})" class="flex justify-between items-center p-4 bg-white border border-gray-100 rounded-2xl hover:bg-red-50 cursor-pointer transition-all">
                    <div class="flex items-center gap-3">
                        <span class="w-10 h-10 bg-gray-100 flex items-center justify-center rounded-xl font-black text-gray-600 text-xs">${item.amount}x</span>
                        <span class="font-bold text-gray-700">${item.name}</span>
                    </div>
                    <span class="font-black text-gray-900">${lineTotal.toFixed(2)} €</span>
                </div>`;
        }).join('');
        totalDisp.innerText = sum.toFixed(2).replace('.', ',') + " €";
    }

    // --- AUTH LISTENERS & FIREBASE INTEGRATION ---
    onAuthStateChanged(auth, async (user) => {
      if(user) {
        currentUser = user;
        // Lade System-Typ aus Firestore
        const sDoc = await getDoc(doc(db, "users", user.uid, "settings", "general"));
        if(sDoc.exists()) systemType = sDoc.data().systemType || "complete";
        
        window.updateAppView('kasse');
        loadData(); // Deine Original-Ladefunktion für Produkte
      } else {
        window.updateAppView('login');
      }
    });

    // --- FIREBASE AKTIONEN ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value);
            window.showToast("Erfolgreich angemeldet!");
        } catch(err) { window.showToast("Fehler: " + err.message); }
    });

    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-password').value;
        const type = document.getElementById('reg-system-type').value;

        try {
            const res = await createUserWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "users", res.user.uid, "settings", "general"), { systemType: type });
            window.showToast("Konto erstellt!");
        } catch(err) { window.showToast("Fehler: " + err.message); }
    });

    // Daten-Lader (Platzhalter für deine Logik)
    function loadData() {
        if(!currentUser) return;
        const q = query(collection(db, `users/${currentUser.uid}/products`), orderBy("name"));
        onSnapshot(q, (snap) => {
            const cont = document.getElementById('product-container');
            cont.innerHTML = "";
            snap.forEach(docSnap => {
                const p = { id: docSnap.id, ...docSnap.data() };
                const b = document.createElement('button');
                b.className = "product-btn p-5 bg-white border border-gray-200 rounded-3xl shadow-sm text-left hover:border-red-500 transition-all";
                b.innerHTML = `<div class="text-[10px] font-black text-gray-400 uppercase mb-1 tracking-widest">${p.category || 'Allgemein'}</div>
                               <div class="font-bold text-gray-800 leading-tight mb-2">${p.name}</div>
                               <div class="text-xl font-black text-red-600">${p.price.toFixed(2)} €</div>`;
                b.onclick = () => window.addToCart(p);
                cont.appendChild(b);
            });
        });
    }

    window.clearCart = () => { cart = []; renderCart(); window.showToast("Bon geleert"); };
    window.renderCart = renderCart;
    renderCart();

  </script>
</body>
</html>
