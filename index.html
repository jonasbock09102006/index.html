<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Kassensystem FH-Erfurt | Professional</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; user-select: none; }
    #receipt-content-interactive { overflow-y: auto; max-height: 45vh; }
    .product-btn:active { transform: scale(0.95); }
    .numpad-btn { height: 50px; display:flex; justify-content:center; align-items:center; border-radius: 8px; font-weight: bold; border: 1px solid #e5e7eb; transition: 0.1s; background: white; }
    .numpad-btn:active { background-color: #f3f4f6; transform: scale(0.95); }
    
    #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 10000; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; }
    .toast { background: #1f2937; color: white; padding: 0.75rem 1.25rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease-out; pointer-events: auto; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    #async-loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; }
    .spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #b91c1c; border-radius: 50%; width:40px; height:40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    @media print {
      body * { visibility: hidden !important; }
      #print-receipt-container { visibility: visible !important; display: block !important; position: absolute !important; left: 0 !important; top: 0 !important; width: 80mm !important; font-family: 'Courier New', Courier, monospace !important; font-size: 12px !important; color: #000 !important; }
    }
  </style>
</head>
<body class="min-h-screen">

  <div id="toast-container"></div>
  <div id="async-loading-overlay"><div class="spinner"></div></div>

  <div id="register-modal" class="fixed inset-0 bg-white z-[5000] hidden flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-3xl shadow-2xl p-8 border">
      <h2 class="text-2xl font-bold mb-4">Konto erstellen</h2>
      <form id="register-form">
        <input type="email" id="reg-email" placeholder="E-Mail" class="w-full p-4 mb-3 bg-gray-50 rounded-2xl border" required>
        <input type="password" id="reg-password" placeholder="Passwort" class="w-full p-4 mb-3 bg-gray-50 rounded-2xl border" required>
        
        <label class="block text-xs font-bold text-gray-400 mb-2 uppercase ml-1">Kassentyp w√§hlen</label>
        <select id="reg-system-type" class="w-full p-4 mb-6 bg-gray-50 rounded-2xl border font-bold">
          <option value="complete">Vollst√§ndig (Alle Funktionen + PIN)</option>
          <option value="simple">Einfach (Schnell-Kasse, kein PIN)</option>
        </select>
        
        <button type="submit" class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold">Registrieren</button>
        <button type="button" onclick="window.updateAppView('login')" class="w-full mt-4 text-gray-400 font-bold">Zur√ºck zum Login</button>
      </form>
    </div>
  </div>

  <div id="login-modal" class="fixed inset-0 bg-white z-[5000] flex items-center justify-center p-4">
    <div class="max-w-md w-full p-8">
      <h1 class="text-4xl font-black text-center text-red-600 mb-8 uppercase tracking-tighter">Kassensystem</h1>
      <form id="login-form">
        <input type="email" id="login-email" placeholder="E-Mail" class="w-full p-4 mb-3 bg-gray-50 rounded-2xl border" required>
        <input type="password" id="login-password" placeholder="Passwort" class="w-full p-4 mb-6 bg-gray-50 rounded-2xl border" required>
        <button type="submit" class="w-full bg-red-600 text-white py-4 rounded-2xl font-bold shadow-lg">Anmelden</button>
        <button type="button" onclick="window.updateAppView('register')" class="w-full mt-4 text-gray-400 font-bold text-xs uppercase tracking-widest">Neues Konto erstellen</button>
      </form>
    </div>
  </div>

  <div id="kasse-content" class="hidden min-h-screen flex flex-col md:flex-row gap-4 p-4">
    <div class="flex-1 flex flex-col min-h-0">
      <div id="category-tabs" class="flex gap-2 mb-4 overflow-x-auto pb-2 no-scrollbar">
        </div>
      <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 overflow-y-auto">
        </div>
    </div>

    <div class="w-full md:w-[450px] bg-white rounded-3xl shadow-xl flex flex-col p-6 border">
      <h2 class="text-xl font-black mb-4 uppercase">Aktueller Bon</h2>
      
      <div id="receipt-content-interactive" class="flex-1 space-y-2 mb-4 border-b pb-4">
        <p class="text-center text-gray-300 mt-10 italic">Warenkorb leer</p>
      </div>

      <div class="grid grid-cols-5 gap-1 mb-4">
        <button onclick="window.handleQuantityInput('7')" class="numpad-btn">7</button>
        <button onclick="window.handleQuantityInput('8')" class="numpad-btn">8</button>
        <button onclick="window.handleQuantityInput('9')" class="numpad-btn">9</button>
        <button onclick="window.handleQuantityInput('11')" class="numpad-btn bg-blue-50 text-blue-600">11</button>
        <button onclick="window.handleQuantityInput('12')" class="numpad-btn bg-blue-50 text-blue-600">12</button>
        <button onclick="window.handleQuantityInput('19')" class="numpad-btn bg-blue-50 text-blue-600 col-span-5 mt-1">19</button>
      </div>

      <div class="bg-gray-50 p-4 rounded-2xl mb-4">
        <div class="flex justify-between text-xs font-bold text-gray-400 uppercase mb-1">
          <span>Menge</span>
          <span id="qty-display" class="text-red-600">1</span>
        </div>
        <div class="flex justify-between items-center">
          <span class="font-black text-gray-800">GESAMT</span>
          <span id="total-display" class="text-3xl font-black text-red-600">0,00 ‚Ç¨</span>
        </div>
      </div>

      <button onclick="window.openFinalizeModal()" id="btn-finalize" class="w-full bg-green-600 text-white py-5 rounded-3xl font-bold text-xl shadow-lg mb-2">BEZAHLEN</button>
      
      <div class="grid grid-cols-2 gap-2">
        <button onclick="window.openSettingsModal()" class="py-3 text-[10px] font-bold uppercase text-gray-500 border rounded-xl">‚öôÔ∏è Einstellungen</button>
        <button onclick="window.openReportModal()" class="py-3 text-[10px] font-bold uppercase text-gray-500 border rounded-xl">üìä Bericht/Storno</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // Deine Konfiguration
    const firebaseConfig = {
      apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
      authDomain: "kassensystem-85412.firebaseapp.com",
      projectId: "kassensystem-85412",
      storageBucket: "kassensystem-85412.appspot.com",
      messagingSenderId: "367332219717",
      appId: "1:367332219717:web:867a5c76046e7f91c9fdb8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let cart = [];
    let currentInput = "";

    // --- PRODUKTE LADEN (Fix f√ºr leeres Grid) ---
    function loadProducts() {
      if(!currentUser) return;
      const q = query(collection(db, `users/${currentUser.uid}/products`), orderBy("name"));
      onSnapshot(q, (snapshot) => {
        const grid = document.getElementById('product-grid');
        grid.innerHTML = "";
        snapshot.forEach(doc => {
          const p = { id: doc.id, ...doc.data() };
          const btn = document.createElement('button');
          btn.className = "product-btn p-4 bg-white border rounded-2xl shadow-sm text-left hover:border-red-500 transition-all";
          btn.innerHTML = `<div class="font-bold text-sm">${p.name}</div><div class="text-red-600 font-black">${p.price.toFixed(2)} ‚Ç¨</div>`;
          btn.onclick = () => window.addToCart(p);
          grid.appendChild(btn);
        });
      });
    }

    // --- WARENKORB & RENDERING ---
    window.addToCart = (p) => {
      const qty = parseInt(currentInput) || 1;
      const exist = cart.find(i => i.id === p.id);
      if(exist) exist.amount += qty;
      else cart.push({...p, amount: qty});
      currentInput = "";
      renderCart();
    };

    function renderCart() {
      const container = document.getElementById('receipt-content-interactive');
      const totalDisp = document.getElementById('total-display');
      const qtyDisp = document.getElementById('qty-display');
      
      qtyDisp.innerText = currentInput || "1";
      
      if(cart.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-300 mt-10 italic">Warenkorb leer</p>';
        totalDisp.innerText = "0,00 ‚Ç¨";
        return;
      }

      let total = 0;
      container.innerHTML = cart.map((item, idx) => {
        const lineTotal = item.price * item.amount;
        total += lineTotal;
        return `<div onclick="window.editCartItem(${idx})" class="flex justify-between p-3 bg-gray-50 rounded-xl border">
                  <span><b>${item.amount}x</b> ${item.name}</span>
                  <span class="font-bold">${lineTotal.toFixed(2)} ‚Ç¨</span>
                </div>`;
      }).join('');
      totalDisp.innerText = total.toFixed(2).replace('.', ',') + " ‚Ç¨";
    }

    // --- NAVIGATION & AUTH ---
    onAuthStateChanged(auth, (user) => {
      if(user) {
        currentUser = user;
        window.updateAppView('kasse');
        loadProducts();
      } else {
        window.updateAppView('login');
      }
    });

    window.updateAppView = (view) => {
      document.getElementById('login-modal').classList.add('hidden');
      document.getElementById('register-modal').classList.add('hidden');
      document.getElementById('kasse-content').classList.add('hidden');
      document.getElementById(view + (view === 'kasse' ? '-content' : '-modal')).classList.remove('hidden');
    };

    // Initialisierung
    window.handleQuantityInput = (val) => { currentInput = (val === 'clear' ? '' : val); renderCart(); };
    renderCart();

  </script>
</body>
</html>
