<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kassensystem — Auswertungen (Modal) + Firestore</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f7f7f7 }
    .toast { padding:.6rem .9rem; border-radius:.45rem; color:#fff; margin-bottom:.5rem; opacity:0; transition:opacity .2s }
    .toast-success{ background:#16a34a } .toast-error{ background:#dc2626 } .toast-info{ background:#2563eb }
    #async-loading-overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,0.8); z-index:2000 }
    .spinner{ width:40px; height:40px; border-radius:50%; border:4px solid rgba(0,0,0,0.1); border-top-color:#b91c1c; animation:spin 1s linear infinite }
    @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .receipt-print{ font-family:monospace; font-size:10px }
    @media print{ body *{ visibility:hidden } .receipt-print, .receipt-print *{ visibility:visible } .receipt-print{ position: absolute; left:0; top:0 } }
  </style>
</head>
<body class="p-4">

  <!-- Loading & Toast -->
  <div id="toast-container" style="position:fixed; right:1rem; top:1rem; z-index:3000"></div>
  <div id="async-loading-overlay"><div class="spinner"></div></div>

  <!-- LOGIN / REGISTER MODALS (kept simple) -->
  <div id="login-modal" class="fixed inset-0 z-40 bg-black/70 flex items-center justify-center" style="display:flex">
    <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-lg">
      <h1 class="text-2xl font-bold text-center text-red-700 mb-2">Kassensystem</h1>
      <form onsubmit="event.preventDefault(); handleLoginSubmit()">
        <label class="block text-sm">E-Mail</label>
        <input id="login-email" type="email" required class="w-full p-2 border rounded mb-2" />
        <label class="block text-sm">Passwort</label>
        <input id="login-password" type="password" required class="w-full p-2 border rounded mb-4" />
        <div class="flex gap-2">
          <button type="submit" class="bg-red-600 text-white p-2 rounded flex-1">Anmelden</button>
          <button type="button" onclick="openRegistrationModal()" class="bg-gray-200 p-2 rounded">Registrieren</button>
        </div>
      </form>
      <div class="mt-3 text-sm text-center">
        <button onclick="openForgotPasswordModal()" class="text-blue-600">Passwort vergessen?</button>
      </div>
    </div>
  </div>

  <div id="registration-modal" style="display:none" class="fixed inset-0 z-40 bg-black/70 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-lg">
      <h2 class="text-xl font-bold mb-2">Registrieren</h2>
      <form onsubmit="event.preventDefault(); handleRegisterSubmit()">
        <label class="block text-sm">E-Mail</label>
        <input id="register-email" type="email" required class="w-full p-2 border rounded mb-2" />
        <label class="block text-sm">Passwort</label>
        <input id="register-password" type="password" minlength="6" required class="w-full p-2 border rounded mb-4" />
        <div class="flex gap-2">
          <button type="submit" class="bg-green-600 text-white p-2 rounded flex-1">Erstellen</button>
          <button type="button" onclick="closeModal('registration-modal'); openLoginModal()" class="bg-gray-200 p-2 rounded">Zurück</button>
        </div>
      </form>
    </div>
  </div>

  <div id="forgot-password-modal" style="display:none" class="fixed inset-0 z-40 bg-black/50 flex items-center justify-center">
    <div class="bg-white p-6 rounded shadow w-full max-w-sm">
      <h3 class="font-bold mb-2">Passwort zurücksetzen</h3>
      <form onsubmit="event.preventDefault(); handlePasswordReset()">
        <input id="reset-email" type="email" required class="w-full p-2 border rounded mb-3" placeholder="E-Mail eingeben" />
        <div class="flex gap-2">
          <button type="submit" class="bg-blue-600 text-white p-2 rounded flex-1">Link senden</button>
          <button type="button" onclick="closeModal('forgot-password-modal'); openLoginModal()" class="bg-gray-200 p-2 rounded">Abbrechen</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="kasse-content" style="display:none">
    <header class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold text-red-700">Kassensystem</h1>
      <div class="flex items-center gap-2">
        <button onclick="openReportModal()" class="bg-blue-600 text-white px-3 py-2 rounded">Auswertungen</button>
        <button onclick="openProductModal()" class="bg-indigo-600 text-white px-3 py-2 rounded">Produkte</button>
        <button onclick="openTransactionReversalModal()" class="bg-red-700 text-white px-3 py-2 rounded">Stornieren</button>
        <button id="logoutBtn" onclick="handleLogout()" class="bg-gray-200 px-3 py-2 rounded">Logout</button>
      </div>
    </header>

    <!-- simplified UI: product grid + receipt area -->
    <div class="grid grid-cols-3 gap-4">
      <div class="col-span-2">
        <div id="category-tabs" class="flex gap-2 mb-3"></div>
        <div id="product-grid" class="grid grid-cols-3 gap-3"></div>
      </div>

      <div>
        <div class="bg-white p-3 rounded shadow">
          <h3 class="font-bold mb-2">Aktueller Bon</h3>
          <div id="receipt-content-interactive" class="min-h-[200px] text-sm"></div>
          <div class="mt-3 text-right font-extrabold" id="total-display">GESAMT: 0,00 €</div>
          <div class="mt-3 flex gap-2">
            <button onclick="openFinalizeModal()" class="bg-green-600 text-white px-3 py-2 rounded flex-1">Zur Zahlung</button>
            <button onclick="resetBestellung()" class="bg-gray-200 px-3 py-2 rounded">Neu</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div id="product-modal" style="display:none" class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4">
    <div class="bg-white p-4 rounded shadow w-full max-w-2xl max-h-[90vh] overflow-auto">
      <h3 class="font-bold mb-2">Produkte / Kategorien</h3>
      <div class="mb-4">
        <input id="new-category-name" placeholder="Neue Kategorie" class="p-2 border rounded mr-2" />
        <button onclick="addCategory()" class="bg-indigo-600 text-white px-3 py-1 rounded">Kategorie</button>
      </div>
      <div class="mb-4 grid grid-cols-5 gap-2">
        <input id="new-product-name" placeholder="Produktname" class="col-span-2 p-2 border rounded" />
        <input id="new-product-price" type="number" step="0.01" placeholder="Preis" class="p-2 border rounded" />
        <select id="new-product-category" class="p-2 border rounded"></select>
        <button onclick="addProduct()" class="bg-green-600 text-white px-3 py-1 rounded">Produkt</button>
      </div>
      <div id="category-list" class="space-y-2 mb-4"></div>
      <div id="product-list" class="space-y-2"></div>
      <div class="text-right mt-3"><button onclick="closeModal('product-modal')" class="bg-gray-200 px-3 py-1 rounded">Schließen</button></div>
    </div>
  </div>

  <!-- Finalize modal (kept minimal) -->
  <div id="finalize-modal" style="display:none" class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4">
    <div class="bg-white p-4 rounded shadow w-full max-w-md">
      <h3 class="font-bold mb-2">Zahlung abschließen</h3>
      <div class="mb-2">Gesamt: <span id="finalize-total" class="font-extrabold">0,00 €</span></div>
      <div class="mb-2">
        <label class="block text-sm">Bezahlt (EUR)</label>
        <input id="cash-received-display" class="w-full p-2 border rounded mb-2" value="0,00" />
      </div>
      <div class="flex gap-2">
        <button onclick="handleFinalizeAction('BAR','standard')" class="bg-green-600 text-white px-3 py-2 rounded flex-1">BAR + Bon</button>
        <button onclick="handleFinalizeAction('KARTE','standard')" class="bg-indigo-600 text-white px-3 py-2 rounded">Karte</button>
      </div>
      <div class="mt-3 text-right"><button onclick="closeModal('finalize-modal')" class="bg-gray-200 px-3 py-1 rounded">Abbrechen</button></div>
    </div>
  </div>

  <!-- Transaction Reversal modal (Stornieren list) -->
  <div id="transaction-reversal-modal" style="display:none" class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4">
    <div class="bg-white p-4 rounded shadow w-full max-w-2xl max-h-[90vh] overflow-auto">
      <h3 class="font-bold mb-3">Letzte Transaktionen (Storno)</h3>
      <div id="transaction-list" class="space-y-2 mb-3"></div>
      <div class="text-right"><button onclick="closeModal('transaction-reversal-modal')" class="bg-gray-200 px-3 py-1 rounded">Schließen</button></div>
    </div>
  </div>

  <!-- REPORT modal (Popup) -->
  <div id="report-modal" style="display:none" class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4">
    <div class="bg-white p-4 rounded shadow w-full max-w-3xl max-h-[90vh] overflow-auto">
      <h3 class="font-bold mb-3">Auswertungen / Tagesabschluss</h3>

      <div class="flex gap-2 mb-3 items-center">
        <label class="text-sm">Datum</label>
        <input id="report-date" type="date" class="p-2 border rounded" />
        <button onclick="setReportDateToday()" class="bg-gray-200 px-2 py-1 rounded">Heute</button>
        <button onclick="runReportModal('report')" class="bg-blue-600 text-white px-3 py-1 rounded">Anzeigen</button>
        <button onclick="runReportModal('csv')" class="bg-gray-300 px-3 py-1 rounded">CSV Export</button>
        <button onclick="closeModal('report-modal')" class="ml-auto bg-gray-200 px-3 py-1 rounded">Schließen</button>
      </div>

      <div id="report-results" class="text-sm whitespace-pre-wrap font-mono bg-gray-50 p-3 rounded min-h-[200px]"></div>

    </div>
  </div>

  <!-- Info modal for general messages -->
  <div id="info-modal" style="display:none" class="fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4">
    <div class="bg-white p-4 rounded shadow w-full max-w-lg">
      <h3 id="info-title" class="font-bold mb-2">Info</h3>
      <pre id="info-text" class="bg-gray-50 p-3 rounded max-h-[60vh] overflow-auto"></pre>
      <div class="mt-3 text-right"><button onclick="closeModal('info-modal')" class="bg-gray-200 px-3 py-1 rounded">Schließen</button></div>
    </div>
  </div>

  <!-- Print area placeholder -->
  <div id="receipt-print-area" style="display:none"></div>

  <!-- ---------------------------
       Firebase + App Logic
       --------------------------- -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc,
      query, where, orderBy, serverTimestamp, Timestamp, limit
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // --- Firebase config (aus deiner Datei) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
      authDomain: "kassensystem-85412.firebaseapp.com",
      databaseURL: "https://kassensystem-85412-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kassensystem-85412",
      storageBucket: "kassensystem-85412.firebasestorage.app",
      messagingSenderId: "916536785810",
      appId: "1:916536785810:web:0d0319ef565af65d279f4b",
      measurementId: "G-W5HWYEXWJ5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- State ---
    let currentUser = null;
    let products = {};
    let categories = {};
    let userSettings = {};
    let currentBestellung = [];
    let currentQuantity = '1';
    let totalBrutto = 0;
    let transactionHistory = [];

    // --- UI helpers ---
    function showLoading(show){ document.getElementById('async-loading-overlay').style.display = show ? 'flex' : 'none'; }
    function showToast(msg, type='info'){
      const container = document.getElementById('toast-container');
      const el = document.createElement('div'); el.className = 'toast toast-'+type; el.innerText = msg;
      if(type==='success') el.classList.add('toast-success'); if(type==='error') el.classList.add('toast-error'); if(type==='info') el.classList.add('toast-info');
      container.appendChild(el); setTimeout(()=> el.style.opacity='1',50); setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=> container.removeChild(el),250); }, 3000);
    }

    // --- Auth flows ---
    window.handleLoginSubmit = async function(){
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      if(!email || !password) { showToast('Bitte E-Mail & Passwort eingeben','error'); return; }
      showLoading(true);
      try { await signInWithEmailAndPassword(auth, email, password); showToast('Angemeldet','success'); }
      catch(e){ console.error(e); showToast('Login fehlgeschlagen: '+(e.message||e.code),'error'); }
      finally{ showLoading(false); }
    };

    window.handleRegisterSubmit = async function(){
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      if(!email || !password){ showToast('E-Mail & Passwort benötigt','error'); return; }
      showLoading(true);
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await seedUserDataIfNeeded(cred.user.uid);
        showToast('Konto erstellt — bitte anmelden','success');
        closeModal('registration-modal'); openLoginModal();
      } catch(e){ console.error(e); showToast('Registrierung fehlgeschlagen: '+(e.message||e.code),'error'); }
      finally{ showLoading(false); }
    };

    window.handlePasswordReset = async function(){
      const email = document.getElementById('reset-email').value;
      if(!email){ showToast('E-Mail eingeben','error'); return; }
      showLoading(true);
      try { await sendPasswordResetEmail(auth, email); showToast('Link gesendet','success'); closeModal('forgot-password-modal'); openLoginModal(); }
      catch(e){ console.error(e); showToast('Fehler: '+(e.message||e.code),'error'); }
      finally{ showLoading(false); }
    };

    window.handleLogout = async function(){ await signOut(auth); currentUser = null; updateAppView('login'); showToast('Abgemeldet','info'); };

    onAuthStateChanged(auth, async user => {
      if(user){ currentUser = user; await initUserData(); updateAppView('kasse'); } else { currentUser = null; updateAppView('login'); }
    });

    // --- Firestore refs ---
    const settingsDocRef = uid => doc(db, 'users', uid, 'meta', 'settings');
    const categoriesCollectionRef = uid => collection(db, 'users', uid, 'categories');
    const productsCollectionRef = uid => collection(db, 'users', uid, 'products');
    const transactionsCollectionRef = uid => collection(db, 'users', uid, 'transactions');

    // --- Seed sample data for new users ---
    async function seedUserDataIfNeeded(uid){
      const sRef = settingsDocRef(uid);
      const sSnap = await getDoc(sRef);
      if(!sSnap.exists()){ await setDoc(sRef, { companyName:'Kassensystem', address:'', taxId:'', taxRate:19.0, createdAt: serverTimestamp() }); }
      const catSnap = await getDocs(categoriesCollectionRef(uid));
      if(catSnap.empty){
        const c1 = doc(categoriesCollectionRef(uid)); await setDoc(c1, { id:c1.id, name:'Getränke' });
        const c2 = doc(categoriesCollectionRef(uid)); await setDoc(c2, { id:c2.id, name:'Essen' });
        const p1 = doc(productsCollectionRef(uid)); await setDoc(p1, { id:p1.id, name:'Glühwein', price:4.00, categoryId:c1.id});
        const p2 = doc(productsCollectionRef(uid)); await setDoc(p2, { id:p2.id, name:'Kinderpunsch', price:3.00, categoryId:c1.id});
      }
    }

    // --- Init user data after login ---
    async function initUserData(){
      if(!currentUser) return;
      showLoading(true);
      try {
        await loadSettings();
        await loadProductsAndCategories();
        await loadTransactionHistory(); // cache recent txns
        renderReceipt();
      } catch(e){ console.error('init',e); showToast('Fehler beim Laden','error'); }
      finally{ showLoading(false); }
    }

    // --- Settings ---
    async function loadSettings(){
      if(!currentUser) return;
      const snap = await getDoc(settingsDocRef(currentUser.uid));
      if(snap.exists()) userSettings = snap.data();
      else { userSettings = { companyName:'Kassensystem', address:'', taxId:'', taxRate:19.0 }; await setDoc(settingsDocRef(currentUser.uid), userSettings); }
    }

    window.openSettingsModal = function(){ /* implement if needed */ };

    window.saveSettings = async function(){ /* implement if needed */ };

    // --- Products & Categories ---
    async function loadProductsAndCategories(){
      if(!currentUser) return;
      categories = {}; products = {};
      const cSnap = await getDocs(categoriesCollectionRef(currentUser.uid));
      cSnap.forEach(d => categories[d.id] = { id:d.id, ...d.data() });
      const pSnap = await getDocs(productsCollectionRef(currentUser.uid));
      pSnap.forEach(d => products[d.id] = { id:d.id, ...d.data() });
      if(Object.keys(categories).length === 0 || Object.keys(products).length === 0){ await seedUserDataIfNeeded(currentUser.uid); return await loadProductsAndCategories(); }
      renderCategoryTabs();
      renderProductGrid(Object.values(categories)[0]?.id || null);
      renderProductModalContent();
    }

    async function saveProductsAndCategories(){
      if(!currentUser) { showToast('Nicht angemeldet','error'); return; }
      showLoading(true);
      try {
        for(const c of Object.values(categories)){ await setDoc(doc(db, `users/${currentUser.uid}/categories/${c.id}`), c, { merge:true }); }
        for(const p of Object.values(products)){ await setDoc(doc(db, `users/${currentUser.uid}/products/${p.id}`), p, { merge:true }); }
        showToast('Produkte gespeichert','success');
      } catch(e){ console.error(e); showToast('Fehler beim Speichern','error'); }
      finally{ showLoading(false); }
    }

    window.addCategory = async function(){
      const name = document.getElementById('new-category-name').value.trim();
      if(!name) { showToast('Kategorie eingeben','error'); return; }
      const id = 'cat'+Date.now(); categories[id] = { id, name }; document.getElementById('new-category-name').value = '';
      await saveProductsAndCategories(); renderCategoryTabs(); renderProductModalContent();
    };

    window.addProduct = async function(){
      const name = document.getElementById('new-product-name').value.trim();
      const price = parseFloat(document.getElementById('new-product-price').value);
      const cat = document.getElementById('new-product-category').value;
      if(!name || isNaN(price) || !cat){ showToast('Produkt/Preis/Kategorie erforderlich','error'); return; }
      const id = 'prod'+Date.now(); products[id] = { id, name, price, categoryId: cat }; document.getElementById('new-product-name').value=''; document.getElementById('new-product-price').value='';
      await saveProductsAndCategories(); renderProductGrid(cat); renderProductModalContent();
    };

    window.deleteProduct = async function(id){
      if(!confirm('Produkt löschen?')) return; delete products[id]; if(currentUser) await deleteDoc(doc(db, `users/${currentUser.uid}/products/${id}`)).catch(()=>{}); renderProductModalContent(); renderProductGrid(Object.values(categories)[0]?.id || null);
    };

    window.deleteCategory = async function(id){
      if(!confirm('Kategorie & Produkte löschen?')) return;
      Object.keys(products).forEach(pid => { if(products[pid].categoryId === id) delete products[pid]; });
      delete categories[id];
      if(currentUser){ await deleteDoc(doc(db, `users/${currentUser.uid}/categories/${id}`)).catch(()=>{}); }
      await saveProductsAndCategories(); renderProductModalContent(); renderCategoryTabs();
    };

    function renderCategoryTabs(){
      const el = document.getElementById('category-tabs'); el.innerHTML='';
      Object.values(categories).forEach(c => {
        const b = document.createElement('button'); b.className='px-3 py-1 bg-red-100 rounded'; b.innerText=c.name; b.onclick = ()=> renderProductGrid(c.id);
        el.appendChild(b);
      });
    }

    function renderProductGrid(categoryId){
      const el = document.getElementById('product-grid'); el.innerHTML='';
      const items = Object.values(products).filter(p => p.categoryId === categoryId);
      if(items.length===0){ el.innerHTML = '<div class="col-span-3 text-gray-500">Keine Produkte</div>'; return; }
      items.forEach(p => {
        const btn = document.createElement('button'); btn.className='bg-red-500 text-white p-3 rounded'; btn.innerHTML = `<div class="font-bold">${p.name}</div><div class="text-sm">${p.price.toFixed(2).replace('.',',')} €</div>`;
        btn.onclick = ()=> addToBestellung(p.id);
        el.appendChild(btn);
      });
    }

    function renderProductModalContent(){
      const catSelect = document.getElementById('new-product-category'); catSelect.innerHTML = '<option value="">Kategorie wählen</option>';
      const catList = document.getElementById('category-list'); catList.innerHTML=''; const pList = document.getElementById('product-list'); pList.innerHTML='';
      Object.values(categories).forEach(c => { const opt = document.createElement('option'); opt.value=c.id; opt.innerText=c.name; catSelect.appendChild(opt); catList.innerHTML += `<div class="flex justify-between p-2 border rounded">${c.name}<button onclick="deleteCategory('${c.id}')" class="text-red-500">Löschen</button></div>`; });
      Object.values(products).forEach(p => { pList.innerHTML += `<div class="flex justify-between p-2 border rounded"><div>${p.name} - ${p.price.toFixed(2).replace('.',',')} €</div><div><button onclick="deleteProduct('${p.id}')" class="text-red-500">Löschen</button></div></div>`; });
    }

    // --- Bestell- / Bon-Logik ---
    window.handleQuantityInput = function(v){
      if(v==='clear'){ currentQuantity='1'; } else if(v==='set1'){ currentQuantity='1'; } else { if(currentQuantity==='1') currentQuantity = v; else currentQuantity += v; }
      document.getElementById('quantity-display')?.innerText = currentQuantity;
    };

    window.addToBestellung = function(productId){
      const product = products[productId]; if(!product) return; const q = parseInt(currentQuantity) || 1;
      for(let i=0;i<q;i++){
        const item = { id: Date.now()+Math.floor(Math.random()*1000), name: product.name, price: product.price, brutto: product.price, quantity: 1, productId: productId, taxRate: (userSettings.taxRate||19) };
        item.netto = item.brutto / (1 + item.taxRate/100); item.tax = item.brutto - item.netto;
        currentBestellung.push(item);
      }
      currentQuantity='1';
      renderReceipt();
    };

    function deleteOneUnitOfProduct(productId){
      const idx = currentBestellung.findIndex(it => it.productId === productId);
      if(idx>=0) currentBestellung.splice(idx,1);
      renderReceipt();
    }

    function calculateTotalBrutto(){ return currentBestellung.reduce((s,i)=> s + (i.brutto * (i.quantity||1)), 0); }

    function renderReceipt(){
      const el = document.getElementById('receipt-content-interactive'); el.innerHTML = '';
      if(currentBestellung.length===0){ el.innerHTML = '<div class="text-gray-500">Keine Artikel</div>'; document.getElementById('total-display').innerText = 'GESAMT: 0,00 €'; return; }
      const grouped = currentBestellung.reduce((acc,it)=>{ const key = it.productId; if(!acc[key]) acc[key] = {...it, count:0}; acc[key].count += (it.quantity||1); return acc; }, {});
      Object.values(grouped).forEach(g => { const row = document.createElement('div'); row.className='flex justify-between py-1'; row.innerHTML = `<div>${g.count}x ${g.name}</div><div>${(g.brutto * g.count).toFixed(2).replace('.',',')} € <button onclick="deleteOneUnitOfProduct('${g.productId}')" class="text-red-500 ml-2">Storno</button></div>`; el.appendChild(row); });
      totalBrutto = calculateTotalBrutto();
      document.getElementById('total-display').innerText = 'GESAMT: ' + totalBrutto.toFixed(2).replace('.',',') + ' €';
    }

    // --- Transactions (Firestore) ---
    async function saveTransactionToFirestore(tx){
      if(!currentUser) { showToast('Nicht angemeldet','error'); return; }
      try {
        const txDoc = {
          items: tx.items,
          totalBrutto: tx.totalBrutto,
          paymentMethod: tx.paymentMethod || 'UNKNOWN',
          createdBy: currentUser.uid,
          cancelled: false,
          timestamp: serverTimestamp()
        };
        await addDoc(transactionsCollectionRef(currentUser.uid), txDoc);
        await loadTransactionHistory();
      } catch(e){ console.error('saveTransaction',e); showToast('Fehler beim Speichern','error'); }
    }

    async function loadTransactionHistory(){
      if(!currentUser) return;
      transactionHistory = [];
      try {
        const q = query(transactionsCollectionRef(currentUser.uid), orderBy('timestamp','desc'), limit(100));
        const snap = await getDocs(q);
        snap.forEach(d => { const data = d.data(); transactionHistory.push({ id:d.id, ...data }); });
      } catch(e){ console.error('loadTransactionHistory', e); }
    }

    // finalize
    window.openFinalizeModal = function(){
      if(currentBestellung.length===0){ showToast('Keine Artikel','error'); return; }
      document.getElementById('finalize-total').innerText = calculateTotalBrutto().toFixed(2).replace('.',',') + ' €';
      document.getElementById('cash-received-display').value = '';
      document.getElementById('finalize-modal').style.display = 'flex';
    };

    window.handleFinalizeAction = async function(method, receiptType){
      const total = calculateTotalBrutto();
      const transaction = { items: currentBestellung.map(i=> ({ name:i.name, brutto:i.brutto, netto:i.netto, tax:i.tax, taxRate:i.taxRate, quantity:i.quantity||1, productId:i.productId } )), totalBrutto: total, paymentMethod: method };
      await saveTransactionToFirestore(transaction);
      showToast('Transaktion gespeichert','success');
      resetBestellung();
      closeModal('finalize-modal');
    };

    function resetBestellung(){ currentBestellung = []; renderReceipt(); }

    // --- Transaction reversal (modal) ---
    window.openTransactionReversalModal = async function(){
      if(!currentUser){ showToast('Bitte anmelden','error'); return; }
      showLoading(true);
      try {
        const listContainer = document.getElementById('transaction-list'); listContainer.innerHTML = '';
        const q = query(transactionsCollectionRef(currentUser.uid), orderBy('timestamp','desc'), limit(50));
        const snap = await getDocs(q);
        const rows = [];
        snap.forEach(d => { const data = d.data(); if(!data.cancelled) rows.push({ id:d.id, ...data }); });
        if(rows.length===0){ listContainer.innerHTML = '<div class="text-gray-500">Keine Transaktionen gefunden</div>'; document.getElementById('transaction-reversal-modal').style.display='flex'; toggleReceiptColumn(false); showLoading(false); return; }
        rows.forEach(r => {
          const item = document.createElement('div'); item.className='flex justify-between items-center p-2 border rounded';
          const left = document.createElement('div'); left.innerHTML = `<div class="font-bold">${(r.totalBrutto||0).toFixed ? (r.totalBrutto.toFixed(2).replace('.',',')+' €') : r.totalBrutto}</div><div class="text-xs text-gray-500">${r.timestamp && r.timestamp.toDate ? r.timestamp.toDate().toLocaleString('de-DE') : ''}</div>`;
          const btn = document.createElement('button'); btn.className='bg-red-600 text-white px-2 py-1 rounded'; btn.innerText='Stornieren';
          btn.onclick = ()=> { if(confirm('Transaktion wirklich stornieren?')) reverseTransaction(r.id); };
          item.appendChild(left); item.appendChild(btn); listContainer.appendChild(item);
        });
        document.getElementById('transaction-reversal-modal').style.display='flex'; toggleReceiptColumn(false);
      } catch(e){ console.error(e); showToast('Fehler beim Laden','error'); }
      finally{ showLoading(false); }
    };

    async function reverseTransaction(id){
      if(!currentUser){ showToast('Nicht angemeldet','error'); return; }
      showLoading(true);
      try {
        const txRef = doc(db, `users/${currentUser.uid}/transactions/${id}`);
        await updateDoc(txRef, { cancelled: true, cancelledAt: serverTimestamp() });
        showToast('Transaktion storniert','success');
        await loadTransactionHistory();
        // refresh the reversal modal list
        await window.openTransactionReversalModal();
      } catch(e){ console.error('reverse', e); showToast('Fehler beim Stornieren','error'); }
      finally{ showLoading(false); }
    }

    // --- REPORT modal logic ---
    function setReportDateToday(){ const d = new Date().toISOString().split('T')[0]; document.getElementById('report-date').value = d; }

    // Run report: type = 'csv'|'report'
    async function runReportModal(type){
      if(!currentUser){ showToast('Bitte anmelden','error'); return; }
      const selectedDate = document.getElementById('report-date').value;
      if(!selectedDate){ showToast('Datum wählen','error'); return; }
      showLoading(true);
      try {
        // Build start/end timestamps
        const start = new Date(selectedDate + 'T00:00:00');
        const end = new Date(start); end.setDate(end.getDate()+1);
        const startTs = Timestamp.fromDate(start);
        const endTs = Timestamp.fromDate(end);

        const q = query(transactionsCollectionRef(currentUser.uid), where('timestamp','>=', startTs), where('timestamp','<', endTs), orderBy('timestamp','asc'));
        const snap = await getDocs(q);
        const txns = [];
        snap.forEach(d => { const data = d.data(); if(!data.cancelled) txns.push({ id:d.id, ...data }); });

        if(txns.length===0){ showToast('Keine Transaktionen an diesem Tag','info'); document.getElementById('report-results').innerText = 'Keine Transaktionen für dieses Datum.'; showLoading(false); return; }

        // Aggregate
        let totalRevenue = 0; const revenueByMethod = {}; const revenueByTax = {}; const productStats = {};
        txns.forEach(tx => {
          const tot = tx.totalBrutto||0; totalRevenue += tot; revenueByMethod[tx.paymentMethod] = (revenueByMethod[tx.paymentMethod]||0) + tot;
          (tx.items||[]).forEach(it => {
            const rate = (it.taxRate !== undefined) ? Number(it.taxRate).toFixed(2)+'%' : '0%';
            revenueByTax[rate] = revenueByTax[rate] || { netto:0, tax:0 };
            revenueByTax[rate].netto += (it.netto||0) * (it.quantity||1);
            revenueByTax[rate].tax += (it.tax||0) * (it.quantity||1);
            const name = it.name || 'Unbenannt';
            productStats[name] = productStats[name] || { count:0, revenue:0 };
            productStats[name].count += (it.quantity||1);
            productStats[name].revenue += (it.brutto||it.price||0) * (it.quantity||1);
          });
        });

        if(type === 'csv'){
          // CSV with BOM for Excel
          let csv = '\uFEFF'; // BOM
          csv += "Artikel;Anzahl;Umsatz Brutto (€)\n";
          Object.entries(productStats).sort((a,b)=> a[0].localeCompare(b[0])).forEach(([name, s]) => {
            csv += `${name};${s.count};${s.revenue.toFixed(2).replace('.',',')}\n`;
          });
          csv += `\nGESAMTUMSATZ BRUTTO;${totalRevenue.toFixed(2).replace('.',',')} €\n`;
          Object.entries(revenueByMethod).forEach(([m,v]) => { csv += `${m};${v.toFixed(2).replace('.',',')} €\n`; });

          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = `Tagesabschluss_${selectedDate}.csv`;
          document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
          showToast('CSV Export gestartet','success');
        } else {
          // Build textual report
          let report = `Tagesabschluss für ${selectedDate}\n\nGESAMTUMSATZ BRUTTO: ${totalRevenue.toFixed(2).replace('.',',')} €\n\nUmsatz nach Zahlungsart:\n`;
          Object.entries(revenueByMethod).forEach(([m,v]) => report += ` - ${m}: ${v.toFixed(2).replace('.',',')} €\n`);
          report += `\nUmsatz nach Steuersatz:\n`;
          Object.entries(revenueByTax).forEach(([r,d]) => report += ` - ${r} Netto: ${d.netto.toFixed(2).replace('.',',')} € Steuer: ${d.tax.toFixed(2).replace('.',',')} €\n`);
          report += `\nArtikelübersicht:\n`;
          Object.entries(productStats).sort((a,b)=> a[0].localeCompare(b[0])).forEach(([n,s]) => report += ` - ${n}: ${s.count}x (${s.revenue.toFixed(2).replace('.',',')} €)\n`);
          document.getElementById('report-results').innerText = report;
        }
      } catch(e){ console.error('runReport', e); showToast('Fehler beim Erstellen des Berichts','error'); }
      finally{ showLoading(false); }
    }

    // --- Utility functions ---
    function toggleReceiptColumn(show){ /* not used in this simplified UI */ }
    window.updateAppView = function(view){
      document.getElementById('login-modal').style.display = 'none';
      document.getElementById('registration-modal').style.display = 'none';
      document.getElementById('forgot-password-modal').style.display = 'none';
      document.getElementById('kasse-content').style.display = 'none';
      if(view === 'login') document.getElementById('login-modal').style.display = 'flex';
      if(view === 'kasse') document.getElementById('kasse-content').style.display = 'block';
    };
    window.closeModal = function(id){ document.getElementById(id).style.display = 'none'; }
    window.openLoginModal = function(){ updateAppView('login'); }
    window.openRegistrationModal = function(){ document.getElementById('login-modal').style.display='none'; document.getElementById('registration-modal').style.display='flex'; }
    window.openForgotPasswordModal = function(){ document.getElementById('login-modal').style.display='none'; document.getElementById('forgot-password-modal').style.display='flex'; }
    window.openProductModal = function(){ renderProductModalContent(); document.getElementById('product-modal').style.display='flex'; }
    window.openReportModal = function(){ setReportDateToday(); document.getElementById('report-results').innerText = ''; document.getElementById('report-modal').style.display='flex'; }
    window.openTransactionReversalModal = function(){ window.openTransactionReversalModal = window.openTransactionReversalModal; /* overwritten below */ openTransactionReversalModal(); }

    // ensure initial view
    document.addEventListener('DOMContentLoaded', ()=> { setReportDateToday(); updateAppView('login'); });

  </script>

  <script>
    // small helper to ensure the openTransactionReversalModal reference exists globally for the top-level button
    // (function exists inside the module; here we map the function name to the module-scoped function)
    // If you see errors, make sure to reload page after firebase scripts loaded.
  </script>
</body>
</html>
