<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kassensystem (Bewirtungsbeleg) - Firebase Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* (aus deinem Original: nur relevante Styles gekürzt/übernommen) */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        #receipt-content-interactive { overflow-y: auto; max-height: 40vh; }
        .product-btn:active { transform: scale(0.98); }
        .numpad-btn { height: 50px; line-height: 1; display:flex; justify-content:center; align-items:center; }
        #async-loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background-color: rgba(255,255,255,0.8); z-index:100; display:none; justify-content:center; align-items:center; }
        .spinner { border:4px solid rgba(0,0,0,0.1); border-top:4px solid #b91c1c; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
        #toast-container{position:fixed;top:1rem;right:1rem;z-index:1000;pointer-events:none;}
        .toast{padding:8px;border-radius:8px;color:#fff;opacity:0;transition:opacity .3s, transform .3s;}
        .toast-success{background:#16a34a;}
        .toast-error{background:#dc2626;}
        .toast-info{background:#2563eb;}
        @media print { body * { visibility:hidden } .receipt-print, .receipt-print * { visibility:visible } .receipt-print { position:absolute; left:0; top:0; width:80mm; font-family:monospace; font-size:9pt; color:#000; } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-4 bg-red-500/10 overflow-x-hidden">

    <!-- Toasts & Loading -->
    <div id="toast-container"></div>
    <div id="async-loading-overlay"><div class="spinner"></div></div>

    <!-- Login Modal -->
    <div id="login-modal" style="display:flex" class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h1 class="text-3xl font-bold text-center text-red-700 mb-2">Kassensystem</h1>
            <p class="text-sm text-center text-gray-500 mb-6">Bitte mit Ihren Zugangsdaten anmelden.</p>
            <form id="login-form" onsubmit="event.preventDefault(); handleLoginSubmit();">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700">E-Mail Adresse</label>
                    <input type="email" id="login-email" required class="mt-1 w-full px-3 py-2 border rounded-lg" />
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Passwort</label>
                    <input type="password" id="login-password" required class="mt-1 w-full px-3 py-2 border rounded-lg" />
                </div>
                <button type="submit" class="w-full p-2 rounded-lg font-bold text-white bg-red-600 hover:bg-red-700">Anmelden</button>
            </form>
            <div class="mt-4 text-center">
                <button onclick="openRegistrationModal()" class="text-sm text-indigo-600 hover:text-indigo-800">Noch kein Konto? Hier registrieren.</button>
                <button onclick="openForgotPasswordModal()" class="block w-full mt-2 text-sm text-red-600 hover:text-red-800">Passwort vergessen?</button>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registration-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-indigo-700 mb-4">Konto erstellen</h2>
            <form id="register-form" onsubmit="event.preventDefault(); handleRegisterSubmit();">
                <div class="mb-4">
                    <label for="register-email" class="block text-sm font-medium text-gray-700">E-Mail</label>
                    <input type="email" id="register-email" required class="mt-1 w-full px-3 py-2 border rounded-lg" />
                </div>
                <div class="mb-6">
                    <label for="register-password" class="block text-sm font-medium text-gray-700">Passwort (min.6)</label>
                    <input type="password" id="register-password" required minlength="6" class="mt-1 w-full px-3 py-2 border rounded-lg" />
                </div>
                <button type="submit" class="w-full p-2 rounded-lg font-bold text-white bg-green-600 hover:bg-green-700">Registrieren</button>
            </form>
            <button onclick="closeModal('registration-modal'); openLoginModal();" class="mt-4 w-full p-1 text-sm text-gray-500">Zurück zum Login</button>
        </div>
    </div>

    <!-- Forgot Password -->
    <div id="forgot-password-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-red-700 mb-4">Passwort zurücksetzen</h2>
            <form id="reset-form" onsubmit="event.preventDefault(); handlePasswordReset();">
                <div class="mb-6">
                    <label for="reset-email" class="block text-sm font-medium text-gray-700">E-Mail Adresse</label>
                    <input type="email" id="reset-email" required class="mt-1 w-full px-3 py-2 border rounded-lg" />
                </div>
                <button type="submit" class="w-full p-2 rounded-lg font-bold text-white bg-red-600 hover:bg-red-700">Link senden</button>
            </form>
            <button onclick="closeModal('forgot-password-modal'); openLoginModal();" class="mt-4 w-full p-1 text-sm text-gray-500">Zurück zum Login</button>
        </div>
    </div>

    <!-- Main Kassen-Content -->
    <div id="kasse-content" style="display:none" class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-3">
            <div id="db-status" class="text-xs font-bold p-1.5 rounded-lg bg-yellow-300 text-gray-800">Datenbankmodul lädt...</div>
            <h1 class="text-2xl font-bold text-red-700">Kassensystem</h1>
            <div class="flex flex-col items-end">
                <div id="auth-info" class="text-xs text-gray-500">Kasse v5.7 (Firebase)</div>
                <button onclick="handleLogout()" class="mt-1 px-3 py-1 text-xs font-bold text-white bg-red-500 rounded-lg">Logout</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Left column: Menge, Aktionen -->
            <div class="lg:col-span-1 space-y-3">
                <div class="bg-white p-3 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-indigo-800 mb-2">Menge</h2>
                    <div id="quantity-display" class="w-full h-10 flex items-center justify-center text-xl font-extrabold text-red-600 bg-red-100 rounded-xl shadow-inner">1</div>
                    <div id="main-numpad-container" class="grid grid-cols-3 gap-2 mt-3">
                        <button onclick="handleQuantityInput('7')" class="numpad-btn bg-gray-200">7</button>
                        <button onclick="handleQuantityInput('8')" class="numpad-btn bg-gray-200">8</button>
                        <button onclick="handleQuantityInput('9')" class="numpad-btn bg-gray-200">9</button>
                        <button onclick="handleQuantityInput('4')" class="numpad-btn bg-gray-200">4</button>
                        <button onclick="handleQuantityInput('5')" class="numpad-btn bg-gray-200">5</button>
                        <button onclick="handleQuantityInput('6')" class="numpad-btn bg-gray-200">6</button>
                        <button onclick="handleQuantityInput('1')" class="numpad-btn bg-gray-200">1</button>
                        <button onclick="handleQuantityInput('2')" class="numpad-btn bg-gray-200">2</button>
                        <button onclick="handleQuantityInput('3')" class="numpad-btn bg-gray-200">3</button>
                        <button onclick="handleQuantityInput('clear')" class="numpad-btn bg-red-500 text-white">C</button>
                        <button onclick="handleQuantityInput('0')" class="numpad-btn bg-gray-200">0</button>
                        <button onclick="handleQuantityInput('set1')" class="numpad-btn bg-green-500 text-white">1x</button>
                    </div>
                </div>

                <div class="bg-white p-3 rounded-xl shadow-lg flex flex-col gap-2">
                    <button onclick="undoLastAction()" class="product-btn w-full p-2 rounded-lg font-bold text-sm bg-yellow-400">Storno (Letzte)</button>
                    <button onclick="openTransactionReversalModal()" class="product-btn w-full p-2 rounded-lg font-bold text-sm bg-red-700 text-white">Letzte Buchungen stornieren</button>
                    <button onclick="resetBestellung()" class="product-btn w-full p-2 rounded-lg bg-gray-300">Neue Bestellung</button>
                </div>

                <div class="flex flex-col gap-2">
                    <button onclick="openFinalizeModal()" class="product-btn w-full p-3 rounded-xl font-extrabold text-lg text-white bg-green-600">Zur Zahlung</button>
                    <button onclick="openProductModal()" class="product-btn w-full p-3 rounded-xl text-white bg-indigo-600">Produkte verwalten</button>
                    <div class="flex items-center space-x-2 bg-white p-3 rounded-xl border-2 border-blue-200">
                        <label for="report-date" class="text-sm font-bold text-blue-700">Bericht für Tag:</label>
                        <input type="date" id="report-date" class="p-1 border rounded-lg text-sm flex-grow" />
                        <button onclick="setReportDateToday()" class="p-1 rounded-lg text-xs font-bold text-white bg-red-500">Heute</button>
                    </div>
                    <button onclick="runDailyReport('report')" class="product-btn w-full p-3 rounded-xl text-white bg-blue-600">Tagesabschluss (Bericht)</button>
                    <button onclick="runDailyReport('csv')" class="product-btn w-full p-3 rounded-xl bg-gray-300">Tagesabschluss (CSV Export)</button>
                    <button onclick="openSettingsModal()" class="product-btn w-full p-3 rounded-xl bg-yellow-600 text-white">Einstellungen (Belegkopf)</button>
                </div>
            </div>

            <!-- Middle column: Categories & Products -->
            <div class="lg:col-span-1 space-y-3">
                <div class="bg-white p-3 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold mb-2 text-red-800">Produkte buchen</h2>
                    <div id="category-tabs" class="flex space-x-2 overflow-x-auto pb-2 mb-3 border-b"></div>
                    <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-3">
                        <p class="text-gray-500 col-span-full text-center">Produkte werden geladen...</p>
                    </div>
                </div>
            </div>

            <!-- Right column: Receipt -->
            <div id="receipt-column" class="lg:col-span-1 bg-white p-3 rounded-xl shadow-lg sticky top-3">
                <h2 class="text-lg font-semibold mb-2 text-gray-700">Aktueller Bon (Brutto)</h2>
                <div id="receipt-content-interactive" class="bg-gray-50 p-2 rounded-lg text-xs text-gray-700 border min-h-[150px]">
                    <p class="text-center text-sm text-gray-400 p-4">Es wurden noch keine Artikel gebucht.</p>
                </div>
                <div class="mt-3 pt-3 border-t-2 border-red-700">
                    <div id="total-display" class="text-2xl font-extrabold text-right text-red-700">GESAMT: 0.00 €</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 text-indigo-700">Produkt- und Kategorie-Verwaltung</h2>
            <div id="product-modal-content">
                <div class="mb-4 border-b pb-3">
                    <h3 class="text-lg font-semibold mb-2">Neue Kategorie/Produkt anlegen</h3>
                    <div class="flex space-x-2 mb-2">
                        <input type="text" id="new-category-name" placeholder="Name der Kategorie" class="flex-grow p-2 border rounded-lg">
                        <button onclick="addCategory()" class="p-2 bg-indigo-500 text-white rounded-lg">Kategorie hinzufügen</button>
                    </div>
                    <div class="grid grid-cols-5 gap-2 items-end">
                        <input type="text" id="new-product-name" placeholder="Name des Produkts" class="col-span-2 p-2 border rounded-lg">
                        <input type="number" id="new-product-price" placeholder="Preis (€)" step="0.01" class="p-2 border rounded-lg">
                        <select id="new-product-category" class="p-2 border rounded-lg"><option value="">Kategorie wählen</option></select>
                        <button onclick="addProduct()" class="p-2 bg-green-500 text-white rounded-lg">Produkt hinzufügen</button>
                    </div>
                </div>

                <h3 class="text-lg font-semibold mb-2">Bestehende Kategorien</h3>
                <div id="category-list" class="space-y-2 mb-4"></div>

                <h3 class="text-lg font-semibold mb-2">Bestehende Produkte (Preise anpassen)</h3>
                <div id="product-list" class="space-y-2"></div>
            </div>
            <div class="mt-6 text-right">
                <button onclick="closeModal('product-modal')" class="p-2 bg-gray-300 rounded-lg">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Finalize modal (vereinfachte Ansicht) -->
    <div id="finalize-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-3 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4 text-green-700 text-center">Zahlung abschließen</h2>
            <div class="mb-3 p-2 border-2 border-green-500 rounded-lg bg-green-50">
                <p class="text-xs font-bold text-gray-700">Gesamtbetrag:</p>
                <div id="finalize-total" class="text-3xl font-extrabold text-right text-green-700">0.00 €</div>
            </div>
            <div id="payment-buttons" class="grid grid-cols-1 gap-3 mb-4">
                <button onclick="setPaymentMethod('KARTE')" id="btn-karte" class="p-3 rounded-xl font-semibold text-white bg-indigo-600">KARTE ZAHLUNG</button>
            </div>
            <div id="cash-payment-area" class="mt-4 p-3 border rounded-lg bg-gray-50">
                <h3 class="text-lg font-semibold mb-2 flex justify-between items-center text-blue-700">BAR Zahlung (Rückgeld) <span id="btn-bar-indicator" class="text-xs bg-blue-500 text-white px-2 py-1 rounded-full">AKTIV</span></h3>
                <label class="block text-sm font-medium text-gray-700 mb-1">Erhaltener Betrag</label>
                <div id="cash-received-display" class="w-full h-10 flex items-center justify-end px-3 py-2 border rounded-xl text-xl font-extrabold bg-white">0,00</div>
                <div class="mt-3 pt-2 border-t flex justify-between items-center">
                    <span class="text-lg font-bold text-gray-700">Rückgeld:</span>
                    <span id="change-display" class="text-2xl font-extrabold text-green-700">0,00 €</span>
                </div>
                <div id="cash-numpad-container" class="mt-4 grid grid-cols-3 gap-2">
                    <button onclick="handleCashInput('7')" class="numpad-btn bg-gray-200">7</button>
                    <button onclick="handleCashInput('8')" class="numpad-btn bg-gray-200">8</button>
                    <button onclick="handleCashInput('9')" class="numpad-btn bg-gray-200">9</button>
                    <button onclick="handleCashInput('4')" class="numpad-btn bg-gray-200">4</button>
                    <button onclick="handleCashInput('5')" class="numpad-btn bg-gray-200">5</button>
                    <button onclick="handleCashInput('6')" class="numpad-btn bg-gray-200">6</button>
                    <button onclick="handleCashInput('1')" class="numpad-btn bg-gray-200">1</button>
                    <button onclick="handleCashInput('2')" class="numpad-btn bg-gray-200">2</button>
                    <button onclick="handleCashInput('3')" class="numpad-btn bg-gray-200">3</button>
                    <button onclick="handleCashInput('clear')" class="numpad-btn bg-red-500 text-white">C</button>
                    <button onclick="handleCashInput('0')" class="numpad-btn bg-gray-200">0</button>
                    <button onclick="handleCashInput('dot')" class="numpad-btn bg-gray-200">,</button>
                </div>
                <div class="mt-3 grid grid-cols-3 gap-2">
                    <button onclick="setCashExact()" class="product-btn h-10 bg-blue-500 text-white">Exakt</button>
                    <button onclick="addCashShortcut(5)" class="product-btn h-10 bg-blue-500 text-white">+5 €</button>
                    <button onclick="addCashShortcut(10)" class="product-btn h-10 bg-blue-500 text-white">+10 €</button>
                </div>
            </div>

            <div id="finalize-button-container" class="mt-4">
                <div id="cash-finalize-buttons" style="display:block">
                    <p class="text-sm text-center text-gray-500 mb-2 font-semibold">Transaktion abschließen:</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="handleFinalizeAction('BAR','none')" disabled id="btn-cash-none" class="p-3 rounded-xl text-white bg-red-400">Ohne Beleg</button>
                        <button onclick="handleFinalizeAction('BAR','standard')" disabled id="btn-cash-standard" class="p-3 rounded-xl text-white bg-green-400">Standard Bon</button>
                        <button onclick="handleFinalizeAction('BAR','bewirtung')" disabled id="btn-cash-bewirtung" class="p-3 rounded-xl text-white bg-red-600/70">Bewirtungsbeleg</button>
                    </div>
                </div>

                <div id="card-finalize-buttons" style="display:none">
                    <p class="text-lg font-bold text-center text-indigo-700 mb-3">Belegoptionen:</p>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="handleFinalizeAction('KARTE','none')" class="p-3 rounded-xl text-white bg-gray-500">NEIN (Abschließen)</button>
                        <button onclick="handleFinalizeAction('KARTE','standard')" class="p-3 rounded-xl text-white bg-green-600">Standard Bon</button>
                        <button onclick="handleFinalizeAction('KARTE','bewirtung')" class="p-3 rounded-xl text-white bg-red-700">Bewirtungsbeleg</button>
                    </div>
                </div>
            </div>

            <div class="text-center mt-6">
                <button onclick="closeModal('finalize-modal')" class="p-2 bg-gray-300 rounded-lg w-full">Abbrechen / Zurück</button>
            </div>
        </div>
    </div>

    <!-- Transaction reversal modal -->
    <div id="transaction-reversal-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 text-red-700">Letzte Transaktionen stornieren</h2>
            <div id="transaction-list" class="space-y-3 mb-4"></div>
            <div class="text-right">
                <button onclick="closeModal('transaction-reversal-modal')" class="p-2 bg-gray-300 rounded-lg">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Settings modal -->
    <div id="settings-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-xl font-bold mb-4 text-yellow-700">Einstellungen (Belegkopf)</h2>
            <form id="settings-form">
                <div class="mb-4">
                    <label for="company-name" class="block text-sm font-medium text-gray-700">Firmenname</label>
                    <input type="text" id="company-name" class="mt-1 w-full p-2 border rounded-lg">
                </div>
                <div class="mb-4">
                    <label for="address" class="block text-sm font-medium text-gray-700">Adresse</label>
                    <input type="text" id="address" class="mt-1 w-full p-2 border rounded-lg">
                </div>
                <div class="mb-4">
                    <label for="tax-id" class="block text-sm font-medium text-gray-700">Steuernummer/USt-IdNr.</label>
                    <input type="text" id="tax-id" class="mt-1 w-full p-2 border rounded-lg">
                </div>
                <div class="mb-6">
                    <label for="tax-rate" class="block text-sm font-medium text-gray-700">Standard Steuersatz (%)</label>
                    <input type="number" id="tax-rate" step="0.1" class="mt-1 w-full p-2 border rounded-lg">
                </div>
                <button type="button" onclick="saveSettings()" class="w-full p-3 rounded-lg font-bold text-white bg-red-600">Einstellungen speichern</button>
            </form>
            <div class="mt-4 text-right"><button onclick="closeModal('settings-modal')" class="p-2 bg-gray-300 rounded-lg">Schließen</button></div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" style="display:none" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h2 id="info-title" class="text-xl font-bold mb-4 text-blue-700">Information</h2>
            <pre id="info-text" class="whitespace-pre-wrap font-mono text-sm bg-gray-100 p-3 rounded-lg overflow-x-auto"></pre>
            <div class="mt-6 text-right"><button onclick="closeModal('info-modal')" class="p-2 bg-gray-300 rounded-lg">Schließen</button></div>
        </div>
    </div>

    <!-- Main application script (Firebase + App logic) -->
    <script type="module">
    /********************************************************************************
     * Vollständig integriertes Script:
     * - Import Firebase SDK modules
     * - Initialisierung
     * - Auth (login/register/reset/logout) + Realtime DB für products/categories/transactions
     * - Bindet sich in die UI-Funktionen (wie in deinem ursprünglichen Code)
     ********************************************************************************/

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
    import {
        getAuth,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        sendPasswordResetEmail,
        signOut,
        onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    import {
        getDatabase,
        ref,
        set,
        get,
        child,
        update,
        push,
        onValue,
        remove
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ---------- Firebase config (aus deiner Datei) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
      authDomain: "kassensystem-85412.firebaseapp.com",
      databaseURL: "https://kassensystem-85412-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "kassensystem-85412",
      storageBucket: "kassensystem-85412.firebasestorage.app",
      messagingSenderId: "916536785810",
      appId: "1:916536785810:web:0d0319ef565af65d279f4b",
      measurementId: "G-W5HWYEXWJ5"
    };

    const app = initializeApp(firebaseConfig);
    let analytics;
    try { analytics = getAnalytics(app); } catch(e){ /* analytics may fail in some envs */ }

    const auth = getAuth(app);
    const db = getDatabase(app);

    // Expose for debugging (optional)
    window._firebase = { app, auth, db };

    // ---------- App state ----------
    let DB_STATUS = 'disconnected';
    let currentBestellung = [];
    let currentQuantity = '1';
    let cashReceivedInput = '0';
    let products = {};
    let categories = {};
    let userSettings = {};
    let transactionHistory = []; // local cache of recent transactions
    let lastAction = null;
    let selectedPaymentMethod = null;
    let totalBrutto = 0;

    // ---------- Utility UI helpers ----------
    function showLoading(show) { document.getElementById('async-loading-overlay').style.display = show ? 'flex' : 'none'; }
    function showToast(message, type='info') {
        const container = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = 'toast toast-'+type;
        t.innerText = message;
        if (type==='success') t.classList.add('toast-success');
        if (type==='error') t.classList.add('toast-error');
        if (type==='info') t.classList.add('toast-info');
        container.appendChild(t);
        setTimeout(()=>{ t.style.opacity='1'; t.style.transform='translateY(0)'; }, 50);
        setTimeout(()=>{ t.style.opacity='0'; setTimeout(()=>t.remove(),300); }, 3000);
    }
    function closeModal(id){ document.getElementById(id).style.display='none'; toggleReceiptColumn(true); }
    function openLoginModal(){ document.getElementById('login-modal').style.display='flex'; toggleReceiptColumn(false); }
    function openRegistrationModal(){ closeModal('login-modal'); toggleReceiptColumn(false); document.getElementById('registration-modal').style.display='flex'; }
    function openForgotPasswordModal(){ closeModal('login-modal'); toggleReceiptColumn(false); document.getElementById('forgot-password-modal').style.display='flex'; }
    function toggleReceiptColumn(show){ const c = document.getElementById('receipt-column'); if(!c) return; if(show) c.classList.remove('hidden'); else c.classList.add('hidden'); }
    function updateDBStatus(connected){ const s=document.getElementById('db-status'); if(connected) { s.className="text-xs font-bold p-1.5 rounded-lg bg-green-500 text-white"; s.innerText="Datenbank verbunden"; } else { s.className="text-xs font-bold p-1.5 rounded-lg bg-red-500 text-white"; s.innerText="Datenbank getrennt"; } }

    // ---------- Auth functions ----------
    async function handleLoginSubmit() {
        showLoading(true);
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
            // onAuthStateChanged wird view wechseln
            showToast('Erfolgreich angemeldet!', 'success');
        } catch (e) {
            showToast('Login fehlgeschlagen: ' + e.message, 'error');
        }
        showLoading(false);
    }

    async function handleRegisterSubmit() {
        showLoading(true);
        const email = document.getElementById('register-email').value;
        const pass = document.getElementById('register-password').value;
        try {
            await createUserWithEmailAndPassword(auth, email, pass);
            showToast('Registrierung erfolgreich! Bitte melden Sie sich an.', 'success');
            closeModal('registration-modal');
            openLoginModal();
        } catch(e) {
            showToast('Registrierung fehlgeschlagen: ' + e.message, 'error');
        }
        showLoading(false);
    }

    async function handlePasswordReset() {
        const email = document.getElementById('reset-email').value;
        if(!email) return;
        showLoading(true);
        try {
            await sendPasswordResetEmail(auth, email);
            showToast('Reset-Link gesendet!', 'success');
            document.getElementById('reset-email').value='';
            closeModal('forgot-password-modal'); openLoginModal();
        } catch(e) {
            showToast('Fehler: ' + e.message, 'error');
        }
        showLoading(false);
    }

    function handleLogout(){
        signOut(auth).then(()=> {
            resetBestellung();
            updateAppView('login');
            showToast('Erfolgreich abgemeldet.', 'info');
        });
    }

    // ---------- DB helpers ----------
    // Path helpers in Realtime DB:
    const rootRef = ref(db);
    const productsRefPath = 'products';
    const categoriesRefPath = 'categories';
    const transactionsRefPath = 'transactions';
    const settingsRefPath = 'settings';

    async function loadSettings() {
        // read settings from DB -> fallback to localStorage defaults
        try {
            const snap = await get(child(rootRef, settingsRefPath));
            if (snap.exists()) {
                userSettings = snap.val();
            } else {
                userSettings = {
                    companyName: localStorage.getItem('companyName') || "Kassensystem",
                    address: localStorage.getItem('address') || "Hauptstraße 1, 12345 Glühheim",
                    taxId: localStorage.getItem('taxId') || "DE123456789",
                    taxRate: parseFloat(localStorage.getItem('taxRate')) || 19.0
                };
                // write defaults to DB for persistence
                await set(child(rootRef, settingsRefPath), userSettings);
            }
        } catch(e) {
            console.error('loadSettings error', e);
            // fallback to local
            userSettings = {
                companyName: localStorage.getItem('companyName') || "Kassensystem",
                address: localStorage.getItem('address') || "Hauptstraße 1, 12345 Glühheim",
                taxId: localStorage.getItem('taxId') || "DE123456789",
                taxRate: parseFloat(localStorage.getItem('taxRate')) || 19.0
            };
        }
    }

    async function loadProductsAndCategories() {
        try {
            const prodSnap = await get(child(rootRef, productsRefPath));
            const catSnap = await get(child(rootRef, categoriesRefPath));
            products = prodSnap.exists() ? prodSnap.val() : {};
            categories = catSnap.exists() ? catSnap.val() : {};

            // if categories empty, seed defaults
            if (!categories || Object.keys(categories).length===0) {
                categories = {
                    'cat1': { id:'cat1', name:'Getränke' },
                    'cat2': { id:'cat2', name:'Essen' },
                    'cat3': { id:'cat3', name:'Pfand' }
                };
                await set(child(rootRef, categoriesRefPath), categories);
            }
            if (!products || Object.keys(products).length===0) {
                products = {
                    'prod1': { id:'prod1', name:'Glühwein', price:4.00, categoryId:'cat1' },
                    'prod2': { id:'prod2', name:'Kinderpunsch', price:3.00, categoryId:'cat1' },
                    'prod3': { id:'prod3', name:'Bratwurst', price:3.50, categoryId:'cat2' },
                    'prod4': { id:'prod4', name:'Pommes', price:3.00, categoryId:'cat2' },
                    'prod5': { id:'prod5', name:'Pfand', price:2.00, categoryId:'cat3' }
                };
                await set(child(rootRef, productsRefPath), products);
            }

            renderCategoryTabs();
            renderProductGrid(Object.keys(categories)[0] || 'cat1');
            renderProductModalContent();
        } catch(e) {
            console.error(e);
            showToast('Fehler beim Laden von Produkten/Kategorien: ' + e.message, 'error');
        }
    }

    async function loadTransactionHistory() {
        try {
            const txSnap = await get(child(rootRef, transactionsRefPath));
            const txs = txSnap.exists() ? txSnap.val() : {};
            // convert object to sorted array by timestamp desc
            transactionHistory = Object.values(txs || {}).sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
        } catch(e) {
            console.error(e);
            transactionHistory = JSON.parse(localStorage.getItem('transactionHistory')) || [];
        }
    }

    async function saveProductsAndCategories() {
        // write both
        await set(child(rootRef, productsRefPath), products);
        await set(child(rootRef, categoriesRefPath), categories);
        renderCategoryTabs();
        renderProductGrid(Object.keys(categories)[0] || 'cat1');
        renderProductModalContent();
    }

    async function saveTransaction(transaction) {
        // write under transactions/{id}
        await set(child(rootRef, transactionsRefPath + '/' + transaction.id), transaction);
        // keep local cache as well for speed
        transactionHistory.unshift(transaction);
        if (transactionHistory.length > 200) transactionHistory = transactionHistory.slice(0,200);
        // optional: keep transactionHistory in localStorage for offline fallback
        localStorage.setItem('transactionHistory', JSON.stringify(transactionHistory.slice(0,200)));
    }

    // ---------- UI rendering functions (adapted from your code) ----------
    function renderCategoryTabs() {
        const container = document.getElementById('category-tabs');
        container.innerHTML = '';
        Object.values(categories || {}).forEach(category => {
            const btn = document.createElement('button');
            btn.className = 'flex-shrink-0 px-3 py-1 rounded-lg text-sm font-semibold transition-colors bg-red-100 text-red-700 hover:bg-red-200';
            btn.dataset.category = category.id;
            btn.innerText = category.name;
            btn.onclick = () => renderProductGrid(category.id);
            container.appendChild(btn);
        });
    }

    function renderProductGrid(categoryId) {
        const container = document.getElementById('product-grid');
        const tabs = document.querySelectorAll('#category-tabs button');
        container.innerHTML = '';
        tabs.forEach(tab => {
            tab.classList.remove('bg-red-600','text-white');
            tab.classList.add('bg-red-100','text-red-700');
            if (tab.dataset.category === categoryId) {
                tab.classList.add('bg-red-600','text-white');
                tab.classList.remove('bg-red-100','text-red-700');
            }
        });

        const filtered = Object.values(products || {}).filter(p => p.categoryId === categoryId);
        if (filtered.length === 0) {
            container.innerHTML = '<p class="text-gray-500 col-span-full text-center p-4">Keine Produkte in dieser Kategorie.</p>';
            return;
        }
        filtered.forEach(product => {
            const button = document.createElement('button');
            button.className = 'product-btn p-4 rounded-xl font-extrabold text-white bg-red-500 hover:bg-red-600 shadow-lg flex flex-col justify-center items-center text-center h-24';
            button.innerHTML = `<span class="text-base">${product.name}</span><span class="text-2xl font-extrabold mt-1">${product.price.toFixed(2).replace('.', ',')} €</span>`;
            button.onclick = () => addToBestellung(product.id);
            container.appendChild(button);
        });
    }

    function renderProductModalContent() {
        const categorySelect = document.getElementById('new-product-category');
        categorySelect.innerHTML = '<option value="">Kategorie wählen</option>';
        const categoryList = document.getElementById('category-list'); categoryList.innerHTML='';
        const productList = document.getElementById('product-list'); productList.innerHTML='';

        Object.values(categories || {}).forEach(cat => {
            const opt = document.createElement('option'); opt.value = cat.id; opt.innerText = cat.name; categorySelect.appendChild(opt);
            categoryList.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg border"><span class="font-semibold">${cat.name}</span><button onclick="deleteCategory('${cat.id}')" class="text-red-500">Löschen</button></div>`;
        });

        Object.values(products || {}).forEach(product => {
            productList.innerHTML += `
                <div class="flex items-center p-2 bg-gray-50 rounded-lg border">
                    <span class="font-semibold w-1/3">${product.name}</span>
                    <div class="flex-grow flex items-center space-x-2">
                        <input type="number" id="price-input-${product.id}" value="${product.price.toFixed(2)}" step="0.01" class="p-1 border rounded-lg text-sm w-24 text-right">
                        <span class="text-sm text-gray-600">€</span>
                    </div>
                    <span class="text-sm text-gray-600 w-1/4 text-right">(${categories[product.categoryId]?.name || 'N/A'})</span>
                    <button onclick="updateProductPrice('${product.id}')" class="ml-3 p-1 px-2 rounded-lg text-white bg-green-500">Speichern</button>
                    <button onclick="deleteProduct('${product.id}')" class="ml-2 text-red-500">Löschen</button>
                </div>`;
        });
    }

    function openProductModal(){ renderProductModalContent(); toggleReceiptColumn(false); document.getElementById('product-modal').style.display='flex'; }

    function addCategory() {
        const name = document.getElementById('new-category-name').value.trim();
        if (!name) { showToast('Bitte einen Kategorienamen eingeben.', 'error'); return; }
        const newId = 'cat' + Date.now();
        categories[newId] = { id: newId, name: name };
        document.getElementById('new-category-name').value='';
        saveProductsAndCategories();
        showToast('Kategorie hinzugefügt.', 'success');
    }

    function addProduct() {
        const name = document.getElementById('new-product-name').value.trim();
        const price = parseFloat(document.getElementById('new-product-price').value);
        const categoryId = document.getElementById('new-product-category').value;
        if (!name || isNaN(price) || price<=0 || !categoryId) { showToast('Bitte alle Felder korrekt ausfüllen.', 'error'); return; }
        const newId = 'prod' + Date.now();
        products[newId] = { id:newId, name:name, price:price, categoryId:categoryId };
        document.getElementById('new-product-name').value=''; document.getElementById('new-product-price').value=''; document.getElementById('new-product-category').value='';
        saveProductsAndCategories();
        showToast('Produkt hinzugefügt.', 'success');
    }

    async function deleteCategory(id) {
        if (!confirm(`Soll die Kategorie "${categories[id]?.name}" und alle zugehörigen Produkte gelöscht werden?`)) return;
        Object.keys(products).forEach(prodId => { if (products[prodId].categoryId===id) delete products[prodId]; });
        delete categories[id];
        await saveProductsAndCategories();
        showToast('Kategorie und zugehörige Produkte gelöscht.', 'info');
    }

    async function deleteProduct(id) {
        if (!confirm(`Soll das Produkt "${products[id]?.name}" gelöscht werden?`)) return;
        delete products[id];
        await saveProductsAndCategories();
        showToast('Produkt gelöscht.', 'info');
    }

    function updateProductPrice(id) {
        const input = document.getElementById(`price-input-${id}`); const newPrice = parseFloat(input.value);
        if (isNaN(newPrice) || newPrice <= 0) { showToast('Ungültiger Preis.', 'error'); input.value = products[id].price.toFixed(2); return; }
        if (products[id].price === newPrice) { showToast('Keine Änderung vorgenommen.', 'info'); return; }
        products[id].price = newPrice;
        saveProductsAndCategories();
        showToast(`Preis für "${products[id].name}" aktualisiert.`, 'success');
    }

    // ---------- Bestellung & receipt ----------
    function handleQuantityInput(value) {
        lastAction = { type:'quantity', oldValue: currentQuantity };
        if (value==='clear') currentQuantity='1';
        else if (value==='set1') currentQuantity='1';
        else if (currentQuantity==='1' && value!=='0') currentQuantity = value;
        else if (currentQuantity.length < 5) currentQuantity += value;
        document.getElementById('quantity-display').innerText = currentQuantity;
    }

    function handleCashInput(value) {
        let current = cashReceivedInput;
        const decimalIndex = current.indexOf('.');
        if (value==='clear') current = '0';
        else if (value==='dot') { if (decimalIndex===-1) current += '.'; }
        else if (value.match(/[0-9]/)) {
            if (current==='0' && value!=='0' && decimalIndex===-1) current = value;
            else if (current==='0' && value==='0' && decimalIndex===-1) {}
            else current += value;
            if (decimalIndex !== -1 && current.substring(decimalIndex+1).length>2) current = cashReceivedInput;
            else if (current.replace('.','').length>7) current = cashReceivedInput;
        }
        cashReceivedInput = current;
        let displayValue = cashReceivedInput;
        if (displayValue.startsWith('.')) displayValue='0'+displayValue;
        if (displayValue==='') displayValue='0';
        document.getElementById('cash-received-display').innerText = displayValue.replace('.', ',');
        calculateChangeDisplay();
    }

    function setCashExact() {
        cashReceivedInput = totalBrutto.toFixed(2);
        document.getElementById('cash-received-display').innerText = totalBrutto.toFixed(2).replace('.', ',');
        calculateChangeDisplay();
    }
    function addCashShortcut(amount) {
        let current = parseFloat(cashReceivedInput) || 0;
        let newTotal = current + amount;
        cashReceivedInput = newTotal.toFixed(2);
        document.getElementById('cash-received-display').innerText = newTotal.toFixed(2).replace('.', ',');
        calculateChangeDisplay();
    }

    function addToBestellung(productId) {
        const product = products[productId];
        const quantity = parseInt(currentQuantity);
        if (!product || isNaN(quantity) || quantity<=0) return;
        const taxRate = userSettings.taxRate || 19.0;
        const itemPriceBrutto = product.price;
        const itemPriceNetto = itemPriceBrutto / (1 + (taxRate/100));
        const taxAmount = itemPriceBrutto - itemPriceNetto;
        for (let i=0;i<quantity;i++){
            const item = { id: Date.now()+i, name: product.name, brutto: itemPriceBrutto, netto: itemPriceNetto, tax: taxAmount, taxRate: taxRate, productId: productId };
            currentBestellung.push(item);
        }
        lastAction = { type:'add', items: currentBestellung.slice(-quantity) };
        renderReceipt();
        currentQuantity='1';
        document.getElementById('quantity-display').innerText = currentQuantity;
    }

    function deleteOneUnitOfProduct(productId) {
        const indexToRemove = currentBestellung.findIndex(item => item.productId === productId);
        if (indexToRemove !== -1) {
            currentBestellung.splice(indexToRemove,1);
            showToast('Einheit erfolgreich storniert.', 'info');
            lastAction = null;
        } else showToast('Fehler: Produkt nicht gefunden.', 'error');
        renderReceipt();
    }

    function undoLastAction() {
        if (!lastAction) { showToast('Keine letzte Aktion zum Stornieren gefunden.', 'info'); return; }
        if (lastAction.type === 'add') {
            const ids = lastAction.items.map(i=>i.id);
            const origLen = currentBestellung.length;
            currentBestellung = currentBestellung.filter(item => !ids.includes(item.id));
            if (currentBestellung.length < origLen) { showToast(`${origLen-currentBestellung.length} Artikel storniert.`, 'success'); lastAction=null; }
            else showToast('Fehler beim Stornieren der letzten Buchung.', 'error');
        } else if (lastAction.type === 'quantity') {
            currentQuantity = lastAction.oldValue;
            document.getElementById('quantity-display').innerText = currentQuantity;
            showToast('Menge zurückgesetzt.', 'success');
            lastAction = null;
        }
        renderReceipt();
    }

    function calculateTotalBrutto(){ return currentBestellung.reduce((t,i)=> t + i.brutto, 0); }

    function renderReceipt(forPrint=false, receiptType='standard') {
        const container = document.getElementById(forPrint ? 'receipt-print-content' : 'receipt-content-interactive');
        let content = '';
        totalBrutto = calculateTotalBrutto();
        const itemCounts = currentBestellung.reduce((counts,item)=>{
            if (!counts[item.productId]) counts[item.productId] = {...item, count:0};
            counts[item.productId].count++;
            return counts;
        }, {});
        if (currentBestellung.length===0) {
            content = '<p class="text-center text-sm text-gray-400 p-4">Es wurden noch keine Artikel gebucht.</p>';
        } else {
            if (forPrint) {
                content += `<div class="center font-bold">${(userSettings.companyName||'Kassensystem').toUpperCase()}</div>`;
                content += `<div class="center">${userSettings.address||''}</div>`;
                content += `<div class="center">Ust-IdNr.: ${userSettings.taxId||''}</div>`;
                content += '<div>----------------------------------------</div>';
                if (receiptType === 'bewirtung') {
                    content += "<div class='center font-bold text-lg'>*** BEWIRTUNGSBELEG ***</div><div>----------------------------------------</div>";
                }
                content += `<div class="line"><strong>POS. Bezeichnung</strong><strong class="item-price">Preis €</strong></div>`;
                content += '<div>----------------------------------------</div>';
                Object.values(itemCounts).forEach(item => {
                    const priceTotal = (item.brutto*item.count).toFixed(2).replace('.', ',');
                    const nameDisplay = `${item.count}x ${item.name}`;
                    content += `<div class="line"><span class="item-name">${nameDisplay}</span><span class="item-price">${priceTotal}</span></div>`;
                });
                content += '<div>========================================</div>';
                content += `<div class="line"><strong>SUMME BRUTTO</strong><strong>${totalBrutto.toFixed(2).replace('.', ',')} €</strong></div>`;
                content += '<div>========================================</div>';
                content += `<div class="center">Beleg erstellt am:</div><div class="center">${new Date().toLocaleString('de-DE')}</div>`;
                content += `<div class="center">Transaktion ID: ${new Date().getTime().toString().slice(-6)}</div>`;
                content += '<div class="center font-bold mt-2">Vielen Dank!</div>';
            } else {
                Object.values(itemCounts).forEach(item => {
                    const price = (item.brutto * item.count).toFixed(2).replace('.', ',');
                    content += `
                        <div class="flex justify-between items-center py-1 border-b border-gray-100">
                            <span class="font-semibold">${item.count}x ${item.name}</span>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold">${price} €</span>
                                <button onclick="deleteOneUnitOfProduct('${item.productId}')" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full text-xs">
                                    ✖
                                </button>
                            </div>
                        </div>`;
                });
            }
        }
        document.getElementById('total-display').innerText = `GESAMT: ${totalBrutto.toFixed(2).replace('.', ',')} €`;
        container.innerHTML = content;
    }

    function resetBestellung() {
        currentBestellung=[]; lastAction=null; currentQuantity='1'; document.getElementById('quantity-display').innerText=currentQuantity; renderReceipt(); showToast('Bestellung zurückgesetzt.', 'info');
    }

    // ---------- Payments & finalize ----------
    function setPaymentMethod(method) {
        selectedPaymentMethod = method;
        const btnKarte = document.getElementById('btn-karte');
        const cashArea = document.getElementById('cash-payment-area');
        const btnBarIndicator = document.getElementById('btn-bar-indicator');
        const cashFinalizeBtns = document.getElementById('cash-finalize-buttons');
        const cardFinalizeBtns = document.getElementById('card-finalize-buttons');

        if (method==='BAR') {
            cashArea.style.display='block';
            btnBarIndicator.style.display='inline-block';
            cashFinalizeBtns.style.display='block'; cardFinalizeBtns.style.display='none';
        } else {
            cashArea.style.display='none';
            btnBarIndicator.style.display='none';
            cashFinalizeBtns.style.display='none'; cardFinalizeBtns.style.display='block';
            document.getElementById('change-display').innerText='0,00 €';
        }
        calculateChangeDisplay();
    }

    function calculateChangeDisplay() {
        const received = parseFloat(cashReceivedInput) || 0;
        const change = received - totalBrutto;
        const changeDisplay = document.getElementById('change-display');
        changeDisplay.innerText = change >= 0 ? change.toFixed(2).replace('.', ',') + ' €' : 'FEHLT';
        const canFinalizeCash = (selectedPaymentMethod === 'BAR' && change >= 0);

        const btnNone = document.getElementById('btn-cash-none');
        const btnStandard = document.getElementById('btn-cash-standard');
        const btnBewirtung = document.getElementById('btn-cash-bewirtung');
        if (btnNone && btnStandard && btnBewirtung) {
            btnNone.disabled = !canFinalizeCash; btnStandard.disabled = !canFinalizeCash; btnBewirtung.disabled = !canFinalizeCash;
            if (canFinalizeCash) {
                btnNone.classList.add('bg-red-600'); btnNone.classList.remove('bg-red-400');
                btnStandard.classList.add('bg-green-600'); btnStandard.classList.remove('bg-green-400');
                btnBewirtung.classList.add('bg-red-700'); btnBewirtung.classList.remove('bg-red-600/70');
            } else {
                btnNone.classList.add('bg-red-400'); btnStandard.classList.add('bg-green-400'); btnBewirtung.classList.add('bg-red-600/70');
            }
        }
    }

    async function handleFinalizeAction(method, receiptType) {
        if (method === 'BAR') {
            const received = parseFloat(cashReceivedInput) || 0;
            const change = received - totalBrutto;
            if (change < 0) { showToast('Der erhaltene Betrag ist zu gering.', 'error'); return; }
            showToast(`Transaktion (BAR) abgeschlossen! Rückgeld: ${change.toFixed(2).replace('.', ',')} €`, 'success');
            if (receiptType === 'standard') printReceipt('standard'); else if (receiptType === 'bewirtung') printReceipt('bewirtung');
            await finalizeTransaction('BAR');
        } else if (method === 'KARTE') {
            showToast('Transaktion (KARTE) abgeschlossen!', 'success');
            if (receiptType === 'standard') printReceipt('standard'); else if (receiptType === 'bewirtung') printReceipt('bewirtung');
            await finalizeTransaction('KARTE');
        }
    }

    async function openFinalizeModal() {
        if (currentBestellung.length===0) { showToast('Bitte erst Artikel buchen.', 'error'); return; }
        totalBrutto = calculateTotalBrutto();
        document.getElementById('finalize-total').innerText = totalBrutto.toFixed(2).replace('.', ',') + ' €';
        cashReceivedInput = '0';
        document.getElementById('cash-received-display').innerText = '0,00';
        setPaymentMethod('BAR');
        document.getElementById('finalize-modal').style.display = 'flex';
    }

    async function finalizeTransaction(paymentMethod) {
        showLoading(true);
        if (currentBestellung.length === 0) { showToast('Keine Artikel für die Transaktion.', 'error'); showLoading(false); return; }
        const tx = {
            id: Date.now().toString(),
            timestamp: new Date().toISOString(),
            totalBrutto: calculateTotalBrutto(),
            items: currentBestellung,
            paymentMethod
        };
        await saveTransaction(tx);
        resetBestellung();
        closeModal('finalize-modal');
        showLoading(false);
    }

    function printReceipt(receiptType='standard') {
        if (currentBestellung.length === 0) { showToast('Keine Artikel für den Beleg.', 'error'); return; }
        const printArea = document.createElement('div'); printArea.className='receipt-print'; printArea.id='receipt-print-area';
        const contentContainer = document.createElement('div'); contentContainer.id='receipt-print-content';
        printArea.appendChild(contentContainer); document.body.appendChild(printArea);
        renderReceipt(true, receiptType);
        setTimeout(()=>{ window.print(); document.body.removeChild(printArea); }, 300);
    }

    // ---------- Transaction reversal ----------
    function openTransactionReversalModal() {
        const listContainer = document.getElementById('transaction-list');
        listContainer.innerHTML = '';
        if (!transactionHistory || transactionHistory.length===0) {
            listContainer.innerHTML = '<p class="text-gray-500">Keine abgeschlossenen Transaktionen gefunden.</p>';
            document.getElementById('transaction-reversal-modal').style.display='flex';
            toggleReceiptColumn(false);
            return;
        }
        const recent = transactionHistory.slice(0,10);
        recent.forEach(tx => {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-3 bg-red-50 rounded-lg border';
            item.innerHTML = `<div><span class="font-bold text-lg">${tx.totalBrutto.toFixed(2).replace('.', ',')} €</span><div class="text-xs text-gray-500">${new Date(tx.timestamp).toLocaleString('de-DE')}</div></div><div><button class="p-2 rounded-lg text-white bg-red-600" onclick="reverseTransaction('${tx.id}')">Storno</button></div>`;
            listContainer.appendChild(item);
        });
        document.getElementById('transaction-reversal-modal').style.display='flex';
        toggleReceiptColumn(false);
    }

    async function reverseTransaction(txId) {
        if (!confirm('Transaktion wirklich stornieren?')) return;
        try {
            await remove(child(rootRef, transactionsRefPath + '/' + txId));
            // reload history
            await loadTransactionHistory();
            openTransactionReversalModal();
            showToast('Transaktion storniert.', 'success');
        } catch(e) {
            console.error(e); showToast('Fehler beim Stornieren: ' + e.message, 'error');
        }
    }

    // ---------- Settings ----------
    function openSettingsModal() {
        document.getElementById('company-name').value = userSettings.companyName || '';
        document.getElementById('address').value = userSettings.address || '';
        document.getElementById('tax-id').value = userSettings.taxId || '';
        document.getElementById('tax-rate').value = userSettings.taxRate || 19.0;
        toggleReceiptColumn(false);
        document.getElementById('settings-modal').style.display='flex';
    }

    async function saveSettings() {
        userSettings.companyName = document.getElementById('company-name').value;
        userSettings.address = document.getElementById('address').value;
        userSettings.taxId = document.getElementById('tax-id').value;
        userSettings.taxRate = parseFloat(document.getElementById('tax-rate').value) || 19.0;
        // save locally and to DB
        try {
            await set(child(rootRef, settingsRefPath), userSettings);
        } catch(e) {
            console.error(e);
            // fallback local
            localStorage.setItem('companyName', userSettings.companyName);
            localStorage.setItem('address', userSettings.address);
            localStorage.setItem('taxId', userSettings.taxId);
            localStorage.setItem('taxRate', userSettings.taxRate);
        }
        showToast('Einstellungen gespeichert.', 'success');
        closeModal('settings-modal');
    }

    // ---------- Reports ----------
    function setReportDateToday() { document.getElementById('report-date').value = new Date().toISOString().slice(0,10); }
    async function runDailyReport(mode='report') {
        // collects transactions for selected day and either opens a printable report or makes a CSV
        const dateStr = document.getElementById('report-date').value || new Date().toISOString().slice(0,10);
        const start = new Date(dateStr + 'T00:00:00.000Z');
        const end = new Date(dateStr + 'T23:59:59.999Z');

        // Filter local cache first, if empty fetch full transactions
        if (!transactionHistory || transactionHistory.length===0) await loadTransactionHistory();

        const dayTx = transactionHistory.filter(tx => {
            const t = new Date(tx.timestamp);
            return t >= start && t <= end;
        });

        if (mode==='csv') {
            // build CSV
            let csv = 'id;timestamp;totalBrutto;paymentMethod;items\n';
            dayTx.forEach(tx => {
                const items = tx.items.map(i => `${i.name} x`).join('|');
                csv += `${tx.id};${tx.timestamp};${tx.totalBrutto};${tx.paymentMethod};"${items}"\n`;
            });
            // download
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href=url; a.download = `report_${dateStr}.csv`; a.click();
            URL.revokeObjectURL(url);
            showToast('CSV heruntergeladen.', 'success');
        } else {
            // show a simple info modal with summary
            const total = dayTx.reduce((s,tx)=> s + (tx.totalBrutto||0),0);
            const txt = `Bericht für ${dateStr}\nTransaktionen: ${dayTx.length}\nUmsatz: ${total.toFixed(2).replace('.',',')} €\n\nDetails:\n` + dayTx.map(tx => `${new Date(tx.timestamp).toLocaleString('de-DE')} — ${tx.totalBrutto.toFixed(2).replace('.',',')} € (${tx.paymentMethod})`).join('\n');
            document.getElementById('info-title').innerText = 'Tagesbericht';
            document.getElementById('info-text').innerText = txt;
            document.getElementById('info-modal').style.display='flex';
            toggleReceiptColumn(false);
        }
    }

    // ---------- Initialization ----------
    async function initApp() {
        showLoading(true);
        try {
            await loadSettings();
            await loadProductsAndCategories();
            await loadTransactionHistory();
            DB_STATUS = 'connected';
            updateDBStatus(true);
        } catch(e) {
            console.error('initApp error', e);
            updateDBStatus(false);
            showToast('Datenbankfehler beim Start: ' + (e.message||e), 'error');
        } finally { showLoading(false); }
    }

    // Auth state observer -> switch view
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // user logged in
            document.getElementById('login-modal').style.display='none';
            document.getElementById('kasse-content').style.display='block';
            toggleReceiptColumn(true);
            // ensure app data loaded
            await initApp();
            showToast('Willkommen!', 'success');
        } else {
            // not logged in
            document.getElementById('kasse-content').style.display='none';
            document.getElementById('login-modal').style.display='flex';
            toggleReceiptColumn(false);
        }
    });

    // Initial render
    document.addEventListener('DOMContentLoaded', () => {
        // set defaults to UI
        document.getElementById('quantity-display').innerText = currentQuantity;
        renderReceipt();
    });

    // expose functions on window for inline onclicks (UI uses them)
    window.handleLoginSubmit = handleLoginSubmit;
    window.handleRegisterSubmit = handleRegisterSubmit;
    window.handlePasswordReset = handlePasswordReset;
    window.handleLogout = handleLogout;
    window.openRegistrationModal = openRegistrationModal;
    window.openForgotPasswordModal = openForgotPasswordModal;
    window.openProductModal = openProductModal;
    window.addCategory = addCategory;
    window.addProduct = addProduct;
    window.deleteCategory = deleteCategory;
    window.deleteProduct = deleteProduct;
    window.updateProductPrice = updateProductPrice;
    window.handleQuantityInput = handleQuantityInput;
    window.handleCashInput = handleCashInput;
    window.setCashExact = setCashExact;
    window.addCashShortcut = addCashShortcut;
    window.addToBestellung = addToBestellung;
    window.deleteOneUnitOfProduct = deleteOneUnitOfProduct;
    window.undoLastAction = undoLastAction;
    window.renderReceipt = renderReceipt;
    window.resetBestellung = resetBestellung;
    window.openFinalizeModal = openFinalizeModal;
    window.setPaymentMethod = setPaymentMethod;
    window.calculateChangeDisplay = calculateChangeDisplay;
    window.handleFinalizeAction = handleFinalizeAction;
    window.openTransactionReversalModal = openTransactionReversalModal;
    window.reverseTransaction = reverseTransaction;
    window.openSettingsModal = openSettingsModal;
    window.saveSettings = saveSettings;
    window.setReportDateToday = setReportDateToday;
    window.runDailyReport = runDailyReport;
    window.closeModal = closeModal;
    window.printReceipt = printReceipt;

    // Kick off initial load of settings/products when offline or before auth change
    initApp();

    </script>
</body>
</html>
