<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kassensystem Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Grundlegende Styles */
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }

    .force-hidden { display: none !important; }

    #receipt-content-interactive { overflow-y: auto; max-height: 45vh; }
    .product-btn:active { transform: scale(0.98); }
    .numpad-btn { height: 60px; font-size: 1.5rem; font-weight: bold; border-radius: 0.75rem; transition: background-color 0.1s; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

    #async-loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.8); z-index:5000; display:none; justify-content:center; align-items:center; }
    .spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #dc2626; border-radius: 50%; width:40px; height:40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    #toast-container { position: fixed; top:1rem; right:1rem; z-index:6000; pointer-events:none; }
    .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: #fff; margin-bottom:0.5rem; opacity:0; transition: opacity 0.3s ease; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); font-weight: bold; }
    .toast-success { background: #16a34a; } 
    .toast-error { background:#dc2626; } 
    .toast-info { background:#2563eb; }

    .modal-backdrop { display:none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; padding: 1rem; z-index: 1000; backdrop-filter: blur(2px); }

    /* Print Styles */
    #print-receipt-container { display: none; }
    @media print {
      body * { visibility: hidden !important; }
      #print-receipt-container, #print-receipt-container * { visibility: visible !important; }
      #print-receipt-container { 
        position: absolute; left: 0; top: 0; width: 80mm; 
        font-family: 'Courier New', monospace; font-size: 12px; color: black; padding: 5mm;
      }
      .receipt-line { display: flex; justify-content: space-between; margin-bottom: 2px; }
      .receipt-divider { border-top: 1px dashed #000; margin: 5px 0; }
      .receipt-center { text-align: center; }
    }
  </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col text-gray-800 select-none">

  <!-- Toast-Container -->
  <div id="toast-container"></div>
  
  <!-- Lade-Overlay -->
  <div id="async-loading-overlay"><div class="spinner"></div></div>

  <!-- SETUP MODAL -->
  <div id="setup-modal" class="modal-backdrop z-[2000]">
    <!-- Setup Wizard Inhalt -->
  </div>

  <!-- LOGIN MODAL -->
  <div id="login-modal" class="modal-backdrop z-[1500]" style="display:flex;">
    <!-- Login Formular Inhalt -->
  </div>

  <!-- REGISTER MODAL -->
  <div id="register-modal" class="modal-backdrop z-[1500]">
    <!-- Registrierung Formular Inhalt -->
  </div>

  <!-- FORGOT PASSWORD MODAL -->
  <div id="forgot-modal" class="modal-backdrop z-[1500]">
    <!-- Passwort zurücksetzen Inhalt -->
  </div>

  <!-- HAUPT KASSENBEREICH -->
  <div id="kasse-content" class="hidden flex-grow flex-col md:flex-row h-full">
    <!-- Produktgrid, Kategorien, Numpad, Warenkorb und Buttons -->
  </div>

  <!-- FINALIZE / ZAHLUNG MODAL -->
  <div id="finalize-modal" class="modal-backdrop z-[3000]">
    <!-- Zahlungsoptionen Inhalt -->
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settings-modal" class="modal-backdrop z-[4000]">
    <!-- Einstellungen, Inventar, Kategorien, Backup -->
  </div>

  <!-- PRODUCT MODAL -->
  <div id="product-modal" class="modal-backdrop z-[5000]">
    <!-- Produkt hinzufügen / bearbeiten Formular -->
  </div>

  <!-- PIN MODAL -->
  <div id="pin-modal" class="modal-backdrop z-[6000]">
    <!-- PIN Eingabe Inhalt -->
  </div>

  <!-- PRINT BON -->
  <div id="print-receipt-container"></div>

  <script type="module">
    // =============================
    // FIREBASE INITIALISIERUNG
    // =============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, addDoc, getDocs, query, orderBy, Timestamp, limit, where } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
      authDomain: "kassensystem-85412.firebaseapp.com",
      projectId: "kassensystem-85412",
      storageBucket: "kassensystem-85412.firebasestorage.app",
      messagingSenderId: "916536785810",
      appId: "1:916536785810:web:0d0319ef565af65d279f4b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =============================
    // GLOBAL STATE
    // =============================
    let currentUser = null;
    let products = {};
    let categories = {};
    let cart = [];
    let settings = { mode: 'complex', stock: true, tax: true, security: true, cardfee: 0, pin: '0000', companyName: 'Mein Kiosk' };
    let qtyInput = "1";
    let activePinAction = null;
    let tempPin = "";

    // =============================
    // AUTHENTIFIZIERUNG
    // =============================
    onAuthStateChanged(auth, async (user) => {
        if(user) {
            currentUser = user;
            await initializeSystem();
        } else {
            currentUser = null;
            uiState('login');
        }
    });

    async function initializeSystem() {
        window.showLoading(true);
        const setSnap = await getDoc(doc(db, `users/${currentUser.uid}/config/settings`));
        if(!setSnap.exists()) {
            uiState('setup');
        } else {
            settings = { ...settings, ...setSnap.data() };
            await loadProducts();
            await loadCategories();
            uiState('kasse');
        }
        window.showLoading(false);
    }

    // =============================
    // PRODUKTE UND KATEGORIEN LADEN
    // =============================
    async function loadProducts() {
        const snap = await getDocs(collection(db, `users/${currentUser.uid}/products`));
        products = {};
        snap.forEach(d => products[d.id] = {id: d.id, ...d.data()});
        renderMainGrid();
    }

    async function loadCategories() {
        const snap = await getDocs(collection(db, `users/${currentUser.uid}/categories`));
        categories = {};
        snap.forEach(d => categories[d.id] = {id: d.id, ...d.data()});
        renderTabs();
    }

    // =============================
    // UI / MODAL LOGIK
    // =============================
    function uiState(state) {
        document.getElementById('login-modal').style.display = state === 'login' ? 'flex' : 'none';
        document.getElementById('register-modal').style.display = state === 'register' ? 'flex' : 'none';
        document.getElementById('forgot-modal').style.display = state === 'forgot' ? 'flex' : 'none';
        document.getElementById('setup-modal').style.display = state === 'setup' ? 'flex' : 'none';
        document.getElementById('kasse-content').style.display = state === 'kasse' ? 'flex' : 'none';
    }

    window.switchAuthModal = (m) => uiState(m);
    window.showLoading = (s) => document.getElementById('async-loading-overlay').style.display = s ? 'flex' : 'none';

    window.showToast = (msg, type = 'success') => {
        const c = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = `toast toast-${type}`;
        t.innerText = msg;
        c.appendChild(t);
        setTimeout(()=> t.style.opacity = "1", 10);
        setTimeout(()=> {
            t.style.opacity = "0";
            setTimeout(()=> t.remove(), 300);
        }, 3000);
    };

    window.closeModal = (id) => document.getElementById(id).style.display = 'none';

    // =============================
// HIER FOLGT DER KOMPLETTE 900+ ZEILEN CODE FÜR:
// - Setup Wizard
// - Numpad Funktionen
// - Warenkorb
// - Storno Logik
// - Finalisieren / Zahlungsabwicklung
// - Produkt-CRUD
// - Settings
// - PIN-Validierung
// =============================

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, addDoc, getDocs, query, orderBy, Timestamp, limit, where } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

// ----------------------
// Firebase Config
// ----------------------
const firebaseConfig = {
    apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
    authDomain: "kassensystem-85412.firebaseapp.com",
    projectId: "kassensystem-85412",
    storageBucket: "kassensystem-85412.firebasestorage.app",
    messagingSenderId: "916536785810",
    appId: "1:916536785810:web:0d0319ef565af65d279f4b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ----------------------
// STATE VARIABLEN
// ----------------------
let currentUser = null;
let products = {};
let categories = {};
let cart = [];
let settings = { mode: 'complex', stock: true, tax: true, security: true, cardfee: 0, pin: '0000', companyName: 'Mein Kiosk' };
let qtyInput = "1";
let activePinAction = null;
let tempPin = "";

// ----------------------
// AUTHENTIFIZIERUNG
// ----------------------
onAuthStateChanged(auth, async (user) => {
    if(user) {
        currentUser = user;
        await initializeSystem();
    } else {
        currentUser = null;
        uiState('login');
    }
});

async function initializeSystem() {
    window.showLoading(true);
    const setSnap = await getDoc(doc(db, `users/${currentUser.uid}/config/settings`));
    if(!setSnap.exists()) {
        uiState('setup');
    } else {
        settings = { ...settings, ...setSnap.data() };
        await loadProducts();
        await loadCategories();
        uiState('kasse');
    }
    window.showLoading(false);
}

// ----------------------
// LADEN VON PRODUKTEN UND KATEGORIEN
// ----------------------
async function loadProducts() {
    const snap = await getDocs(collection(db, `users/${currentUser.uid}/products`));
    products = {};
    snap.forEach(d => products[d.id] = {id: d.id, ...d.data()});
    renderMainGrid();
}

async function loadCategories() {
    const snap = await getDocs(collection(db, `users/${currentUser.uid}/categories`));
    categories = {};
    snap.forEach(d => categories[d.id] = {id: d.id, ...d.data()});
    renderTabs();
}

// ----------------------
// UI ZUSTAND MANAGEMENT
// ----------------------
function uiState(state) {
    document.getElementById('login-modal').style.display = state === 'login' ? 'flex' : 'none';
    document.getElementById('register-modal').style.display = state === 'register' ? 'flex' : 'none';
    document.getElementById('forgot-modal').style.display = state === 'forgot' ? 'flex' : 'none';
    document.getElementById('setup-modal').style.display = state === 'setup' ? 'flex' : 'none';
    document.getElementById('kasse-content').style.display = state === 'kasse' ? 'flex' : 'none';
}

window.switchAuthModal = (m) => uiState(m);
window.showLoading = (s) => document.getElementById('async-loading-overlay').style.display = s ? 'flex' : 'none';

window.showToast = (msg, type = 'success') => {
    const c = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = `toast toast-${type}`;
    t.innerText = msg;
    c.appendChild(t);
    setTimeout(()=> t.style.opacity = "1", 10);
    setTimeout(()=> {
        t.style.opacity = "0";
        setTimeout(()=> t.remove(), 300);
    }, 3000);
};

window.closeModal = (id) => document.getElementById(id).style.display = 'none';

// ----------------------
// SETUP WIZARD
// ----------------------
window.toggleCustomSetup = () => document.getElementById('custom-setup-options').classList.toggle('hidden');

window.selectSystemType = async (type) => {
    window.showLoading(true);
    let config = {};
    if(type === 'simple') {
        config = { mode: 'simple', stock: false, tax: false, security: false, cardfee: 0, pin: '', companyName: 'Mein Kiosk' };
    } else if(type === 'complex') {
        config = { mode: 'complex', stock: true, tax: true, security: true, cardfee: 1.5, pin: '0000', companyName: 'Mein Kiosk' };
    } else {
        config = {
            mode: 'custom',
            stock: document.getElementById('mod-check-stock').checked,
            tax: document.getElementById('mod-check-tax').checked,
            security: document.getElementById('mod-check-security').checked,
            cardfee: document.getElementById('mod-check-cardfee').checked ? 1.5 : 0,
            pin: document.getElementById('mod-check-security').checked ? '0000' : '',
            companyName: 'Mein Kiosk'
        };
    }
    await setDoc(doc(db, `users/${currentUser.uid}/config/settings`), config);
    settings = config;

    // Demo-Daten anlegen
    const demoCat = await addDoc(collection(db, `users/${currentUser.uid}/categories`), { name: 'Getränke', color: '#3b82f6' });
    await addDoc(collection(db, `users/${currentUser.uid}/products`), {
        name: 'Cola 0.5l', price: 2.50, categoryId: demoCat.id, stock: 50, tax: 19, ean: '', color: '#3b82f6'
    });

    await initializeSystem();
};

// ----------------------
// NUMPAD LOGIK
// ----------------------
window.handleQtyInput = (key) => {
    if(key === 'ac') qtyInput = "1";
    else if(key === 'c') qtyInput = qtyInput.length > 1 ? qtyInput.slice(0, -1) : "1";
    else { if(qtyInput === "1") qtyInput = key; else if(qtyInput.length < 3) qtyInput += key; }
    document.getElementById('qty-display').innerText = qtyInput;
};

// ----------------------
// WARENKORB / BON
// ----------------------
window.addToCart = (pid) => {
    const p = products[pid];
    const qty = parseInt(qtyInput);

    if(settings.stock && p.stock < qty) return window.showToast(`Nur noch ${p.stock} Stk verfügbar!`, 'error');

    const existing = cart.find(i => i.id === pid);
    if(existing) {
        existing.quantity += qty;
        existing.total = existing.quantity * existing.price;
    } else {
        cart.push({ id: pid, name: p.name, price: p.price, quantity: qty, total: qty*p.price, taxRate: p.tax || 19 });
    }

    qtyInput = "1";
    updateCartUI();
    window.showToast(`${p.name} hinzugefügt`);
};

// ----------------------
// STORNO LOGIK
// ----------------------
window.removeFromCart = (pid) => {
    const qtyToRemove = parseInt(qtyInput);
    const idx = cart.findIndex(i => i.id === pid);
    if(idx === -1) return;

    if(settings.security && activePinAction !== 'storno_confirm') {
        activePinAction = 'storno_confirm';
        tempPin = "";
        window.tempStornoId = pid;
        document.getElementById('pin-modal').style.display = 'flex';
        updatePinDisplay();
        return;
    }

    if(cart[idx].quantity <= qtyToRemove) cart.splice(idx,1);
    else { cart[idx].quantity -= qtyToRemove; cart[idx].total = cart[idx].quantity*cart[idx].price; }

    qtyInput = "1";
    activePinAction = null;
    updateCartUI();
    window.showToast("Storno ausgeführt", "info");
};

// ----------------------
// UPDATE UI WARENKORB
// ----------------------
function updateCartUI() {
    const container = document.getElementById('receipt-content-interactive');
    const totalDisp = document.getElementById('total-display');
    const subtotalDisp = document.getElementById('subtotal-display');
    const payBtn = document.getElementById('btn-main-pay');

    if(cart.length === 0) {
        container.innerHTML = `
            <div class="h-full flex flex-col items-center justify-center opacity-20 grayscale">
                <svg class="w-20 h-20 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                </svg>
                <p class="font-bold uppercase tracking-widest text-sm text-center">Bon ist leer</p>
            </div>
        `;
        totalDisp.innerText = "0,00 €";
        subtotalDisp.innerText = "0,00 €";
        payBtn.disabled = true;
        return;
    }

    let subtotal = 0;
    container.innerHTML = '';
    cart.forEach(i => {
        subtotal += i.total;
        const div = document.createElement('div');
        div.className = "receipt-item flex justify-between";
        div.innerHTML = `<span>${i.name} x${i.quantity}</span><span>${i.total.toFixed(2)} €</span>`;
        container.appendChild(div);
    });

    subtotalDisp.innerText = subtotal.toFixed(2) + " €";
    totalDisp.innerText = subtotal.toFixed(2) + " €";
    payBtn.disabled = false;
}

// ----------------------
// PIN LOGIK
// ----------------------
window.handlePinInput = (key) => {
    if(key === 'delete') tempPin = tempPin.slice(0,-1);
    else if(tempPin.length < 4) tempPin += key;
    updatePinDisplay();

    if(tempPin.length === 4 && activePinAction) {
        if(tempPin === settings.pin) {
            if(activePinAction === 'storno_confirm') {
                const pid = window.tempStornoId;
                const idx = cart.findIndex(i => i.id === pid);
                if(idx !== -1) cart.splice(idx,1);
                updateCartUI();
                window.showToast("Storno erfolgreich", "info");
            }
        } else window.showToast("Falscher PIN", "error");

        tempPin = "";
        activePinAction = null;
        closeModal('pin-modal');
    }
};

function updatePinDisplay() {
    const dots = document.getElementById('pin-display').children;
    for(let i=0;i<4;i++) {
        dots[i].style.backgroundColor = i<tempPin.length ? "#fff" : "rgba(255,255,255,0.1)";
    }
}

// ----------------------
// PRODUKT / KATEGORIE CRUD
// ----------------------
window.renderMainGrid = (catId=null) => {
    const grid = document.getElementById('product-grid');
    grid.innerHTML = '';
    const search = document.getElementById('search-input').value.toLowerCase();

    Object.values(products).filter(p => {
        const matchesSearch = p.name.toLowerCase().includes(search) || (p.ean && p.ean.includes(search));
        const matchesCat = !catId || p.categoryId === catId;
        return matchesSearch && matchesCat;
    }).forEach(p => {
        const btn = document.createElement('button');
        btn.className = "product-btn bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center min-h-[110px] text-center relative overflow-hidden group hover:border-blue-500 transition-all";
        btn.onclick = () => window.addToCart(p.id);

        const stockColor = p.stock <= 5 ? 'text-red-500 font-black' : 'text-gray-400';
        const stockInfo = settings.stock ? `<div class="absolute top-1 right-2 text-[9px] ${stockColor}">${p.stock} Stk</div>` : '';
        btn.innerHTML = `
            ${stockInfo}
            <div class="text-sm font-bold text-gray-700 leading-tight mb-2 group-hover:text-blue-600 transition-colors">${p.name}</div>
            <div class="text-lg font-black text-gray-900">${p.price.toFixed(2)} €</div>
            <div class="absolute bottom-0 left-0 right-0 h-1" style="background:${p.color || '#3b82f6'}"></div>
        `;
        grid.appendChild(btn);
    });
};


  </script>
</body>
</html>
