<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Kassensystem FH-Erfurt | Professional</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; user-select: none; }
    #receipt-content-interactive { overflow-y: auto; max-height: 40vh; }
    .product-btn:active { transform: scale(0.98); }
    .numpad-btn { height: 50px; display:flex; justify-content:center; align-items:center; border: 1px solid #e5e7eb; border-radius: 8px; font-weight: bold; background: white; }
    .numpad-btn:active { background-color: #f3f4f6; transform: scale(0.95); }
    
    #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 10000; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; }
    .toast { background: #1f2937; color: white; padding: 0.75rem 1.25rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease-out; pointer-events: auto; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    #async-loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: none; justify-content: center; align-items: center; }
    .spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #b91c1c; border-radius: 50%; width:40px; height:40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    @media print {
      body * { visibility: hidden !important; }
      #print-receipt-container { visibility: visible !important; display: block !important; position: absolute !important; left: 0 !important; top: 0 !important; width: 80mm !important; }
    }
  </style>
</head>
<body class="min-h-screen">

  <div id="toast-container"></div>
  <div id="async-loading-overlay"><div class="spinner"></div></div>

  <div id="login-modal" class="fixed inset-0 bg-white z-[5000] flex items-center justify-center p-4">
    <div class="max-w-md w-full p-8 border rounded-3xl shadow-2xl">
      <h1 class="text-3xl font-black text-center text-red-600 mb-6 uppercase">Kassensystem</h1>
      <form id="login-form">
        <input type="email" id="login-email" placeholder="E-Mail" class="w-full p-4 mb-3 bg-gray-50 rounded-2xl border" required>
        <input type="password" id="login-password" placeholder="Passwort" class="w-full p-4 mb-6 bg-gray-50 rounded-2xl border" required>
        <button type="submit" class="w-full bg-red-600 text-white py-4 rounded-2xl font-bold shadow-lg">Anmelden</button>
        <button type="button" onclick="window.updateAppView('register')" class="w-full mt-4 text-gray-400 font-bold text-xs uppercase">Konto erstellen</button>
      </form>
    </div>
  </div>

  <div id="register-modal" class="fixed inset-0 bg-white z-[5000] hidden flex items-center justify-center p-4">
    <div class="max-w-md w-full p-8 border rounded-3xl shadow-2xl">
      <h2 class="text-2xl font-bold mb-4">Registrierung</h2>
      <form id="register-form">
        <input type="email" id="reg-email" placeholder="E-Mail" class="w-full p-4 mb-3 bg-gray-50 rounded-2xl border" required>
        <input type="password" id="reg-password" placeholder="Passwort" class="w-full p-4 mb-3 bg-gray-50 rounded-2xl border" required>
        <label class="block text-xs font-bold text-gray-400 mb-1 ml-1">KASSENTYP</label>
        <select id="reg-system-type" class="w-full p-4 mb-6 bg-gray-50 rounded-2xl border font-bold">
          <option value="complete">Vollst√§ndig (Alle Funktionen + PIN)</option>
          <option value="simple">Einfach (Schnellkasse, kein PIN)</option>
        </select>
        <button type="submit" class="w-full bg-green-600 text-white py-4 rounded-2xl font-bold">Konto erstellen</button>
        <button type="button" onclick="window.updateAppView('login')" class="w-full mt-4 text-gray-400 font-bold">Zur√ºck</button>
      </form>
    </div>
  </div>

  <div id="kasse-content" class="hidden min-h-screen flex flex-col md:flex-row gap-4 p-4">
    <div class="flex-1 flex flex-col min-h-0">
      <div id="category-container" class="flex gap-2 mb-4 overflow-x-auto pb-2"></div>
      <div id="product-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 overflow-y-auto pr-2">
         </div>
    </div>

    <div class="w-full md:w-[450px] bg-white rounded-3xl shadow-xl flex flex-col p-6 border">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-black uppercase">Bon</h2>
        <button onclick="window.clearCart()" class="text-[10px] bg-gray-100 px-3 py-1 rounded font-bold">AC</button>
      </div>

      <div id="receipt-content-interactive" class="flex-1 space-y-2 mb-4 border-b pb-4">
        </div>

      <div class="grid grid-cols-5 gap-1 mb-4">
        <button onclick="window.handleQuantityInput('7')" class="numpad-btn">7</button>
        <button onclick="window.handleQuantityInput('8')" class="numpad-btn">8</button>
        <button onclick="window.handleQuantityInput('9')" class="numpad-btn">9</button>
        <button onclick="window.handleQuantityInput('11')" class="numpad-btn bg-blue-50 text-blue-600">11</button>
        <button onclick="window.handleQuantityInput('12')" class="numpad-btn bg-blue-50 text-blue-600">12</button>
        <button onclick="window.handleQuantityInput('4')" class="numpad-btn">4</button>
        <button onclick="window.handleQuantityInput('5')" class="numpad-btn">5</button>
        <button onclick="window.handleQuantityInput('6')" class="numpad-btn">6</button>
        <button onclick="window.handleQuantityInput('13')" class="numpad-btn bg-blue-50 text-blue-600">13</button>
        <button onclick="window.handleQuantityInput('14')" class="numpad-btn bg-blue-50 text-blue-600">14</button>
        <button onclick="window.handleQuantityInput('1')" class="numpad-btn">1</button>
        <button onclick="window.handleQuantityInput('2')" class="numpad-btn">2</button>
        <button onclick="window.handleQuantityInput('3')" class="numpad-btn">3</button>
        <button onclick="window.handleQuantityInput('15')" class="numpad-btn bg-blue-50 text-blue-600">15</button>
        <button onclick="window.handleQuantityInput('16')" class="numpad-btn bg-blue-50 text-blue-600">16</button>
        <button onclick="window.handleQuantityInput('clear')" class="numpad-btn bg-red-500 text-white">C</button>
        <button onclick="window.handleQuantityInput('0')" class="numpad-btn">0</button>
        <button onclick="window.handleQuantityInput('17')" class="numpad-btn bg-blue-50 text-blue-600">17</button>
        <button onclick="window.handleQuantityInput('18')" class="numpad-btn bg-blue-50 text-blue-600">18</button>
        <button onclick="window.handleQuantityInput('19')" class="numpad-btn bg-blue-50 text-blue-600">19</button>
      </div>

      <div class="bg-gray-50 p-4 rounded-2xl mb-4">
        <div class="flex justify-between items-center">
          <span class="text-xs font-bold text-gray-400">MENGE: <span id="qty-display" class="text-red-600">1</span></span>
          <span id="grand-total" class="text-3xl font-black text-gray-800">0,00 ‚Ç¨</span>
        </div>
      </div>

      <button onclick="window.openPaymentModal()" class="w-full bg-red-600 text-white py-5 rounded-3xl font-bold shadow-lg mb-2">ZAHLUNG</button>
      
      <div class="grid grid-cols-2 gap-2">
        <button onclick="window.updateAppView('settings')" class="py-3 text-[10px] font-bold uppercase text-gray-500 border rounded-xl">‚öôÔ∏è Einstellungen</button>
        <button onclick="window.updateAppView('reports')" class="py-3 text-[10px] font-bold uppercase text-gray-500 border rounded-xl">üìä Bericht</button>
      </div>
    </div>
  </div>

  <div id="settings-modal" class="fixed inset-0 bg-white z-[4000] hidden p-6 overflow-y-auto">
    <div class="max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-8">
        <h2 class="text-3xl font-bold">Einstellungen</h2>
        <button onclick="window.updateAppView('kasse')" class="bg-gray-100 px-6 py-2 rounded-xl font-bold">Schlie√üen</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-gray-50 p-6 rounded-3xl">
          <h3 class="font-bold mb-4">Neues Produkt</h3>
          <input type="text" id="new-prod-name" placeholder="Name" class="w-full p-4 mb-2 border rounded-xl">
          <input type="number" id="new-prod-price" placeholder="Preis (z.B. 1.50)" class="w-full p-4 mb-4 border rounded-xl">
          <button onclick="window.addNewProduct()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">Speichern</button>
        </div>
        <div id="settings-product-list" class="space-y-2">
          </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, query, orderBy, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
      authDomain: "kassensystem-85412.firebaseapp.com",
      projectId: "kassensystem-85412",
      storageBucket: "kassensystem-85412.appspot.com",
      messagingSenderId: "367332219717",
      appId: "1:367332219717:web:867a5c76046e7f91c9fdb8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let cart = [];
    let currentInput = "";

    // PRODUKTE LADEN
    function loadProducts() {
      if(!currentUser) return;
      const q = query(collection(db, `users/${currentUser.uid}/products`), orderBy("name"));
      onSnapshot(q, (snapshot) => {
        const grid = document.getElementById('product-container');
        const setList = document.getElementById('settings-product-list');
        grid.innerHTML = "";
        setList.innerHTML = "";
        snapshot.forEach(docSnap => {
          const p = { id: docSnap.id, ...docSnap.data() };
          // Kachel f√ºr Kasse
          const btn = document.createElement('button');
          btn.className = "product-btn p-6 bg-white border rounded-2xl shadow-sm text-left";
          btn.innerHTML = `<div class="font-bold">${p.name}</div><div class="text-red-600 font-black">${p.price.toFixed(2)} ‚Ç¨</div>`;
          btn.onclick = () => window.addToCart(p);
          grid.appendChild(btn);

          // Liste f√ºr Einstellungen
          const li = document.createElement('div');
          li.className = "flex justify-between p-4 bg-white border rounded-xl";
          li.innerHTML = `<span>${p.name}</span> <button onclick="window.deleteProduct('${p.id}')" class="text-red-500 font-bold">L√∂schen</button>`;
          setList.appendChild(li);
        });
      });
    }

    // PRODUKT HINZUF√úGEN
    window.addNewProduct = async () => {
      const name = document.getElementById('new-prod-name').value;
      const price = parseFloat(document.getElementById('new-prod-price').value);
      if(name && price) {
        await addDoc(collection(db, `users/${currentUser.uid}/products`), { name, price });
        document.getElementById('new-prod-name').value = "";
        document.getElementById('new-prod-price').value = "";
      }
    };

    window.deleteProduct = async (id) => {
      await deleteDoc(doc(db, `users/${currentUser.uid}/products`, id));
    };

    // WARENKORB
    window.addToCart = (p) => {
      const qty = parseInt(currentInput) || 1;
      const exist = cart.find(i => i.id === p.id);
      if(exist) exist.amount += qty;
      else cart.push({...p, amount: qty});
      currentInput = "";
      renderCart();
    };

    function renderCart() {
      const container = document.getElementById('receipt-content-interactive');
      document.getElementById('qty-display').innerText = currentInput || "1";
      let total = 0;
      container.innerHTML = cart.map(item => {
        total += item.price * item.amount;
        return `<div class="flex justify-between p-2 bg-gray-50 rounded-lg"><span>${item.amount}x ${item.name}</span><b>${(item.price * item.amount).toFixed(2)} ‚Ç¨</b></div>`;
      }).join('');
      document.getElementById('grand-total').innerText = total.toFixed(2) + " ‚Ç¨";
    }

    window.handleQuantityInput = (val) => {
      if(val === 'clear') currentInput = "";
      else currentInput += val;
      renderCart();
    };

    // AUTH WECHSEL
    onAuthStateChanged(auth, (user) => {
      if(user) {
        currentUser = user;
        window.updateAppView('kasse');
        loadProducts();
      } else {
        window.updateAppView('login');
      }
    });

    window.updateAppView = (view) => {
      ['login-modal', 'register-modal', 'kasse-content', 'settings-modal'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.add('hidden');
      });
      const target = document.getElementById(view + (view === 'kasse' ? '-content' : '-modal'));
      if(target) target.classList.remove('hidden');
    };

    window.clearCart = () => { cart = []; renderCart(); };

    // LOGIN / REGISTER SUBMIT
    document.getElementById('login-form').onsubmit = async (e) => {
      e.preventDefault();
      await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value);
    };

    document.getElementById('register-form').onsubmit = async (e) => {
      e.preventDefault();
      const userCred = await createUserWithEmailAndPassword(auth, document.getElementById('reg-email').value, document.getElementById('reg-password').value);
      await setDoc(doc(db, "users", userCred.user.uid, "settings", "general"), { 
        systemType: document.getElementById('reg-system-type').value 
      });
    };

  </script>
</body>
</html>
